
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Greybox Fuzzing &#8212; The Fuzzing Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=42e1b1a5" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'GreyboxFuzzer';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Search-Based Fuzzing" href="SearchBasedFuzzer.html" />
    <link rel="prev" title="Mutation-Based Fuzzing" href="MutationFuzzer.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of fuzzingbook.org, currently in development. See the <a href="https://fuzzingbook.org/"  style="color:white!important;">classic site</a> for resources.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/fuzzingbook.png" class="logo__image only-light" alt="The Fuzzing Book - Home"/>
    <script>document.write(`<img src="_static/fuzzingbook.png" class="logo__image only-dark" alt="The Fuzzing Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Fuzzing Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Tours through the Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Testing.html">Introduction to Software Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lexical Fuzzing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fuzzer.html">Fuzzing: Breaking Things with¬†Random¬†Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationFuzzer.html">Mutation-Based Fuzzing</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Greybox Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SearchBasedFuzzer.html">Search-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationAnalysis.html">Mutation Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Syntactical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Grammars.html">Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarFuzzer.html">Efficient Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarCoverageFuzzer.html">Grammar Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">Parsing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProbabilisticGrammarFuzzer.html">Probabilistic Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GeneratorGrammarFuzzer.html">Fuzzing with Generators</a></li>

<li class="toctree-l1"><a class="reference internal" href="GreyboxGrammarFuzzer.html">Greybox Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reducer.html">Reducing Failure-Inducing Inputs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semantical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingWithConstraints.html">Fuzzing with Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarMiner.html">Mining Input Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="InformationFlow.html">Tracking Information Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConcolicFuzzer.html">Concolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SymbolicFuzzer.html">Symbolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Domain-Specific Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ConfigurationFuzzer.html">Testing Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIFuzzer.html">Fuzzing APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Carver.html">Carving Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="PythonFuzzer.html">Testing Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebFuzzer.html">Testing Web Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="GUIFuzzer.html">Testing Graphical User Interfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Managing Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingInTheLarge.html">Fuzzing in the Large</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhenToStopFuzzing.html">When To Stop Fuzzing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AcademicPrototyping.html">Academic Prototyping</a></li>
<li class="toctree-l1"><a class="reference internal" href="PrototypingWithPython.html">Prototyping with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="RailroadDiagrams.html">Railroad Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="ControlFlow.html">Control Flow Graph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Fuzzingbook Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Using Fuzzingbook Code in your own Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/master?urlpath=tree/docs/notebooks/GreyboxFuzzer.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook/issues/new?title=Issue%20on%20page%20%2FGreyboxFuzzer.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/GreyboxFuzzer.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Greybox Fuzzing</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#afl-an-effective-greybox-fuzzer">AFL: An Effective Greybox Fuzzer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ingredients-for-greybox-fuzzing">Ingredients for Greybox Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mutators">Mutators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seeds-and-power-schedules">Seeds and Power Schedules</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#runners-and-a-sample-program">Runners and a Sample Program</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-blackbox-mutation-based-fuzzing">Advanced Blackbox Mutation-based Fuzzing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#greybox-mutation-based-fuzzing">Greybox Mutation-based Fuzzing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#boosted-greybox-fuzzing">Boosted Greybox Fuzzing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-complex-example-htmlparser">A Complex Example: HTMLParser</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#directed-greybox-fuzzing">Directed Greybox Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-the-maze">Solving the Maze</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-first-attempt">A First Attempt</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-function-level-distance">Computing Function-Level Distance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#directed-power-schedule">Directed Power Schedule</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#improved-directed-power-schedule">Improved Directed Power Schedule</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compatibility">Compatibility</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="greybox-fuzzing">
<h1>Greybox Fuzzing<a class="headerlink" href="#greybox-fuzzing" title="Link to this heading">#</a></h1>
<p>In the <a class="reference internal" href="MutationFuzzer.html"><span class="std std-doc">previous chapter</span></a>, we have introduced <em>mutation-based fuzzing</em>, a technique that generates fuzz inputs by applying small mutations to given inputs. In this chapter, we show how to <em>guide</em> these mutations towards specific goals such as coverage. The algorithms in this chapter stem from the popular <a class="reference external" href="http://lcamtuf.coredump.cx/afl/">American Fuzzy Lop</a> (AFL) fuzzer, in particular from its <a class="reference external" href="https://github.com/mboehme/aflfast">AFLFast</a> and <a class="reference external" href="https://github.com/aflgo/aflgo">AFLGo</a> flavors. We will explore the greybox fuzzing algorithm behind AFL and how we can exploit it to solve various problems for automated vulnerability detection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bookutils</span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;vBrNT9q2t1Y&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/vBrNT9q2t1Y"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>Reading the introduction on <a class="reference internal" href="MutationFuzzer.html"><span class="std std-doc">mutation-based fuzzing</span></a> is recommended.</p></li>
</ul>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<!-- Automatically generated. Do not edit. -->
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fuzzingbook.GreyboxFuzzer</span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p>This chapter introduces advanced methods for grey-box fuzzing inspired by the popular AFL fuzzer. The <code class="docutils literal notranslate"><span class="pre">GreyboxFuzzer</span></code> class has three arguments. First, a list of seed inputs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">seed_input</span> <span class="o">=</span> <span class="s2">&quot;http://www.google.com/search?q=fuzzing&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">seeds</span> <span class="o">=</span> <span class="p">[</span><span class="n">seed_input</span><span class="p">]</span>
</pre></div>
</div>
<p>Second, a <em>mutator</em> that changes individual parts of the input.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mutator</span> <span class="o">=</span> <span class="n">Mutator</span><span class="p">()</span>
</pre></div>
</div>
<p>Third, a <em>power schedule</em> that assigns fuzzing effort across the population:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">schedule</span> <span class="o">=</span> <span class="n">PowerSchedule</span><span class="p">()</span>
</pre></div>
</div>
<p>These three go into the <code class="docutils literal notranslate"><span class="pre">GreyboxFuzzer</span></code> constructor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">greybox_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxFuzzer</span><span class="p">(</span><span class="n">seeds</span><span class="o">=</span><span class="n">seeds</span><span class="p">,</span> <span class="n">mutator</span><span class="o">=</span><span class="n">mutator</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">schedule</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">GreyboxFuzzer</span></code> class is used in conjunction with a <code class="docutils literal notranslate"><span class="pre">FunctionCoverageRunner</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">http_runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">http_program</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">outcomes</span> <span class="o">=</span> <span class="n">greybox_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">http_runner</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
<p>After fuzzing, we can inspect the population:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">greybox_fuzzer</span><span class="o">.</span><span class="n">population</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>
<span class="go">[http://www.google.com/search?q=fuzzing,</span>
<span class="go"> http://ww.gomgle.com/searciq=fuzzing,</span>
<span class="go"> |h&gt;Att&amp;p8?wwnOgle.cooarhl~Cp`uzza&#39;,</span>
<span class="go"> http2Ot/*gv-VRgogec:om/rearc h=fu~i</span>
<span class="go"> g,</span>
<span class="go"> http&quot;Ot/*gv-VRgogecom/rearc h=u~i</span>
<span class="go"> f,</span>
<span class="go"> http&quot;Ot/g$vVRgogEecom/#reabc h=u~a</span>
<span class="go"> f,</span>
<span class="go"> httT`2Ot//:7ev^VRgoec:uom/re!6dctKc= hS;=fu-yH</span>
<span class="go"> /,</span>
<span class="go"> http&#39;www&amp;go/le.comm/sea:rh*?q=Ftzzifg,</span>
<span class="go"> h4tpw://w.gomMle.m/weazciq=fuezzi.&#39;,</span>
<span class="go"> h~Att&amp;p8?ws_nOge.#ooarhBlw~Cp`uzza&#39;,</span>
<span class="go"> ht8P:/wwvgkowcom/eacrh?q=f uzzing,</span>
<span class="go"> httT`Ot//:7evVR&quot;goec:uom/re!dctKc=hS;=fu-yH</span>
<span class="go"> I,</span>
<span class="go"> htp://ww.go/gl%.otm/wearch?q=f5zzing,</span>
<span class="go"> httU`Ot//:7evVR&quot;goec:uo2Jm/re#dctKc=hS;=fu-yH</span>
<span class="go"> I,</span>
<span class="go"> ht4p://ww.gomgle.co.serciq=fuzzing,</span>
<span class="go"> httpp&quot;OtSo*gv&#39;VRgkg;eom/earcR &gt;</span>
<span class="go"> =u|in</span>
<span class="go"> f,</span>
<span class="go"> htP:/wwvgMolwcomeachq=f uzzine,</span>
<span class="go"> htt://[/wwgwC6.]gogleg/lE.bo/_sEarcq9Afqwz&quot;king,</span>
<span class="go"> httT`Ot//:7evVR&quot;goec:uom/re!dctKc=hS;=fu-yH</span>
<span class="go"> I,</span>
<span class="go"> tPK:,wIfvglwvc#omeaBc`9qOin]</span>
</pre></div>
</div>
<p>Besides the simple <code class="docutils literal notranslate"><span class="pre">PowerSchedule</span></code>, we can have advanced power schedules.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AFLFastSchedule</span></code> assigns high energy to ‚Äúunusual‚Äù paths not taken very often.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AFLGoSchedule</span></code> assigns high energy to paths close to uncovered program locations.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">AFLGoSchedule</span></code> class constructor requires a <code class="docutils literal notranslate"><span class="pre">distance</span></code> metric from each node towards target locations, as determined via analysis of the program code. See the chapter for details.</p>
<p><img alt="" src="_images/GreyboxFuzzer-synopsis-1.svg" /></p>
</section>
<section id="afl-an-effective-greybox-fuzzer">
<h2>AFL: An Effective Greybox Fuzzer<a class="headerlink" href="#afl-an-effective-greybox-fuzzer" title="Link to this heading">#</a></h2>
<p>The algorithms in this chapter stem from the popular <a class="reference external" href="http://lcamtuf.coredump.cx/afl/">American Fuzzy Lop</a> (AFL) fuzzer.</p>
<p>AFL is a <em>mutation-based fuzzer</em>. Meaning, AFL generates new inputs by slightly modifying a seed input (i.e., mutation), or by joining the first half of one input with the second half of another (i.e., splicing).</p>
<p>AFL is also a <em>greybox fuzzer</em> (not blackbox nor whitebox). Meaning, AFL leverages coverage-feedback to learn how to reach deeper into the program. It is not entirely blackbox because AFL leverages at least <em>some</em> program analysis. It is not entirely whitebox either because AFL does not build on heavyweight program analysis or constraint solving. Instead, AFL uses lightweight program instrumentation to glean some information about the (branch) coverage of a generated input.
If a generated input increases coverage, it is added to the seed corpus for further fuzzing.</p>
<p>To instrument a program, AFL injects a piece of code right after every conditional jump instruction. When executed, this so-called trampoline assigns the exercised branch a unique identifier and increments a counter that is associated with this branch. For efficiency, only a coarse branch hit count is maintained. In other words, for each input the fuzzer knows which branches and roughly how often they are exercised.
The instrumentation is usually done at compile-time, i.e., when the program source code is compiled to an executable binary. However, it is possible to run AFL on non-instrumented binaries using tools such as a virtual machine (e.g., <a class="reference external" href="https://github.com/mirrorer/afl/blob/master/qemu_mode">QEMU</a>) or a dynamic instrumentation tool (e.g., <a class="reference external" href="https://github.com/vanhauser-thc/afl-pin">Intel PinTool</a>). For Python programs, we can collect coverage information without any instrumentation (see chapter on <a class="reference internal" href="Coverage.html#Coverage-of-Basic-Fuzzing"><span class="std std-ref">collecting coverage</span></a>).</p>
</section>
<section id="ingredients-for-greybox-fuzzing">
<h2>Ingredients for Greybox Fuzzing<a class="headerlink" href="#ingredients-for-greybox-fuzzing" title="Link to this heading">#</a></h2>
<p>We start with discussing the most important parts we need for mutational testing and goal guidance.</p>
<section id="mutators">
<h3>Mutators<a class="headerlink" href="#mutators" title="Link to this heading">#</a></h3>
<p>We introduce specific classes for mutating a seed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sequence</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Coverage</span> <span class="kn">import</span> <span class="n">population_coverage</span>
</pre></div>
</div>
</div>
</div>
<p>First, we‚Äôll introduce the <code class="docutils literal notranslate"><span class="pre">Mutator</span></code> class. Given a seed input <code class="docutils literal notranslate"><span class="pre">inp</span></code>, the mutator returns a slightly modified version of <code class="docutils literal notranslate"><span class="pre">inp</span></code>.  In the <a class="reference internal" href="GreyboxGrammarFuzzer.html"><span class="std std-doc">chapter on greybox grammar fuzzing</span></a>, we extend this class to consider the input grammar for smart greybox fuzzing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mutator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mutate strings&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutators</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_random_character</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_random_character</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flip_random_character</span>
        <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>For insertion, we add a random character in a random position.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mutator</span><span class="p">(</span><span class="n">Mutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">insert_random_character</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns s with a random character inserted&quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="n">random_character</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">127</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">random_character</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>For deletion, if the string is non-empty choose a random position and delete the character. Otherwise, use the insertion-operation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mutator</span><span class="p">(</span><span class="n">Mutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">delete_random_character</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns s with a random character deleted&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_random_character</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>For substitution, if the string is non-empty choose a random position and flip a random bit in the character. Otherwise, use the insertion-operation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mutator</span><span class="p">(</span><span class="n">Mutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">flip_random_character</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns s with a random bit flipped in a random position&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_random_character</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">new_c</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">^</span> <span class="n">bit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_c</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>The main method is <code class="docutils literal notranslate"><span class="pre">mutate</span></code> which chooses a random mutation operator from the list of operators.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Mutator</span><span class="p">(</span><span class="n">Mutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">mutate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>  <span class="c1"># can be str or Seed (see below)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return s with a random mutation applied. Can be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="n">mutator</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mutators</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mutator</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let‚Äôs try the mutator. You can actually interact with such a ‚Äúcell‚Äù and try other inputs by loading this chapter as Jupyter notebook. After opening, run all cells in the notebook using ‚ÄúKernel -&gt; Restart &amp; Run All‚Äù.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Mutator</span><span class="p">()</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="s2">&quot;good&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;cood&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="seeds-and-power-schedules">
<h3>Seeds and Power Schedules<a class="headerlink" href="#seeds-and-power-schedules" title="Link to this heading">#</a></h3>
<p>Now we introduce a new concept; the <em>power schedule</em>. A power schedule distributes the precious fuzzing time among the seeds in the population. Our objective is to maximize the time spent fuzzing those (most progressive) seeds which lead to higher coverage increase in shorter time.</p>
<p>We call the likelihood with which a seed is chosen from the population as the seed‚Äôs <em>energy</em>. Throughout a fuzzing campaign, we would like to prioritize seeds that are more promising. Simply said, we do not want to waste energy fuzzing non-progressive seeds. We call the procedure that decides a seed‚Äôs energy as the fuzzer‚Äôs <em>power schedule</em>. For instance, AFL‚Äôs schedule assigns more energy to seeds that are shorter, that execute faster, and yield coverage increases more often.</p>
<p>First, there is some information that we need to attach to each seed in addition to the seed‚Äôs data. Hence, we define the following <code class="docutils literal notranslate"><span class="pre">Seed</span></code> class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Coverage</span> <span class="kn">import</span> <span class="n">Location</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Seed</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represent an input with additional attributes&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize from seed data&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># These will be needed for advanced power schedules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Location</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns data as string representation of the seed&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

    <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>
</pre></div>
</div>
</div>
</div>
<p>The power schedule that is implemented below assigns each seed the same energy. Once a seed is in the population, it will be fuzzed as often as any other seed in the population.</p>
<p>In Python, we can squeeze long for-loops into much smaller statements.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">...</span></code> returns a function that takes <code class="docutils literal notranslate"><span class="pre">x</span></code> as input. Lambda allows for quick definitions unnamed functions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">map(f,</span> <span class="pre">l)</span></code> returns a list where the function <code class="docutils literal notranslate"><span class="pre">f</span></code> is applied to each element in list <code class="docutils literal notranslate"><span class="pre">l</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">random.choices(l,</span> <span class="pre">weights)[0]</span></code> returns element <code class="docutils literal notranslate"><span class="pre">l[i]</span></code> with probability in <code class="docutils literal notranslate"><span class="pre">weights[i]</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PowerSchedule</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define how fuzzing time should be distributed across the population.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_frequency</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">assignEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Seed</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assigns each seed the same energy&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">population</span><span class="p">:</span>
            <span class="n">seed</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">normalizedEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Seed</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize energy&quot;&quot;&quot;</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">seed</span><span class="p">:</span> <span class="n">seed</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">population</span><span class="p">))</span>
        <span class="n">sum_energy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>  <span class="c1"># Add up all values in energy</span>
        <span class="k">assert</span> <span class="n">sum_energy</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">norm_energy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">nrg</span><span class="p">:</span> <span class="n">nrg</span> <span class="o">/</span> <span class="n">sum_energy</span><span class="p">,</span> <span class="n">energy</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">norm_energy</span>

    <span class="k">def</span> <span class="nf">choose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Seed</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Seed</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Choose weighted by normalized energy.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assignEnergy</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>
        <span class="n">norm_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizedEnergy</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>
        <span class="n">seed</span><span class="p">:</span> <span class="n">Seed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">norm_energy</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">seed</span>
</pre></div>
</div>
</div>
</div>
<p>Let‚Äôs see whether this power schedule chooses seeds uniformly at random. We ask the schedule 10k times to choose a seed from the population of three seeds (A, B, C) and keep track of the number of times we have seen each seed. We should see each seed about 3.3k times.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">population</span> <span class="o">=</span> <span class="p">[</span><span class="n">Seed</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">),</span> <span class="n">Seed</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">),</span> <span class="n">Seed</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)]</span>
<span class="n">schedule</span> <span class="o">=</span> <span class="n">PowerSchedule</span><span class="p">()</span>
<span class="n">hits</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>
    <span class="n">hits</span><span class="p">[</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hits</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;A&#39;: 3387, &#39;B&#39;: 3255, &#39;C&#39;: 3358}
</pre></div>
</div>
</div>
</div>
<p>Looks good. Every seed has been chosen about a third of the time.</p>
</section>
<section id="runners-and-a-sample-program">
<h3>Runners and a Sample Program<a class="headerlink" href="#runners-and-a-sample-program" title="Link to this heading">#</a></h3>
<p>We‚Äôll start with a small sample program of six lines. In order to collect coverage information during execution, we import the <code class="docutils literal notranslate"><span class="pre">FunctionCoverageRunner</span></code> class from the chapter on <a class="reference internal" href="MutationFuzzer.html#Guiding-by-Coverage"><span class="std std-ref">mutation-based fuzzing</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">FunctionCoverageRunner</span></code> constructor takes a Python <code class="docutils literal notranslate"><span class="pre">function</span></code> to execute. The function <code class="docutils literal notranslate"><span class="pre">run</span></code> takes an input, passes it on to the Python <code class="docutils literal notranslate"><span class="pre">function</span></code>, and collects the coverage information for this execution. The function <code class="docutils literal notranslate"><span class="pre">coverage()</span></code> returns a list of tuples <code class="docutils literal notranslate"><span class="pre">(function</span> <span class="pre">name,</span> <span class="pre">line</span> <span class="pre">number)</span></code> for each statement that has been covered in the Python <code class="docutils literal notranslate"><span class="pre">function</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">MutationFuzzer</span> <span class="kn">import</span> <span class="n">FunctionCoverageRunner</span><span class="p">,</span> <span class="n">http_program</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">crashme()</span></code> function raises an exception for the input ‚Äúbad!‚Äù. Let‚Äôs see which statements are covered for the input ‚Äúgood‚Äù.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">crashme</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;!&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crashme_runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">crashme</span><span class="p">)</span>
<span class="n">crashme_runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;good&quot;</span><span class="p">)</span>
<span class="nb">list</span><span class="p">(</span><span class="n">crashme_runner</span><span class="o">.</span><span class="n">coverage</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;run_function&#39;, 132), (&#39;crashme&#39;, 2)]
</pre></div>
</div>
</div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">crashme</span></code>, the input ‚Äúgood‚Äù only covers the if-statement in line 2. The branch condition <code class="docutils literal notranslate"><span class="pre">len(s)</span> <span class="pre">&gt;</span> <span class="pre">0</span> <span class="pre">and</span> <span class="pre">s[0]</span> <span class="pre">==</span> <span class="pre">'b'</span></code> evaluates to False.</p>
</section>
</section>
<section id="advanced-blackbox-mutation-based-fuzzing">
<h2>Advanced Blackbox Mutation-based Fuzzing<a class="headerlink" href="#advanced-blackbox-mutation-based-fuzzing" title="Link to this heading">#</a></h2>
<p>Let‚Äôs integrate both the mutator and power schedule into a fuzzer. We‚Äôll start with a blackbox fuzzer ‚Äì which does <em>not</em> leverage any coverage information.</p>
<p>Our <code class="docutils literal notranslate"><span class="pre">AdvancedMutationFuzzer</span></code> class is an advanced and <em>parameterized</em> version of the <code class="docutils literal notranslate"><span class="pre">MutationFuzzer</span></code> class from the <a class="reference internal" href="MutationFuzzer.html"><span class="std std-doc">chapter on mutation-based fuzzing</span></a>. It also inherits from the <a class="reference internal" href="Fuzzer.html#Fuzzer-Classes"><span class="std std-ref">Fuzzer</span></a> class. For now, we only need to know the functions <code class="docutils literal notranslate"><span class="pre">fuzz()</span></code> which returns a generated input and <code class="docutils literal notranslate"><span class="pre">runs()</span></code> which executes <code class="docutils literal notranslate"><span class="pre">fuzz()</span></code> a specified number of times. For our <code class="docutils literal notranslate"><span class="pre">AdvancedMutationFuzzer</span></code> class, we override the function <code class="docutils literal notranslate"><span class="pre">fuzz()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Fuzzer</span> <span class="kn">import</span> <span class="n">Fuzzer</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">AdvancedMutationFuzzer</span></code> is constructed with a set of initial seeds, a mutator, and a power schedule. Throughout the fuzzing campaign, it maintains a seed corpus called <code class="docutils literal notranslate"><span class="pre">population</span></code>. The function <code class="docutils literal notranslate"><span class="pre">fuzz</span></code> returns either an unfuzzed seed from the initial seeds, or the result of fuzzing a seed in the population. The function <code class="docutils literal notranslate"><span class="pre">create_candidate</span></code> handles the latter. It randomly chooses an input from the population and applies a number of mutations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AdvancedMutationFuzzer</span><span class="p">(</span><span class="n">Fuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for mutation-based fuzzing.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seeds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                 <span class="n">mutator</span><span class="p">:</span> <span class="n">Mutator</span><span class="p">,</span>
                 <span class="n">schedule</span><span class="p">:</span> <span class="n">PowerSchedule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `seeds` - a list of (input) strings to mutate.</span>
<span class="sd">        `mutator` - the mutator to apply.</span>
<span class="sd">        `schedule` - the power schedule to apply.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seeds</span> <span class="o">=</span> <span class="n">seeds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutator</span> <span class="o">=</span> <span class="n">mutator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="n">schedule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the initial population and seed index&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Seed</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">create_candidate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an input generated by fuzzing a seed in the population&quot;&quot;&quot;</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>

        <span class="c1"># Stacking: Apply multiple mutations to generate the candidate</span>
        <span class="n">candidate</span> <span class="o">=</span> <span class="n">seed</span><span class="o">.</span><span class="n">data</span>
        <span class="n">trials</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">candidate</span>

    <span class="k">def</span> <span class="nf">fuzz</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns first each seed once and then generates new inputs&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">):</span>
            <span class="c1"># Still seeding</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seeds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">seed_index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Mutating</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_candidate</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inp</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inp</span>
</pre></div>
</div>
</div>
</div>
<p>Okay, let‚Äôs take the mutation fuzzer for a spin. Given a single seed, we ask it to generate three inputs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed_input</span> <span class="o">=</span> <span class="s2">&quot;good&quot;</span>
<span class="n">mutation_fuzzer</span> <span class="o">=</span> <span class="n">AdvancedMutationFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">Mutator</span><span class="p">(),</span> <span class="n">PowerSchedule</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mutation_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mutation_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mutation_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>good
gDoodC
/
</pre></div>
</div>
</div>
</div>
<p>Let‚Äôs see how many statements the mutation-based blackbox fuzzer covers in a campaign with n=30k inputs.</p>
<p>The fuzzer function <code class="docutils literal notranslate"><span class="pre">runs(crashme_runner,</span> <span class="pre">trials=n)</span></code> generates <code class="docutils literal notranslate"><span class="pre">n</span></code> inputs and executes them on the <code class="docutils literal notranslate"><span class="pre">crashme</span></code> function via the <code class="docutils literal notranslate"><span class="pre">crashme_runner</span></code>. As stated earlier, the <code class="docutils literal notranslate"><span class="pre">crashme_runner</span></code> also collects coverage information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">30000</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">blackbox_fuzzer</span> <span class="o">=</span> <span class="n">AdvancedMutationFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">Mutator</span><span class="p">(),</span> <span class="n">PowerSchedule</span><span class="p">())</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">blackbox_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">crashme</span><span class="p">),</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took the blackbox mutation-based fuzzer </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took the blackbox mutation-based fuzzer 4.21 seconds to generate and execute 30000 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<p>In order to measure coverage, we import the <a class="reference internal" href="Coverage.html#Coverage-of-Basic-Fuzzing"><span class="std std-ref">population_coverage</span></a> function. It takes a set of inputs and a Python function, executes the inputs on that function and collects coverage information. Specifically, it returns a tuple <code class="docutils literal notranslate"><span class="pre">(all_coverage,</span> <span class="pre">cumulative_coverage)</span></code> where <code class="docutils literal notranslate"><span class="pre">all_coverage</span></code> is the set of statements covered by all inputs, and <code class="docutils literal notranslate"><span class="pre">cumulative_coverage</span></code> is the number of statements covered as the number of executed inputs increases. We are just interested in the latter to plot coverage over time.</p>
<p>We extract the generated inputs from the blackbox fuzzer and measure coverage as the number of inputs increases.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">blackbox_coverage</span> <span class="o">=</span> <span class="n">population_coverage</span><span class="p">(</span><span class="n">blackbox_fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">crashme</span><span class="p">)</span>
<span class="n">bb_max_coverage</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">blackbox_coverage</span><span class="p">)</span>

<span class="s2">&quot;The blackbox mutation-based fuzzer achieved a maximum coverage of </span><span class="si">%d</span><span class="s2"> statements.&quot;</span> <span class="o">%</span> <span class="n">bb_max_coverage</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The blackbox mutation-based fuzzer achieved a maximum coverage of 2 statements.&#39;
</pre></div>
</div>
</div>
</div>
<p>The following generated inputs increased the coverage for our <code class="docutils literal notranslate"><span class="pre">crashme</span></code> <a class="reference internal" href="#Runner-and-Sample-Program"><span class="xref myst">example</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">seed_input</span><span class="p">]</span> <span class="o">+</span> \
    <span class="p">[</span>
        <span class="n">blackbox_fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blackbox_coverage</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">blackbox_coverage</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">blackbox_coverage</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;good&#39;, &#39;bo&#39;]
</pre></div>
</div>
</div>
</div>
<p><em><strong>Summary</strong></em>. This is how a blackbox mutation-based fuzzer works. We have integrated the <em>mutator</em> to generate inputs by fuzzing a provided set of initial seeds and the <em>power schedule</em> to decide which seed to choose next.</p>
</section>
<section id="greybox-mutation-based-fuzzing">
<h2>Greybox Mutation-based Fuzzing<a class="headerlink" href="#greybox-mutation-based-fuzzing" title="Link to this heading">#</a></h2>
<p>In contrast to a blackbox fuzzer, a greybox fuzzer like <a class="reference external" href="http://lcamtuf.coredump.cx/afl/">AFL</a> <em>does</em> leverage coverage information. Specifically, a greybox fuzzer adds to the seed population generated inputs which increase code coverage.</p>
<p>The method <code class="docutils literal notranslate"><span class="pre">run()</span></code> is inherited from the <a class="reference internal" href="Fuzzer.html#Fuzzer-Classes"><span class="std std-ref">Fuzzer</span></a> class. It is called to generate and execute exactly one input. We override this function to add an input to the <code class="docutils literal notranslate"><span class="pre">population</span></code> that increases coverage. The greybox fuzzer attribute <code class="docutils literal notranslate"><span class="pre">coverages_seen</span></code> maintains the set of statements, that have previously been covered.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GreyboxFuzzer</span><span class="p">(</span><span class="n">AdvancedMutationFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Coverage-guided mutational fuzzing.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the initial population, seed index, coverage information&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coverages_seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># population is filled during greybox fuzzing</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">:</span> <span class="n">FunctionCoverageRunner</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>  <span class="c1"># type: ignore</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run function(inp) while tracking coverage.</span>
<span class="sd">           If we reach new coverage,</span>
<span class="sd">           add inp to population and its coverage to population_coverage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">outcome</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>
        <span class="n">new_coverage</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">coverage</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">new_coverage</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coverages_seen</span><span class="p">:</span>
            <span class="c1"># We have new coverage</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="n">Seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inp</span><span class="p">)</span>
            <span class="n">seed</span><span class="o">.</span><span class="n">coverage</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coverages_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_coverage</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">outcome</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let‚Äôs take our greybox fuzzer for a spin.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed_input</span> <span class="o">=</span> <span class="s2">&quot;good&quot;</span>
<span class="n">greybox_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">Mutator</span><span class="p">(),</span> <span class="n">PowerSchedule</span><span class="p">())</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">greybox_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">crashme</span><span class="p">),</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took the greybox mutation-based fuzzer </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took the greybox mutation-based fuzzer 4.23 seconds to generate and execute 30000 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<p>Does the greybox fuzzer cover more statements after generating the same number of test inputs?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">greybox_coverage</span> <span class="o">=</span> <span class="n">population_coverage</span><span class="p">(</span><span class="n">greybox_fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">crashme</span><span class="p">)</span>
<span class="n">gb_max_coverage</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">greybox_coverage</span><span class="p">)</span>

<span class="s2">&quot;Our greybox mutation-based fuzzer covers </span><span class="si">%d</span><span class="s2"> more statements&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gb_max_coverage</span> <span class="o">-</span> <span class="n">bb_max_coverage</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Our greybox mutation-based fuzzer covers 2 more statements&#39;
</pre></div>
</div>
</div>
</div>
<p>Our seed population for our <a class="reference internal" href="#Runner-and-Sample-Program"><span class="xref myst">example</span></a> now contains the following seeds.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">greybox_fuzzer</span><span class="o">.</span><span class="n">population</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[good, bo, baof, bad4u]
</pre></div>
</div>
</div>
</div>
<p>Coverage-feedback is indeed helpful. The new seeds are like bread crumbs or milestones that guide the fuzzer to progress more quickly into deeper code regions. Following is a simple plot showing the coverage achieved over time for both fuzzers on our simple <a class="reference internal" href="#Runner-and-Sample-Program"><span class="xref myst">example</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">line_bb</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">blackbox_coverage</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Blackbox&quot;</span><span class="p">)</span>
<span class="n">line_gb</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">greybox_coverage</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Greybox&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">line_bb</span><span class="p">,</span> <span class="n">line_gb</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Coverage over time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of inputs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;lines covered&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ef40e1013008a4f4094ab488b28f46b567574613086da4ef019b490a73490529.png" src="_images/ef40e1013008a4f4094ab488b28f46b567574613086da4ef019b490a73490529.png" />
</div>
</div>
<p><em><strong>Summary</strong></em>. We have seen how a greybox fuzzer ‚Äúdiscovers‚Äù interesting seeds that can lead to more progress. From the input <code class="docutils literal notranslate"><span class="pre">good</span></code>, our greybox fuzzer has slowly learned how to generate the input <code class="docutils literal notranslate"><span class="pre">bad!</span></code> which raises the exception. Now, how can we do that even faster?</p>
<p><em><strong>Try it</strong></em>. How much coverage would be achieved over time using a blackbox <em>generation-based</em> fuzzer? Try plotting the coverage for all three fuzzers. You can define the blackbox generation-based fuzzer as follows.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Fuzzer</span> <span class="kn">import</span> <span class="n">RandomFuzzer</span>
<span class="n">blackbox_gen_fuzzer</span> <span class="o">=</span> <span class="n">RandomFuzzer</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">char_start</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">char_range</span><span class="o">=</span><span class="mi">96</span><span class="p">)</span>
</pre></div>
</div>
<p>You can execute your own code by opening this chapter as Jupyter notebook.</p>
<p><em><strong>Read</strong></em>. This is the high-level view how AFL works, one of the most successful vulnerability detection tools. If you are interested in the technical details, have a look at: <a class="github reference external" href="https://github.com/mirrorer/afl/blob/master/docs/technical_details.txt">mirrorer/afl</a></p>
</section>
<section id="boosted-greybox-fuzzing">
<h2>Boosted Greybox Fuzzing<a class="headerlink" href="#boosted-greybox-fuzzing" title="Link to this heading">#</a></h2>
<p>Our boosted greybox fuzzer assigns more energy to seeds that promise to achieve more coverage. We change the power schedule such that seeds that exercise ‚Äúunusual‚Äù paths have more energy. With <em>unusual paths</em>, we mean paths that are not exercised very often by generated inputs.</p>
<p>In order to identify which path is exercised by an input, we leverage the function <code class="docutils literal notranslate"><span class="pre">getPathID</span></code> from the section on <a class="reference internal" href="#WhenIsEnough.ipynb#Trace-Coverage"><span class="xref myst">trace coverage</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>   <span class="c1"># serializes an object by producing a byte array from all the information in the object</span>
<span class="kn">import</span> <span class="nn">hashlib</span>  <span class="c1"># produces a 128-bit hash value from a byte array</span>
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">getPathID</span></code> returns a unique hash for a coverage set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getPathID</span><span class="p">(</span><span class="n">coverage</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a unique hash for the covered statements&quot;&quot;&quot;</span>
    <span class="n">pickled</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">coverage</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">pickled</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>There are several ways to assign energy based on how unusual the exercised path is. In this case, we implement an <em>exponential power schedule</em> which computes the energy <span class="math notranslate nohighlight">\(e(s)\)</span> for a seed <span class="math notranslate nohighlight">\(s\)</span> as follows
$<span class="math notranslate nohighlight">\(e(s) = \frac{1}{f(p(s))^a}\)</span>$
where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(p(s)\)</span> returns the ID of the path exercised by <span class="math notranslate nohighlight">\(s\)</span>,</p></li>
<li><p><span class="math notranslate nohighlight">\(f(p)\)</span> returns the number of times the path <span class="math notranslate nohighlight">\(p\)</span> is exercised by generated inputs, and</p></li>
<li><p><span class="math notranslate nohighlight">\(a\)</span> is a given exponent.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AFLFastSchedule</span><span class="p">(</span><span class="n">PowerSchedule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exponential power schedule as implemented in AFL&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exponent</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span> <span class="o">=</span> <span class="n">exponent</span>

    <span class="k">def</span> <span class="nf">assignEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Seed</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign exponential energy inversely proportional to path frequency&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">population</span><span class="p">:</span>
            <span class="n">seed</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_frequency</span><span class="p">[</span><span class="n">getPathID</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">coverage</span><span class="p">)]</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In the greybox fuzzer, let‚Äôs keep track of the number of times <span class="math notranslate nohighlight">\(f(p)\)</span> each path <span class="math notranslate nohighlight">\(p\)</span> is exercised, and update the power schedule.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CountingGreyboxFuzzer</span><span class="p">(</span><span class="n">GreyboxFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Count how often individual paths are exercised.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset path frequency&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">path_frequency</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">:</span> <span class="n">FunctionCoverageRunner</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>  <span class="c1"># type: ignore</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inform scheduler about path frequency&quot;&quot;&quot;</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">outcome</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>

        <span class="n">path_id</span> <span class="o">=</span> <span class="n">getPathID</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">coverage</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">path_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">path_frequency</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">path_frequency</span><span class="p">[</span><span class="n">path_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">path_frequency</span><span class="p">[</span><span class="n">path_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">outcome</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Okay, let‚Äôs run our boosted greybox fuzzer <span class="math notranslate nohighlight">\(n=10k\)</span> times on our simple <a class="reference internal" href="#Runner-and-Sample-Program"><span class="xref myst">example</span></a>. We set the exponentent of our exponential power schedule to <span class="math notranslate nohighlight">\(a=5\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">seed_input</span> <span class="o">=</span> <span class="s2">&quot;good&quot;</span>
<span class="n">fast_schedule</span> <span class="o">=</span> <span class="n">AFLFastSchedule</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">fast_fuzzer</span> <span class="o">=</span> <span class="n">CountingGreyboxFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">Mutator</span><span class="p">(),</span> <span class="n">fast_schedule</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">fast_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">crashme</span><span class="p">),</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took the fuzzer w/ exponential schedule </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took the fuzzer w/ exponential schedule 1.54 seconds to generate and execute 10000 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fast_schedule</span><span class="o">.</span><span class="n">path_frequency</span><span class="p">))</span>
<span class="n">y_axis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fast_schedule</span><span class="o">.</span><span class="n">path_frequency</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">y_axis</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="c1"># plt.yscale(&quot;log&quot;)</span>
<span class="c1"># plt.yticks([10,100,1000,10000])</span>
<span class="n">plt</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a94b758c09b9d91be84fd27ed318dd9999aca9d8f09b105343032279d2a5a23a.png" src="_images/a94b758c09b9d91be84fd27ed318dd9999aca9d8f09b105343032279d2a5a23a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;             path id &#39;p&#39;           : path frequency &#39;f(p)&#39;&quot;</span><span class="p">)</span>
<span class="n">fast_schedule</span><span class="o">.</span><span class="n">path_frequency</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>             path id &#39;p&#39;           : path frequency &#39;f(p)&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;e014b68ad4f3bc2daf207e2498d14cbf&#39;: 5615,
 &#39;0a1008773804033d8a4c0e3aba4b96a0&#39;: 2597,
 &#39;eae4df5b039511eac56625f47c337d24&#39;: 1098,
 &#39;b14f545c3b39716a455034d9a0c61b8c&#39;: 454,
 &#39;11529f85aaa30be08110f3076748e420&#39;: 235,
 &#39;669903139e4064f7f07bc8b200fd2d26&#39;: 1}
</pre></div>
</div>
</div>
</div>
<p>How does it compare to our greybox fuzzer with the classical power schedule?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed_input</span> <span class="o">=</span> <span class="s2">&quot;good&quot;</span>
<span class="n">orig_schedule</span> <span class="o">=</span> <span class="n">PowerSchedule</span><span class="p">()</span>
<span class="n">orig_fuzzer</span> <span class="o">=</span> <span class="n">CountingGreyboxFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">Mutator</span><span class="p">(),</span> <span class="n">orig_schedule</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">orig_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">crashme</span><span class="p">),</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took the fuzzer w/ original schedule </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took the fuzzer w/ original schedule 1.43 seconds to generate and execute 10000 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orig_schedule</span><span class="o">.</span><span class="n">path_frequency</span><span class="p">))</span>
<span class="n">y_axis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">orig_schedule</span><span class="o">.</span><span class="n">path_frequency</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">y_axis</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="c1"># plt.yscale(&quot;log&quot;)</span>
<span class="c1"># plt.yticks([10,100,1000,10000])</span>
<span class="n">plt</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f6b326d7013ee879b2fe7ee9a9d0f9ab64679a5a6af6b981df178aa045385bf1.png" src="_images/f6b326d7013ee879b2fe7ee9a9d0f9ab64679a5a6af6b981df178aa045385bf1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;             path id &#39;p&#39;           : path frequency &#39;f(p)&#39;&quot;</span><span class="p">)</span>
<span class="n">orig_schedule</span><span class="o">.</span><span class="n">path_frequency</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>             path id &#39;p&#39;           : path frequency &#39;f(p)&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;e014b68ad4f3bc2daf207e2498d14cbf&#39;: 6579,
 &#39;0a1008773804033d8a4c0e3aba4b96a0&#39;: 2381,
 &#39;eae4df5b039511eac56625f47c337d24&#39;: 737,
 &#39;b14f545c3b39716a455034d9a0c61b8c&#39;: 241,
 &#39;11529f85aaa30be08110f3076748e420&#39;: 62}
</pre></div>
</div>
</div>
</div>
<p>The exponential power schedule shaves some of the executions of the ‚Äúhigh-frequency path‚Äù off and adds them to the lower-frequency paths. The path executed least often is either not at all exercised using the traditional power schedule or it is exercised much less often.</p>
<p>Let‚Äôs have a look at the energy that is assigned to the discovered seeds.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">orig_energy</span> <span class="o">=</span> <span class="n">orig_schedule</span><span class="o">.</span><span class="n">normalizedEnergy</span><span class="p">(</span><span class="n">orig_fuzzer</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>

<span class="k">for</span> <span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">norm_energy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">orig_fuzzer</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="n">orig_energy</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;, </span><span class="si">%0.5f</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">getPathID</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">coverage</span><span class="p">),</span>  <span class="c1"># type: ignore</span>
                               <span class="n">norm_energy</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;e014b68ad4f3bc2daf207e2498d14cbf&#39;, 0.20000, &#39;good&#39;
&#39;0a1008773804033d8a4c0e3aba4b96a0&#39;, 0.20000, &#39;bgI/d&#39;
&#39;eae4df5b039511eac56625f47c337d24&#39;, 0.20000, &#39;baI/dt&#39;
&#39;b14f545c3b39716a455034d9a0c61b8c&#39;, 0.20000, &#39;badtuS&#39;
&#39;11529f85aaa30be08110f3076748e420&#39;, 0.20000, &#39;bad!`tuS&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fast_energy</span> <span class="o">=</span> <span class="n">fast_schedule</span><span class="o">.</span><span class="n">normalizedEnergy</span><span class="p">(</span><span class="n">fast_fuzzer</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>

<span class="k">for</span> <span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">norm_energy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fast_fuzzer</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="n">fast_energy</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;, </span><span class="si">%0.5f</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">getPathID</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">coverage</span><span class="p">),</span>  <span class="c1"># type: ignore</span>
                               <span class="n">norm_energy</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;e014b68ad4f3bc2daf207e2498d14cbf&#39;, 0.00000, &#39;good&#39;
&#39;0a1008773804033d8a4c0e3aba4b96a0&#39;, 0.00000, &#39;bnd&#39;
&#39;eae4df5b039511eac56625f47c337d24&#39;, 0.00000, &#39;ba.&#39;
&#39;b14f545c3b39716a455034d9a0c61b8c&#39;, 0.00000, &#39;bad.&#39;
&#39;11529f85aaa30be08110f3076748e420&#39;, 0.00000, &#39;bad!\\.&#39;
&#39;669903139e4064f7f07bc8b200fd2d26&#39;, 1.00000, &#39;bad!\\.&#39;
</pre></div>
</div>
</div>
</div>
<p>Exactly. Our new exponential power schedule assigns most energy to the seed exercising the lowest-frequency path.</p>
<p>Let‚Äôs compare them in terms of coverage achieved over time for our simple <a class="reference internal" href="#Runner-and-Sample-Program"><span class="xref myst">example</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">orig_coverage</span> <span class="o">=</span> <span class="n">population_coverage</span><span class="p">(</span><span class="n">orig_fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">crashme</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">fast_coverage</span> <span class="o">=</span> <span class="n">population_coverage</span><span class="p">(</span><span class="n">fast_fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">crashme</span><span class="p">)</span>
<span class="n">line_orig</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">orig_coverage</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Original Greybox Fuzzer&quot;</span><span class="p">)</span>
<span class="n">line_fast</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fast_coverage</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Boosted Greybox Fuzzer&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">line_orig</span><span class="p">,</span> <span class="n">line_fast</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Coverage over time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of inputs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;lines covered&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8bcc83108baf48e17248b5f5c90c92a952d4ea330e1915ec4177c5e9ee5c6ef7.png" src="_images/8bcc83108baf48e17248b5f5c90c92a952d4ea330e1915ec4177c5e9ee5c6ef7.png" />
</div>
</div>
<p>As expected, the boosted greybox fuzzer (with the exponential power schedule) achieves coverage much faster.</p>
<p><em><strong>Summary</strong></em>. By fuzzing seeds more often that exercise low-frequency paths, we can explore program paths in a much more efficient manner.</p>
<p><em><strong>Try it</strong></em>. You can try other exponents for the fast power schedule, or change the power schedule entirely. Note that a large exponent can lead to overflows and imprecisions in the floating point arithmetic producing unexpected results. You can execute your own code by opening this chapter as Jupyter notebook.</p>
<p><em><strong>Read</strong></em>. You can find out more about fuzzer boosting in the paper ‚Äú<a class="reference external" href="https://mboehme.github.io/paper/CCS16.pdf">Coverage-based Greybox Fuzzing as Markov Chain</a>‚Äù \cite{boehme2018greybox} and check out the implementation into AFL at [<a class="github reference external" href="http://github.com/mboehme/aflfast">mboehme/aflfast</a>].</p>
</section>
<section id="a-complex-example-htmlparser">
<h2>A Complex Example: HTMLParser<a class="headerlink" href="#a-complex-example-htmlparser" title="Link to this heading">#</a></h2>
<p>Let‚Äôs compare the three fuzzers on a more realistic example, the Python <a class="reference external" href="https://docs.python.org/3/library/html.parser.html">HTML parser</a>. We run all three fuzzers <span class="math notranslate nohighlight">\(n=5k\)</span> times on the HTMLParser, starting with the ‚Äúempty‚Äù seed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">html.parser</span> <span class="kn">import</span> <span class="n">HTMLParser</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create wrapper function</span>
<span class="k">def</span> <span class="nf">my_parser</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">HTMLParser</span><span class="p">()</span>  <span class="c1"># resets the HTMLParser object for every fuzz input</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">seed_input</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>  <span class="c1"># empty seed</span>
<span class="n">blackbox_fuzzer</span> <span class="o">=</span> <span class="n">AdvancedMutationFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">Mutator</span><span class="p">(),</span> <span class="n">PowerSchedule</span><span class="p">())</span>
<span class="n">greybox_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">Mutator</span><span class="p">(),</span> <span class="n">PowerSchedule</span><span class="p">())</span>
<span class="n">boosted_fuzzer</span> <span class="o">=</span> <span class="n">CountingGreyboxFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">Mutator</span><span class="p">(),</span> <span class="n">AFLFastSchedule</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">blackbox_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">),</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">greybox_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">),</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">boosted_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">),</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took all three fuzzers </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took all three fuzzers 11.23 seconds to generate and execute 5000 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<p>How do the fuzzers compare in terms of coverage over time?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">black_coverage</span> <span class="o">=</span> <span class="n">population_coverage</span><span class="p">(</span><span class="n">blackbox_fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">my_parser</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">grey_coverage</span> <span class="o">=</span> <span class="n">population_coverage</span><span class="p">(</span><span class="n">greybox_fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">my_parser</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">boost_coverage</span> <span class="o">=</span> <span class="n">population_coverage</span><span class="p">(</span><span class="n">boosted_fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">my_parser</span><span class="p">)</span>
<span class="n">line_black</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">black_coverage</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Blackbox Fuzzer&quot;</span><span class="p">)</span>
<span class="n">line_grey</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">grey_coverage</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Greybox Fuzzer&quot;</span><span class="p">)</span>
<span class="n">line_boost</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">boost_coverage</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Boosted Greybox Fuzzer&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">line_boost</span><span class="p">,</span> <span class="n">line_grey</span><span class="p">,</span> <span class="n">line_black</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Coverage over time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of inputs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;lines covered&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/274bdc4b02ef28a0c391a1e24a6e0deebcf820d22c238d6b209719f4038fc1c1.png" src="_images/274bdc4b02ef28a0c391a1e24a6e0deebcf820d22c238d6b209719f4038fc1c1.png" />
</div>
</div>
<p>Both greybox fuzzers clearly outperform the blackbox fuzzer. The reason is that the greybox fuzzer ‚Äúdiscovers‚Äù interesting inputs along the way. Let‚Äôs have a look at the last 10 inputs generated by the greybox versus blackbox fuzzer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">blackbox_fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;2 &#39;, &#39;&#39;, &#39;A &#39;, &#39;&#39;, &#39;`&#39;, &#39;!&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;(&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">greybox_fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;\x00&#39;,
 &#39;(0&lt;2q$V\x00&quot;jy}Kz&#39;,
 &#39;_NrGlffJ%\x14=&#39;,
 &#39;2&amp;8,gBa&#39;,
 &#39;&#39;,
 &#39;W_&amp;k\\&lt;C&lt;hoPqv&#39;,
 &#39;*&amp;\x05t4&lt;&amp;d@R%&#39;,
 &#39;0aO&lt;4\x06&#39;,
 &#39;i:&#39;,
 &#39;iFK&amp;&lt;/\x06&#39;]
</pre></div>
</div>
</div>
</div>
<p>The greybox fuzzer executes much more complicated inputs, many of which include special characters such as opening and closing brackets and chevrons (i.e., <code class="docutils literal notranslate"><span class="pre">&lt;,</span> <span class="pre">&gt;,</span> <span class="pre">[,</span> <span class="pre">]</span></code>). Yet, many important keywords, such as <code class="docutils literal notranslate"><span class="pre">&lt;html&gt;</span></code> are still missing.</p>
<p>To inform the fuzzer about these important keywords, we will need <a class="reference internal" href="Grammars.html"><span class="std std-doc">grammars</span></a>; in the section on <a class="reference internal" href="LangFuzzer.html"><span class="std std-doc">smart greybox fuzzing</span></a>, we combine them with the techniques above.</p>
<p><em><strong>Try it</strong></em>. You can re-run these experiments to understand the variance of fuzzing experiments. Sometimes, the fuzzer that we claim to be superior does not seem to outperform the inferior fuzzer. In order to do this, you just need to open this chapter as Jupyter notebook.</p>
</section>
<section id="directed-greybox-fuzzing">
<h2>Directed Greybox Fuzzing<a class="headerlink" href="#directed-greybox-fuzzing" title="Link to this heading">#</a></h2>
<p>Sometimes, you just want the fuzzer to reach some dangerous location in the source code. This could be a location where you expect a buffer overflow. Or you want to test a recent change in your code base. How do we direct the fuzzer towards these locations?</p>
<p>In this chapter, we introduce directed greybox fuzzing as an optimization problem.</p>
<section id="solving-the-maze">
<h3>Solving the Maze<a class="headerlink" href="#solving-the-maze" title="Link to this heading">#</a></h3>
<p>To provide a meaningful example where you can easily change the code complexity and target location, we generate the maze source code from the maze provided as string. This example is loosely based on an old <a class="reference external" href="https://feliam.wordpress.com/2010/10/07/the-symbolic-maze/">blog post</a> on symbolic execution by Felipe Andres Manzano (Quick shout-out!).</p>
<p>You simply specify the maze as a string. Like so.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">maze_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">+-+-----+</span>
<span class="s2">|X|     |</span>
<span class="s2">| | --+ |</span>
<span class="s2">| |   | |</span>
<span class="s2">| +-- | |</span>
<span class="s2">|     |#|</span>
<span class="s2">+-----+-+</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>The code is generated using the function <code class="docutils literal notranslate"><span class="pre">generate_maze_code()</span></code>. We‚Äôll hide the implementation and instead explain what it does. If you are interested in the coding, go <a class="reference internal" href="ControlFlow.html#Example:-Maze"><span class="std std-ref">here</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ControlFlow</span> <span class="kn">import</span> <span class="n">generate_maze_code</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="k">def</span> <span class="nf">maze</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Will be overwritten by exec()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="k">def</span> <span class="nf">target_tile</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span>  <span class="c1"># Will be overwritten by exec()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">maze_code</span> <span class="o">=</span> <span class="n">generate_maze_code</span><span class="p">(</span><span class="n">maze_string</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="p">(</span><span class="n">maze_code</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The objective is to get the ‚ÄúX‚Äù to the ‚Äú#‚Äù by providing inputs <code class="docutils literal notranslate"><span class="pre">D</span></code> for down, <code class="docutils literal notranslate"><span class="pre">U</span></code> for up, <code class="docutils literal notranslate"><span class="pre">L</span></code> for left, and <code class="docutils literal notranslate"><span class="pre">R</span></code> for right.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">maze</span><span class="p">(</span><span class="s2">&quot;DDDDRRRRUULLUURRRRDDDD&quot;</span><span class="p">))</span>  <span class="c1"># Appending one more &#39;D&#39;, you have reached the target.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SOLVED

+-+-----+
| |     |
| | --+ |
| |   | |
| +-- | |
|     |X|
+-----+-+
</pre></div>
</div>
</div>
</div>
<p>Each character in <code class="docutils literal notranslate"><span class="pre">maze_string</span></code> represents a tile. For each tile, a tile-function is generated.</p>
<ul class="simple">
<li><p>If the current tile is ‚Äúbenign‚Äù (<code class="docutils literal notranslate"> </code>), the tile-function corresponding to the next input character (D, U, L, R) is called. Unexpected input characters are ignored. If no more input characters are left, it returns ‚ÄúVALID‚Äù and the current maze state.</p></li>
<li><p>If the current tile is a ‚Äútrap‚Äù (<code class="docutils literal notranslate"><span class="pre">+</span></code>,<code class="docutils literal notranslate"><span class="pre">|</span></code>,<code class="docutils literal notranslate"><span class="pre">-</span></code>), it returns ‚ÄúINVALID‚Äù and the current maze state.</p></li>
<li><p>If the current tile is the ‚Äútarget‚Äù (<code class="docutils literal notranslate"><span class="pre">#</span></code>), it returns ‚ÄúSOLVED‚Äù and the current maze state.</p></li>
</ul>
<p><em><strong>Try it</strong></em>. You can test other sequences of input characters, or even change the maze entirely. In order to execute your own code, you just need to open this chapter as Jupyter notebook.</p>
<p>To get an idea of the generated code, lets look at the static <a class="reference external" href="https://en.wikipedia.org/wiki/Call_graph">call graph</a>. A call graph shows the order in which functions can be executed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ControlFlow</span> <span class="kn">import</span> <span class="n">callgraph</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">callgraph</span><span class="p">(</span><span class="n">maze_code</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/be2af253a17e806e9d30e3390a1520bfd8084ac7c1eebae4b30ccfaea7bbd59f.svg" src="_images/be2af253a17e806e9d30e3390a1520bfd8084ac7c1eebae4b30ccfaea7bbd59f.svg" />
</div>
</div>
</section>
<section id="a-first-attempt">
<h3>A First Attempt<a class="headerlink" href="#a-first-attempt" title="Link to this heading">#</a></h3>
<p>We introduce a <code class="docutils literal notranslate"><span class="pre">DictMutator</span></code> class which mutates strings by inserting a keyword from a given dictionary:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DictMutator</span><span class="p">(</span><span class="n">Mutator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Variant of `Mutator` inserting keywords from a dictionary&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `dictionary` - a list of strings that can be used as keywords</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="n">dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">insert_from_dictionary</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert_from_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns `s` with a keyword from the dictionary inserted&quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="n">random_keyword</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">random_keyword</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>To fuzz the maze, we extend the <code class="docutils literal notranslate"><span class="pre">DictMutator</span></code> class to append dictionary keywords to the end of the seed and to remove a character from the end of the seed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MazeMutator</span><span class="p">(</span><span class="n">DictMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_last_character</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">append_from_dictionary</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append_from_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns s with a keyword from the dictionary appended&quot;&quot;&quot;</span>
        <span class="n">random_keyword</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="n">random_keyword</span>

    <span class="k">def</span> <span class="nf">delete_last_character</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns s without the last character&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">s</span>
</pre></div>
</div>
</div>
</div>
<p>Let‚Äôs try a standard greybox fuzzer with the classic power schedule and our extended maze mutator (n=20k).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">20000</span>
<span class="n">seed_input</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>  <span class="c1"># empty seed</span>

<span class="n">maze_mutator</span> <span class="o">=</span> <span class="n">MazeMutator</span><span class="p">([</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">])</span>
<span class="n">maze_schedule</span> <span class="o">=</span> <span class="n">PowerSchedule</span><span class="p">()</span>
<span class="n">maze_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">maze_mutator</span><span class="p">,</span> <span class="n">maze_schedule</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">maze_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">maze</span><span class="p">),</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took the fuzzer </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took the fuzzer 8.27 seconds to generate and execute 20000 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<p>We will need to print statistics for several fuzzers. Why don‚Äôt we define a function for that?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_stats</span><span class="p">(</span><span class="n">fuzzer</span><span class="p">:</span> <span class="n">GreyboxFuzzer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
    <span class="n">solved</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">invalid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">fuzzer</span><span class="o">.</span><span class="n">population</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">maze</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;INVALID&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">invalid</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="s2">&quot;VALID&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="s2">&quot;SOLVED&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">solved</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">solved</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;First solution: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;??&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Out of </span><span class="si">%d</span><span class="s2"> seeds,</span>
<span class="s2">* </span><span class="si">%4d</span><span class="s2"> solved the maze,</span>
<span class="s2">* </span><span class="si">%4d</span><span class="s2"> were valid but did not solve the maze, and</span>
<span class="s2">* </span><span class="si">%4d</span><span class="s2"> were invalid&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">solved</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">invalid</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>How well does our good, old greybox fuzzer do?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_stats</span><span class="p">(</span><span class="n">maze_fuzzer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Out of 1275 seeds,
*    0 solved the maze,
*  319 were valid but did not solve the maze, and
*  956 were invalid
</pre></div>
</div>
</div>
</div>
<p>It probably didn‚Äôt solve the maze a single time. How can we make the fuzzer aware how ‚Äúfar‚Äù a seed is from reaching the target? If we know that, we can just assign more energy to that seed.</p>
<p><em><strong>Try it</strong></em>. Print the statistics for the boosted fuzzer using the <code class="docutils literal notranslate"><span class="pre">AFLFastSchedule</span></code> and the <code class="docutils literal notranslate"><span class="pre">CountingGreyboxFuzzer</span></code>. It will likely perform much better than the unboosted greybox fuzzer: The lowest-probablity path happens to be also the path which reaches the target. You can execute your own code by opening this chapter as Jupyter notebook.</p>
</section>
<section id="computing-function-level-distance">
<h3>Computing Function-Level Distance<a class="headerlink" href="#computing-function-level-distance" title="Link to this heading">#</a></h3>
<p>Using the static call graph for the maze code and the target function, we can compute the distance of each function <span class="math notranslate nohighlight">\(f\)</span> to the target <span class="math notranslate nohighlight">\(t\)</span> as the length of the shortest path between <span class="math notranslate nohighlight">\(f\)</span> and <span class="math notranslate nohighlight">\(t\)</span>.</p>
<p>Fortunately, the generated maze code includes a function called <code class="docutils literal notranslate"><span class="pre">target_tile</span></code> which returns the name of the target-function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target</span> <span class="o">=</span> <span class="n">target_tile</span><span class="p">()</span>
<span class="n">target</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;tile_6_7&#39;
</pre></div>
</div>
</div>
</div>
<p>Now, we need to find the corresponding function in the call graph. The function <code class="docutils literal notranslate"><span class="pre">get_callgraph</span></code> returns the call graph for the maze code as <a class="reference external" href="https://networkx.github.io/">networkx</a> graph. Networkx provides some useful functions for graph analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ControlFlow</span> <span class="kn">import</span> <span class="n">get_callgraph</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cg</span> <span class="o">=</span> <span class="n">get_callgraph</span><span class="p">(</span><span class="n">maze_code</span><span class="p">)</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
        <span class="n">target_node</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_node</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;callgraphX__tile_6_7&#39;
</pre></div>
</div>
</div>
</div>
<p>We can now generate the function-level distance. The dictionary <code class="docutils literal notranslate"><span class="pre">distance</span></code> contains for each function the distance to the target-function.  If there is no path to the target, we assign a maximum distance (<code class="docutils literal notranslate"><span class="pre">0xFFFF</span></code>).</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">nx.shortest_path_length(CG,</span> <span class="pre">node,</span> <span class="pre">target_node)</span></code> returns the length of the shortest path from function <code class="docutils literal notranslate"><span class="pre">node</span></code> to function <code class="docutils literal notranslate"><span class="pre">target_node</span></code> in the call graph <code class="docutils literal notranslate"><span class="pre">CG</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">distance</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
    <span class="k">if</span> <span class="s2">&quot;__&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">node</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">distance</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path_length</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">target_node</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">distance</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFF</span>
</pre></div>
</div>
</div>
</div>
<p>These are the distance values for all tile-functions on the path to the target function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">distance</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="k">if</span> <span class="n">distance</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mh">0xFFFF</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;callgraphX&#39;: 1,
 &#39;maze&#39;: 23,
 &#39;tile_2_1&#39;: 22,
 &#39;tile_2_3&#39;: 8,
 &#39;tile_2_4&#39;: 7,
 &#39;tile_2_5&#39;: 6,
 &#39;tile_2_6&#39;: 5,
 &#39;tile_2_7&#39;: 4,
 &#39;tile_3_1&#39;: 21,
 &#39;tile_3_3&#39;: 9,
 &#39;tile_3_7&#39;: 3,
 &#39;tile_4_1&#39;: 20,
 &#39;tile_4_3&#39;: 10,
 &#39;tile_4_4&#39;: 11,
 &#39;tile_4_5&#39;: 12,
 &#39;tile_4_7&#39;: 2,
 &#39;tile_5_1&#39;: 19,
 &#39;tile_5_5&#39;: 13,
 &#39;tile_5_7&#39;: 1,
 &#39;tile_6_1&#39;: 18,
 &#39;tile_6_2&#39;: 17,
 &#39;tile_6_3&#39;: 16,
 &#39;tile_6_4&#39;: 15,
 &#39;tile_6_5&#39;: 14,
 &#39;tile_6_7&#39;: 0}
</pre></div>
</div>
</div>
</div>
<p><em><strong>Summary</strong></em>. Using the static call graph and the target function <span class="math notranslate nohighlight">\(t\)</span>, we have shown how to compute the function-level distance of each function <span class="math notranslate nohighlight">\(f\)</span> to the target <span class="math notranslate nohighlight">\(t\)</span>.</p>
<p><em><strong>Try it</strong></em>. You can try and execute your own code by opening this chapter as Jupyter notebook.</p>
<ul class="simple">
<li><p>How do we compute distance if there are multiple targets? (Hint: <a class="reference external" href="https://en.wikipedia.org/wiki/Geometric_mean">Geometric Mean</a>).</p></li>
<li><p>Given the call graph (CG) and the control-flow graph (CFG<span class="math notranslate nohighlight">\(_f\)</span>) for each function <span class="math notranslate nohighlight">\(f\)</span>, how do we compute basic-block (BB)-level distance? (Hint: In CFG<span class="math notranslate nohighlight">\(_f\)</span>, measure the BB-level distance to <em>calls</em> of functions on the path to the target function. Remember that BB-level distance in functions with higher function-level distance is higher, too.)</p></li>
</ul>
<p><em><strong>Read</strong></em>. If you are interested in other aspects of search, you can follow up by reading the chapter on <a class="reference internal" href="SearchBasedFuzzer.html"><span class="std std-doc">Search-based Fuzzing</span></a>. If you are interested, how to solve the problems above, you can have a look at our paper on ‚Äú<a class="reference external" href="https://mboehme.github.io/paper/CCS17.pdf">Directed Greybox Fuzzing</a>‚Äù.</p>
</section>
<section id="directed-power-schedule">
<h3>Directed Power Schedule<a class="headerlink" href="#directed-power-schedule" title="Link to this heading">#</a></h3>
<p>Now that we know how to compute the function-level distance, let‚Äôs try to implement a power schedule that assigns <em>more energy to seeds with a lower average distance</em> to the target function. Notice that the distance values are all <em>pre-computed</em>. These values are injected into the program binary, just like the coverage instrumentation. In practice, this makes the computation of the average distance <em>extremely efficient</em>.</p>
<p>If you really want to know. Given the function-level distance <span class="math notranslate nohighlight">\(d_f(s,t)\)</span> of a function <span class="math notranslate nohighlight">\(s\)</span> to a function <span class="math notranslate nohighlight">\(t\)</span> in call graph <span class="math notranslate nohighlight">\(CG\)</span>, our directed power schedule computes the seed distance <span class="math notranslate nohighlight">\(d(i,t)\)</span> for a seed <span class="math notranslate nohighlight">\(i\)</span> to function <span class="math notranslate nohighlight">\(t\)</span> as <span class="math notranslate nohighlight">\(d(i,t)=\dfrac{\sum_{s\in CG} d_f(s,t)}{|CG|}\)</span> where <span class="math notranslate nohighlight">\(|CG|\)</span> is the number of nodes in the call graph <span class="math notranslate nohighlight">\(CG\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DirectedSchedule</span><span class="p">(</span><span class="n">PowerSchedule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assign high energy to seeds close to some target&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">exponent</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span> <span class="o">=</span> <span class="n">exponent</span>

    <span class="k">def</span> <span class="nf">__getFunctions__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coverage</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Location</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">functions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">coverage</span><span class="p">):</span>
            <span class="n">functions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">functions</span>

    <span class="k">def</span> <span class="nf">assignEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Seed</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assigns each seed energy inversely proportional</span>
<span class="sd">           to the average function-level distance to target.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">population</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seed</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">num_dist</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">sum_dist</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getFunctions__</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">coverage</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">):</span>
                        <span class="n">sum_dist</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                        <span class="n">num_dist</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">seed</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">sum_dist</span> <span class="o">/</span> <span class="n">num_dist</span>
                <span class="n">seed</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">seed</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span>
</pre></div>
</div>
</div>
</div>
<p>Let‚Äôs see how the directed schedule performs against the good, old greybox fuzzer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">directed_schedule</span> <span class="o">=</span> <span class="n">DirectedSchedule</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">directed_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">maze_mutator</span><span class="p">,</span> <span class="n">directed_schedule</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">directed_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">maze</span><span class="p">),</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took the fuzzer </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took the fuzzer 10.55 seconds to generate and execute 20000 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_stats</span><span class="p">(</span><span class="n">directed_fuzzer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Out of 2524 seeds,
*    0 solved the maze,
*  916 were valid but did not solve the maze, and
* 1608 were invalid
</pre></div>
</div>
</div>
</div>
<p>It probably didn‚Äôt solve a single maze either, but we have more valid solutions. So, there is definitely progress.</p>
<p>Let‚Äôs have a look at the distance values for each seed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">seed</span><span class="o">.</span><span class="n">distance</span> <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">directed_fuzzer</span><span class="o">.</span><span class="n">population</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
<span class="n">x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Seed ID&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Distance&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/cb861afc9f3bd5fe93965bf1ae19ceb3f821d65346e034145eb02e3acb89a756.png" src="_images/cb861afc9f3bd5fe93965bf1ae19ceb3f821d65346e034145eb02e3acb89a756.png" />
</div>
</div>
<p>Let‚Äôs normalize the y-axis and improve the importance of the small distance seeds.</p>
</section>
<section id="improved-directed-power-schedule">
<h3>Improved Directed Power Schedule<a class="headerlink" href="#improved-directed-power-schedule" title="Link to this heading">#</a></h3>
<p>The improved directed schedule normalizes seed distance between the minimal and maximal distance.
Again, if you really want to know. Given the seed distance <span class="math notranslate nohighlight">\(d(i,t)\)</span> of a seed <span class="math notranslate nohighlight">\(i\)</span> to a function <span class="math notranslate nohighlight">\(t\)</span>, our improved power schedule computes the new seed distance <span class="math notranslate nohighlight">\(d'(i,t)\)</span> as
$<span class="math notranslate nohighlight">\(
d'(i,t)=\begin{cases}
1 &amp; \text{if } d(i,t) = \text{minD} = \text{maxD}\\
\text{maxD} - \text{minD} &amp; \text{if } d(i,t) = \text{minD} \neq \text{maxD}\\
\frac{\text{maxD} - \text{minD}}{d(i,t)-\text{minD}} &amp; \text{otherwise}
\end{cases}
\)</span><span class="math notranslate nohighlight">\(
where 
\)</span><span class="math notranslate nohighlight">\(\text{minD}=\min_{i\in T}[d(i,t)]\)</span><span class="math notranslate nohighlight">\(
and
\)</span><span class="math notranslate nohighlight">\(\text{maxD}=\max_{i\in T}[d(i,t)]\)</span><span class="math notranslate nohighlight">\(
where \)</span>T$ is the set of seeds (i.e., the population).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AFLGoSchedule</span><span class="p">(</span><span class="n">DirectedSchedule</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assign high energy to seeds close to the target&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">assignEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Seed</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assigns each seed energy inversely proportional</span>
<span class="sd">           to the average function-level distance to target.&quot;&quot;&quot;</span>
        <span class="n">min_dist</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFF</span>
        <span class="n">max_dist</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">population</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seed</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">num_dist</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">sum_dist</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getFunctions__</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">coverage</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">):</span>
                        <span class="n">sum_dist</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                        <span class="n">num_dist</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">seed</span><span class="o">.</span><span class="n">distance</span> <span class="o">=</span> <span class="n">sum_dist</span> <span class="o">/</span> <span class="n">num_dist</span>
            <span class="k">if</span> <span class="n">seed</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">min_dist</span><span class="p">:</span>
                <span class="n">min_dist</span> <span class="o">=</span> <span class="n">seed</span><span class="o">.</span><span class="n">distance</span>
            <span class="k">if</span> <span class="n">seed</span><span class="o">.</span><span class="n">distance</span> <span class="o">&gt;</span> <span class="n">max_dist</span><span class="p">:</span>
                <span class="n">max_dist</span> <span class="o">=</span> <span class="n">seed</span><span class="o">.</span><span class="n">distance</span>

        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">population</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">seed</span><span class="o">.</span><span class="n">distance</span> <span class="o">==</span> <span class="n">min_dist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">min_dist</span> <span class="o">==</span> <span class="n">max_dist</span><span class="p">:</span>
                    <span class="n">seed</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">seed</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">max_dist</span> <span class="o">-</span> <span class="n">min_dist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seed</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_dist</span> <span class="o">-</span> <span class="n">min_dist</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">distance</span> <span class="o">-</span> <span class="n">min_dist</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let‚Äôs see how the improved power schedule performs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aflgo_schedule</span> <span class="o">=</span> <span class="n">AFLGoSchedule</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">aflgo_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">maze_mutator</span><span class="p">,</span> <span class="n">aflgo_schedule</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">aflgo_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">maze</span><span class="p">),</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took the fuzzer </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took the fuzzer 16.13 seconds to generate and execute 20000 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_stats</span><span class="p">(</span><span class="n">aflgo_fuzzer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First solution: lMDD+D4DM69WGR&gt;PR?RRqUUVLJLGUURRRRDDDD
Out of 4071 seeds,
*  649 solved the maze,
*  438 were valid but did not solve the maze, and
* 2984 were invalid
</pre></div>
</div>
</div>
</div>
<p>In contrast to all previous power schedules, this one generates hundreds of solutions. It has generated many solutions.</p>
<p>Let‚Äôs filter out all ignored input characters from the first solution. The function <code class="docutils literal notranslate"><span class="pre">filter(f,</span> <span class="pre">seed.data)</span></code> returns a list of elements <code class="docutils literal notranslate"><span class="pre">e</span></code> in <code class="docutils literal notranslate"><span class="pre">seed.data</span></code> where the function <code class="docutils literal notranslate"><span class="pre">f</span></code> applied on <code class="docutils literal notranslate"><span class="pre">e</span></code> returns True.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">aflgo_fuzzer</span><span class="o">.</span><span class="n">population</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">maze</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
    <span class="k">if</span> <span class="s2">&quot;SOLVED&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;UDLR&quot;</span><span class="p">,</span> <span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DDDDRRRRUULLUURRRRDDDD
</pre></div>
</div>
</div>
</div>
<p>This is definitely a solution for the maze specified at the beginning!</p>
<p><em><strong>Summary</strong></em>. After pre-computing the function-level distance to the target, we can develop a power schedule that assigns more energy to a seed with a smaller average function-level distance to the target. By normalizing seed distance values between the minimum and maximum seed distance, we can further boost the directed power schedule.</p>
<p><em><strong>Try it</strong></em>. Implement and evaluate a simpler directed power that uses the minimal (rather than average) function-level distance. What is the downside of using the minimal distance? In order to execute your code, you just need to open this chapter as Jupyter notebook.</p>
<p><em><strong>Read</strong></em>. You can find out more about directed greybox fuzzing in the equally-named paper ‚Äú<a class="reference external" href="https://mboehme.github.io/paper/CCS17.pdf">Directed Greybox Fuzzing</a>‚Äù \cite{boehme2017greybox} and check out the implementation into AFL at <a class="github reference external" href="http://github.com/aflgo/aflgo">aflgo/aflgo</a>.</p>
</section>
</section>
<section id="id1">
<h2>Synopsis<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>This chapter introduces advanced methods for grey-box fuzzing inspired by the popular AFL fuzzer. The <code class="docutils literal notranslate"><span class="pre">GreyboxFuzzer</span></code> class has three arguments. First, a list of seed inputs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed_input</span> <span class="o">=</span> <span class="s2">&quot;http://www.google.com/search?q=fuzzing&quot;</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="p">[</span><span class="n">seed_input</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Second, a <em>mutator</em> that changes individual parts of the input.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mutator</span> <span class="o">=</span> <span class="n">Mutator</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Third, a <em>power schedule</em> that assigns fuzzing effort across the population:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">schedule</span> <span class="o">=</span> <span class="n">PowerSchedule</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>These three go into the <code class="docutils literal notranslate"><span class="pre">GreyboxFuzzer</span></code> constructor:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">greybox_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxFuzzer</span><span class="p">(</span><span class="n">seeds</span><span class="o">=</span><span class="n">seeds</span><span class="p">,</span> <span class="n">mutator</span><span class="o">=</span><span class="n">mutator</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="n">schedule</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">GreyboxFuzzer</span></code> class is used in conjunction with a <code class="docutils literal notranslate"><span class="pre">FunctionCoverageRunner</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">http_runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">http_program</span><span class="p">)</span>
<span class="n">outcomes</span> <span class="o">=</span> <span class="n">greybox_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">http_runner</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>After fuzzing, we can inspect the population:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">greybox_fuzzer</span><span class="o">.</span><span class="n">population</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[http://www.google.com/search?q=fuzzing,
 http://ww.gomgle.com/searciq=fuzzing,
 |h&gt;Att&amp;p8?wwnOgle.cooarhl~Cp`uzza&#39;,
 http2Ot/*gv-VRgogec:om/rearc h=fu~i
 g,
 http&quot;Ot/*gv-VRgogecom/rearc h=u~i
 f,
 http&quot;Ot/g$vVRgogEecom/#reabc h=u~a
 f,
 httT`2Ot//:7ev^VRgoec:uom/re!6dctKc= hS;=fu-yH
 /,
 http&#39;www&amp;go/le.comm/sea:rh*?q=Ftzzifg,
 h4tpw://w.gomMle.m/weazciq=fuezzi.&#39;,
 h~Att&amp;p8?ws_nOge.#ooarhBlw~Cp`uzza&#39;,
 ht8P:/wwvgkowcom/eacrh?q=f uzzing,
 httT`Ot//:7evVR&quot;goec:uom/re!dctKc=hS;=fu-yH
 I,
 htp://ww.go/gl%.otm/wearch?q=f5zzing,
 httU`Ot//:7evVR&quot;goec:uo2Jm/re#dctKc=hS;=fu-yH
 I,
 ht4p://ww.gomgle.co.serciq=fuzzing,
 httpp&quot;OtSo*gv&#39;VRgkg;eom/earcR &gt;
 =u|in
 f,
 htP:/wwvgMolwcomeachq=f uzzine,
 htt://[/wwgwC6.]gogleg/lE.bo/_sEarcq9Afqwz&quot;king,
 httT`Ot//:7evVR&quot;goec:uom/re!dctKc=hS;=fu-yH
 I,
 tPK:,wIfvglwvc#omeaBc`9qOin]
</pre></div>
</div>
</div>
</div>
<p>Besides the simple <code class="docutils literal notranslate"><span class="pre">PowerSchedule</span></code>, we can have advanced power schedules.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AFLFastSchedule</span></code> assigns high energy to ‚Äúunusual‚Äù paths not taken very often.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AFLGoSchedule</span></code> assigns high energy to paths close to uncovered program locations.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">AFLGoSchedule</span></code> class constructor requires a <code class="docutils literal notranslate"><span class="pre">distance</span></code> metric from each node towards target locations, as determined via analysis of the program code. See the chapter for details.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="kn">from</span> <span class="nn">ClassDiagram</span> <span class="kn">import</span> <span class="n">display_class_hierarchy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">display_class_hierarchy</span><span class="p">([</span><span class="n">CountingGreyboxFuzzer</span><span class="p">,</span> <span class="n">AFLFastSchedule</span><span class="p">,</span> <span class="n">AFLGoSchedule</span><span class="p">,</span>
                         <span class="n">DictMutator</span><span class="p">,</span> <span class="n">Seed</span><span class="p">],</span>
                        <span class="n">public_methods</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">,</span>
                            <span class="n">AdvancedMutationFuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">AdvancedMutationFuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">,</span>
                            <span class="n">GreyboxFuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">CountingGreyboxFuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">PowerSchedule</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">DirectedSchedule</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">AFLGoSchedule</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">AFLFastSchedule</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">Seed</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">Mutator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">DictMutator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">types</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Location&#39;</span><span class="p">:</span> <span class="n">Location</span><span class="p">},</span>
                        <span class="n">project</span><span class="o">=</span><span class="s1">&#39;fuzzingbook&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="861pt" height="460pt"
 viewBox="0.00 0.00 860.88 460.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 456)">
<g id="a_graph0"><a xlink:title="CountingGreyboxFuzzer class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-456 856.88,-456 856.88,4 -4,4"/>
</a>
</g>
<!-- CountingGreyboxFuzzer -->
<g id="node1" class="node">
<title>CountingGreyboxFuzzer</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class CountingGreyboxFuzzer:&#10;Count how often individual paths are exercised.">
<polygon fill="none" stroke="black" points="5.25,-6.88 5.25,-66.38 171.25,-66.38 171.25,-6.88 5.25,-6.88"/>
<text text-anchor="start" x="13.25" y="-50.08" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">CountingGreyboxFuzzer</text>
<polyline fill="none" stroke="black" points="5.25,-40.38 171.25,-40.38"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="CountingGreyboxFuzzer">
<g id="a_node1_1"><a xlink:href="#" xlink:title="run(self, runner: MutationFuzzer.FunctionCoverageRunner) &#45;&gt; Tuple[Any, str]:&#10;Inform scheduler about path frequency">
<text text-anchor="start" x="67.25" y="-27.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="reset(self):&#10;Reset path frequency">
<text text-anchor="start" x="67.25" y="-15.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">reset()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GreyboxFuzzer -->
<g id="node2" class="node">
<title>GreyboxFuzzer</title>
<g id="a_node2"><a xlink:href="#" xlink:title="class GreyboxFuzzer:&#10;Coverage&#45;guided mutational fuzzing.">
<polygon fill="none" stroke="black" points="33.75,-128.88 33.75,-188.38 142.75,-188.38 142.75,-128.88 33.75,-128.88"/>
<text text-anchor="start" x="41.75" y="-172.07" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">GreyboxFuzzer</text>
<polyline fill="none" stroke="black" points="33.75,-162.38 142.75,-162.38"/>
<g id="a_node2_3"><a xlink:href="#" xlink:title="GreyboxFuzzer">
<g id="a_node2_4"><a xlink:href="#" xlink:title="run(self, runner: MutationFuzzer.FunctionCoverageRunner) &#45;&gt; Tuple[Any, str]:&#10;Run function(inp) while tracking coverage.&#10;If we reach new coverage,&#10;add inp to population and its coverage to population_coverage">
<text text-anchor="start" x="67.25" y="-149.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
<g id="a_node2_5"><a xlink:href="#" xlink:title="reset(self):&#10;Reset the initial population, seed index, coverage information">
<text text-anchor="start" x="67.25" y="-137.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">reset()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- CountingGreyboxFuzzer&#45;&gt;GreyboxFuzzer -->
<g id="edge1" class="edge">
<title>CountingGreyboxFuzzer&#45;&gt;GreyboxFuzzer</title>
<path fill="none" stroke="black" d="M88.25,-66.67C88.25,-81.89 88.25,-100.76 88.25,-117.37"/>
<polygon fill="none" stroke="black" points="84.75,-116.91 88.25,-126.91 91.75,-116.91 84.75,-116.91"/>
</g>
<!-- AdvancedMutationFuzzer -->
<g id="node3" class="node">
<title>AdvancedMutationFuzzer</title>
<g id="a_node3"><a xlink:href="#" xlink:title="class AdvancedMutationFuzzer:&#10;Base class for mutation&#45;based fuzzing.">
<polygon fill="none" stroke="black" points="0,-244.5 0,-329.5 176.5,-329.5 176.5,-244.5 0,-244.5"/>
<text text-anchor="start" x="8" y="-313.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">AdvancedMutationFuzzer</text>
<polyline fill="none" stroke="black" points="0,-303.5 176.5,-303.5"/>
<g id="a_node3_6"><a xlink:href="#" xlink:title="AdvancedMutationFuzzer">
<g id="a_node3_7"><a xlink:href="#" xlink:title="__init__(self, seeds: List[str], mutator: Mutator, schedule: PowerSchedule) &#45;&gt; None:&#10;Constructor.&#10;`seeds` &#45; a list of (input) strings to mutate.&#10;`mutator` &#45; the mutator to apply.&#10;`schedule` &#45; the power schedule to apply.">
<text text-anchor="start" x="34.25" y="-291" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node3_8"><a xlink:href="#" xlink:title="fuzz(self) &#45;&gt; str:&#10;Returns first each seed once and then generates new inputs">
<text text-anchor="start" x="34.25" y="-278.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node3_9"><a xlink:href="#" xlink:title="create_candidate(self) &#45;&gt; str:&#10;Returns an input generated by fuzzing a seed in the population">
<text text-anchor="start" x="34.25" y="-264.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">create_candidate()</text>
</a>
</g>
<g id="a_node3_10"><a xlink:href="#" xlink:title="reset(self) &#45;&gt; None:&#10;Reset the initial population and seed index">
<text text-anchor="start" x="34.25" y="-252.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">reset()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GreyboxFuzzer&#45;&gt;AdvancedMutationFuzzer -->
<g id="edge2" class="edge">
<title>GreyboxFuzzer&#45;&gt;AdvancedMutationFuzzer</title>
<path fill="none" stroke="black" d="M88.25,-188.62C88.25,-201.74 88.25,-217.68 88.25,-232.83"/>
<polygon fill="none" stroke="black" points="84.75,-232.69 88.25,-242.69 91.75,-232.69 84.75,-232.69"/>
</g>
<!-- Fuzzer -->
<g id="node4" class="node">
<title>Fuzzer</title>
<g id="a_node4"><a xlink:href="Fuzzer.ipynb" xlink:title="class Fuzzer:&#10;Base class for fuzzers.">
<polygon fill="none" stroke="black" points="50.25,-366.5 50.25,-451.5 126.25,-451.5 126.25,-366.5 50.25,-366.5"/>
<text text-anchor="start" x="67.62" y="-435.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Fuzzer</text>
<polyline fill="none" stroke="black" points="50.25,-425.5 126.25,-425.5"/>
<g id="a_node4_11"><a xlink:href="#" xlink:title="Fuzzer">
<g id="a_node4_12"><a xlink:href="Fuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="58.25" y="-413" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node4_13"><a xlink:href="Fuzzer.ipynb" xlink:title="fuzz(self) &#45;&gt; str:&#10;Return fuzz input">
<text text-anchor="start" x="58.25" y="-400.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node4_14"><a xlink:href="Fuzzer.ipynb" xlink:title="run(self, runner: Fuzzer.Runner = &lt;Fuzzer.Runner object at 0x108a9a180&gt;) &#45;&gt; Tuple[subprocess.CompletedProcess, str]:&#10;Run `runner` with fuzz input">
<text text-anchor="start" x="58.25" y="-387.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
<g id="a_node4_15"><a xlink:href="Fuzzer.ipynb" xlink:title="runs(self, runner: Fuzzer.Runner = &lt;Fuzzer.PrintRunner object at 0x108a99dc0&gt;, trials: int = 10) &#45;&gt; List[Tuple[subprocess.CompletedProcess, str]]:&#10;Run `runner` with fuzz input, `trials` times">
<text text-anchor="start" x="58.25" y="-374.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">runs()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- AdvancedMutationFuzzer&#45;&gt;Fuzzer -->
<g id="edge3" class="edge">
<title>AdvancedMutationFuzzer&#45;&gt;Fuzzer</title>
<path fill="none" stroke="black" d="M88.25,-329.97C88.25,-338.06 88.25,-346.62 88.25,-355"/>
<polygon fill="none" stroke="black" points="84.75,-354.74 88.25,-364.74 91.75,-354.74 84.75,-354.74"/>
</g>
<!-- AFLFastSchedule -->
<g id="node5" class="node">
<title>AFLFastSchedule</title>
<g id="a_node5"><a xlink:href="#" xlink:title="class AFLFastSchedule:&#10;Exponential power schedule as implemented in AFL">
<polygon fill="none" stroke="black" points="178.5,-128.88 178.5,-188.38 298,-188.38 298,-128.88 178.5,-128.88"/>
<text text-anchor="start" x="186.5" y="-172.07" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">AFLFastSchedule</text>
<polyline fill="none" stroke="black" points="178.5,-162.38 298,-162.38"/>
<g id="a_node5_16"><a xlink:href="#" xlink:title="AFLFastSchedule">
<g id="a_node5_17"><a xlink:href="#" xlink:title="__init__(self, exponent: float) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="196.25" y="-149.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node5_18"><a xlink:href="#" xlink:title="assignEnergy(self, population: collections.abc.Sequence[Seed]) &#45;&gt; None:&#10;Assign exponential energy inversely proportional to path frequency">
<text text-anchor="start" x="196.25" y="-137.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">assignEnergy()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- PowerSchedule -->
<g id="node6" class="node">
<title>PowerSchedule</title>
<g id="a_node6"><a xlink:href="#" xlink:title="class PowerSchedule:&#10;Define how fuzzing time should be distributed across the population.">
<polygon fill="none" stroke="black" points="255.25,-244.5 255.25,-329.5 379.25,-329.5 379.25,-244.5 255.25,-244.5"/>
<text text-anchor="start" x="270.38" y="-313.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">PowerSchedule</text>
<polyline fill="none" stroke="black" points="255.25,-303.5 379.25,-303.5"/>
<g id="a_node6_19"><a xlink:href="#" xlink:title="PowerSchedule">
<g id="a_node6_20"><a xlink:href="#" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="263.25" y="-291" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node6_21"><a xlink:href="#" xlink:title="assignEnergy(self, population: collections.abc.Sequence[Seed]) &#45;&gt; None:&#10;Assigns each seed the same energy">
<text text-anchor="start" x="263.25" y="-278.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">assignEnergy()</text>
</a>
</g>
<g id="a_node6_22"><a xlink:href="#" xlink:title="choose(self, population: collections.abc.Sequence[Seed]) &#45;&gt; Seed:&#10;Choose weighted by normalized energy.">
<text text-anchor="start" x="263.25" y="-264.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">choose()</text>
</a>
</g>
<g id="a_node6_23"><a xlink:href="#" xlink:title="normalizedEnergy(self, population: collections.abc.Sequence[Seed]) &#45;&gt; List[float]:&#10;Normalize energy">
<text text-anchor="start" x="263.25" y="-251.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">normalizedEnergy()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- AFLFastSchedule&#45;&gt;PowerSchedule -->
<g id="edge4" class="edge">
<title>AFLFastSchedule&#45;&gt;PowerSchedule</title>
<path fill="none" stroke="black" d="M256.37,-188.62C264.9,-202.26 275.33,-218.94 285.13,-234.61"/>
<polygon fill="none" stroke="black" points="282.05,-236.3 290.32,-242.92 287.99,-232.59 282.05,-236.3"/>
</g>
<!-- AFLGoSchedule -->
<g id="node7" class="node">
<title>AFLGoSchedule</title>
<g id="a_node7"><a xlink:href="#" xlink:title="class AFLGoSchedule:&#10;Assign high energy to seeds close to the target">
<polygon fill="none" stroke="black" points="323,-13.25 323,-60 433.5,-60 433.5,-13.25 323,-13.25"/>
<text text-anchor="start" x="331" y="-43.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">AFLGoSchedule</text>
<polyline fill="none" stroke="black" points="323,-34 433.5,-34"/>
<g id="a_node7_24"><a xlink:href="#" xlink:title="AFLGoSchedule">
<g id="a_node7_25"><a xlink:href="#" xlink:title="assignEnergy(self, population: collections.abc.Sequence[Seed]):&#10;Assigns each seed energy inversely proportional&#10;to the average function&#45;level distance to target.">
<text text-anchor="start" x="336.25" y="-21.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">assignEnergy()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- DirectedSchedule -->
<g id="node8" class="node">
<title>DirectedSchedule</title>
<g id="a_node8"><a xlink:href="#" xlink:title="class DirectedSchedule:&#10;Assign high energy to seeds close to some target">
<polygon fill="none" stroke="black" points="316.25,-122.5 316.25,-194.75 440.25,-194.75 440.25,-122.5 316.25,-122.5"/>
<text text-anchor="start" x="325.75" y="-178.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">DirectedSchedule</text>
<polyline fill="none" stroke="black" points="316.25,-168.75 440.25,-168.75"/>
<g id="a_node8_26"><a xlink:href="#" xlink:title="DirectedSchedule">
<g id="a_node8_27"><a xlink:href="#" xlink:title="__init__(self, distance: Dict[str, int], exponent: float) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="324.25" y="-156.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node8_28"><a xlink:href="#" xlink:title="__getFunctions__(self, coverage: Set[Location]) &#45;&gt; Set[str]">
<text text-anchor="start" x="324.25" y="-142.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">__getFunctions__()</text>
</a>
</g>
<g id="a_node8_29"><a xlink:href="#" xlink:title="assignEnergy(self, population: collections.abc.Sequence[Seed]) &#45;&gt; None:&#10;Assigns each seed energy inversely proportional&#10;to the average function&#45;level distance to target.">
<text text-anchor="start" x="324.25" y="-130.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">assignEnergy()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- AFLGoSchedule&#45;&gt;DirectedSchedule -->
<g id="edge5" class="edge">
<title>AFLGoSchedule&#45;&gt;DirectedSchedule</title>
<path fill="none" stroke="black" d="M378.25,-60.48C378.25,-74.76 378.25,-93.67 378.25,-111.01"/>
<polygon fill="none" stroke="black" points="374.75,-110.59 378.25,-120.59 381.75,-110.59 374.75,-110.59"/>
</g>
<!-- DirectedSchedule&#45;&gt;PowerSchedule -->
<g id="edge6" class="edge">
<title>DirectedSchedule&#45;&gt;PowerSchedule</title>
<path fill="none" stroke="black" d="M361.1,-195.16C355.31,-207.15 348.73,-220.78 342.46,-233.78"/>
<polygon fill="none" stroke="black" points="339.37,-232.13 338.17,-242.65 345.67,-235.17 339.37,-232.13"/>
</g>
<!-- DictMutator -->
<g id="node9" class="node">
<title>DictMutator</title>
<g id="a_node9"><a xlink:href="#" xlink:title="class DictMutator:&#10;Variant of `Mutator` inserting keywords from a dictionary">
<polygon fill="none" stroke="black" points="461.25,-6.88 461.25,-66.38 621.25,-66.38 621.25,-6.88 461.25,-6.88"/>
<text text-anchor="start" x="503.38" y="-50.08" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">DictMutator</text>
<polyline fill="none" stroke="black" points="461.25,-40.38 621.25,-40.38"/>
<g id="a_node9_30"><a xlink:href="#" xlink:title="DictMutator">
<g id="a_node9_31"><a xlink:href="#" xlink:title="__init__(self, dictionary: collections.abc.Sequence[str]) &#45;&gt; None:&#10;Constructor.&#10;`dictionary` &#45; a list of strings that can be used as keywords">
<text text-anchor="start" x="469.25" y="-27.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node9_32"><a xlink:href="#" xlink:title="insert_from_dictionary(self, s: str) &#45;&gt; str:&#10;Returns `s` with a keyword from the dictionary inserted">
<text text-anchor="start" x="469.25" y="-14.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">insert_from_dictionary()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Mutator -->
<g id="node10" class="node">
<title>Mutator</title>
<g id="a_node10"><a xlink:href="#" xlink:title="class Mutator:&#10;Mutate strings">
<polygon fill="none" stroke="black" points="458.25,-109.75 458.25,-207.5 624.25,-207.5 624.25,-109.75 458.25,-109.75"/>
<text text-anchor="start" x="515.38" y="-191.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Mutator</text>
<polyline fill="none" stroke="black" points="458.25,-181.5 624.25,-181.5"/>
<g id="a_node10_33"><a xlink:href="#" xlink:title="Mutator">
<g id="a_node10_34"><a xlink:href="#" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="466.25" y="-169" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node10_35"><a xlink:href="#" xlink:title="delete_random_character(self, s: str) &#45;&gt; str:&#10;Returns s with a random character deleted">
<text text-anchor="start" x="466.25" y="-155.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">delete_random_character()</text>
</a>
</g>
<g id="a_node10_36"><a xlink:href="#" xlink:title="flip_random_character(self, s: str) &#45;&gt; str:&#10;Returns s with a random bit flipped in a random position">
<text text-anchor="start" x="466.25" y="-142.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">flip_random_character()</text>
</a>
</g>
<g id="a_node10_37"><a xlink:href="#" xlink:title="insert_random_character(self, s: str) &#45;&gt; str:&#10;Returns s with a random character inserted">
<text text-anchor="start" x="466.25" y="-129.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">insert_random_character()</text>
</a>
</g>
<g id="a_node10_38"><a xlink:href="#" xlink:title="mutate(self, inp: Any) &#45;&gt; Any:&#10;Return s with a random mutation applied. Can be overloaded in subclasses.">
<text text-anchor="start" x="466.25" y="-118" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">mutate()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- DictMutator&#45;&gt;Mutator -->
<g id="edge7" class="edge">
<title>DictMutator&#45;&gt;Mutator</title>
<path fill="none" stroke="black" d="M541.25,-66.67C541.25,-76.25 541.25,-87.27 541.25,-98.27"/>
<polygon fill="none" stroke="black" points="537.75,-98.14 541.25,-108.14 544.75,-98.14 537.75,-98.14"/>
</g>
<!-- Seed -->
<g id="node11" class="node">
<title>Seed</title>
<g id="a_node11"><a xlink:href="#" xlink:title="class Seed:&#10;Represent an input with additional attributes">
<polygon fill="none" stroke="black" points="639.25,-0.5 639.25,-72.75 715.25,-72.75 715.25,-0.5 639.25,-0.5"/>
<text text-anchor="start" x="663" y="-56.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Seed</text>
<polyline fill="none" stroke="black" points="639.25,-46.75 715.25,-46.75"/>
<g id="a_node11_39"><a xlink:href="#" xlink:title="Seed">
<g id="a_node11_40"><a xlink:href="#" xlink:title="__init__(self, data: str) &#45;&gt; None:&#10;Initialize from seed data">
<text text-anchor="start" x="647.25" y="-34.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node11_41"><a xlink:href="#" xlink:title="__repr__(self) &#45;&gt; str:&#10;Returns data as string representation of the seed">
<text text-anchor="start" x="647.25" y="-20.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">__repr__()</text>
</a>
</g>
<g id="a_node11_42"><a xlink:href="#" xlink:title="__str__(self) &#45;&gt; str:&#10;Returns data as string representation of the seed">
<text text-anchor="start" x="647.25" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">__str__()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Legend -->
<g id="node12" class="node">
<title>Legend</title>
<text text-anchor="start" x="733.62" y="-52.62" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text text-anchor="start" x="733.62" y="-42.62" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">‚Ä¢¬†</text>
<text text-anchor="start" x="739.62" y="-42.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="733.62" y="-32.62" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">‚Ä¢¬†</text>
<text text-anchor="start" x="739.62" y="-32.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="733.62" y="-22.62" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">‚Ä¢¬†</text>
<text text-anchor="start" x="739.62" y="-22.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="733.62" y="-13.57" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>A <em>greybox fuzzer</em> generates thousands of inputs per second. Pre-processing and lightweight instrumentation</p>
<ul>
<li><p>allows maintaining the efficiency <em>during</em> the fuzzing campaign, and</p></li>
<li><p>still provides enough information to control progress and slightly steer the fuzzer.</p></li>
</ul>
</li>
<li><p>The <em>power schedule</em> allows <em>steering and controlling</em> the fuzzer. For instance,</p>
<ul>
<li><p>Our <a class="reference internal" href="#Fuzzer-Boosting"><span class="xref myst">boosted greybox fuzzer</span></a> spends more energy on seeds that exercise ‚Äúunlikely‚Äù paths. The hope is that the generated inputs exercise even more unlikely paths. This in turn increases the number of paths explored per unit time.</p></li>
<li><p>Our <a class="reference internal" href="#Directed-Greybox-Fuzzing"><span class="xref myst">directed greybox fuzzer</span></a> spends more energy on seeds that are ‚Äúcloser‚Äù to a target location. The hope is that the generated inputs get even closer to the target.</p></li>
</ul>
</li>
<li><p>The <em>mutator</em> defines the fuzzer‚Äôs search space. <a class="reference internal" href="#A-First-Attempt"><span class="std std-ref">Customizing the mutator</span></a> for the given program allows reducing the search space to only relevant inputs. In a couple of chapters, we‚Äôll learn about <a class="reference internal" href="GreyboxGrammarFuzzer.html"><span class="std std-doc">dictionary-based, and grammar-based mutators</span></a> to increase the ratio of valid inputs generated.</p></li>
</ul>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Find out more about AFL</strong>: <a class="reference external" href="http://lcamtuf.coredump.cx/afl/">http://lcamtuf.coredump.cx/afl/</a></p></li>
<li><p><strong>Learn about LibFuzzer</strong> (another famous greybox fuzzer): <a class="reference external" href="http://llvm.org/docs/LibFuzzer.html">http://llvm.org/docs/LibFuzzer.html</a></p></li>
<li><p><strong>How quickly must a whitebox fuzzer exercise each path to remain more efficient than a greybox fuzzer?</strong> Marcel B√∂hme and Soumya Paul. 2016. <a class="reference external" href="https://mboehme.github.io/paper/TSE15.pdf">A Probabilistic Analysis of the Efficiency of Automated Software Testing</a>, IEEE TSE, 42:345-360 \cite{boehme2016efficiency}</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>Our aim is still to sufficiently cover functionality, such that we can trigger as many bugs as possible.  To this end, we focus on two classes of techniques:</p>
<ol class="arabic simple">
<li><p>Try to cover as much <em>specified</em> functionality as possible.  Here, we would need a <em>specification of the input format,</em> distinguishing between individual input elements such as (in our case) numbers, operators, comments, and strings ‚Äì and attempting to cover as many of these as possible.  We will explore this as it comes to <a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">grammar-based testing</span></a>, and especially in <a class="reference internal" href="GreyboxGrammarFuzzer.html"><span class="std std-doc">grammar-based mutations</span></a>.</p></li>
<li><p>Try to cover as much <em>implemented</em> functionality as possible.  The concept of a ‚Äúpopulation‚Äù that is systematically ‚Äúevolved‚Äù through ‚Äúmutations‚Äù will be explored in depth when discussing <a class="reference internal" href="SearchBasedFuzzer.html"><span class="std std-doc">search-based testing</span></a>.  Furthermore, <a class="reference internal" href="SymbolicFuzzer.html"><span class="std std-doc">symbolic testing</span></a> introduces how to systematically reach program locations by solving the conditions that lie on their paths.</p></li>
</ol>
<p>These two techniques make up the gist of the book; and, of course, they can also be combined with each other.  As usual, we provide runnable code for all.  Enjoy!</p>
<p>We‚Äôre done, so we clean up:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;callgraph.dot&#39;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;callgraph.dot&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;callgraph.py&#39;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;callgraph.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="compatibility">
<h2>Compatibility<a class="headerlink" href="#compatibility" title="Link to this heading">#</a></h2>
<p>In previous version of the chapter, the <code class="docutils literal notranslate"><span class="pre">AdvancedMutationFuzzer</span></code> class was named simply <code class="docutils literal notranslate"><span class="pre">MutationFuzzer</span></code>, causing name confusion with the <code class="docutils literal notranslate"><span class="pre">MutationFuzzer</span></code> class in the <a class="reference internal" href="MutationFuzzer.html"><span class="std std-doc">introduction to mutation-based fuzzing</span></a>. The following declaration introduces a backward-compatible alias.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MutationFuzzer</span><span class="p">(</span><span class="n">AdvancedMutationFuzzer</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<p>To be added. \todo{}</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="MutationFuzzer.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Mutation-Based Fuzzing</p>
      </div>
    </a>
    <a class="right-next"
       href="SearchBasedFuzzer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Search-Based Fuzzing</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#afl-an-effective-greybox-fuzzer">AFL: An Effective Greybox Fuzzer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ingredients-for-greybox-fuzzing">Ingredients for Greybox Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mutators">Mutators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seeds-and-power-schedules">Seeds and Power Schedules</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#runners-and-a-sample-program">Runners and a Sample Program</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-blackbox-mutation-based-fuzzing">Advanced Blackbox Mutation-based Fuzzing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#greybox-mutation-based-fuzzing">Greybox Mutation-based Fuzzing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#boosted-greybox-fuzzing">Boosted Greybox Fuzzing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-complex-example-htmlparser">A Complex Example: HTMLParser</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#directed-greybox-fuzzing">Directed Greybox Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-the-maze">Solving the Maze</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-first-attempt">A First Attempt</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-function-level-distance">Computing Function-Level Distance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#directed-power-schedule">Directed Power Schedule</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#improved-directed-power-schedule">Improved Directed Power Schedule</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compatibility">Compatibility</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller, Rahul Gopinath, Marcel B√∂hme, Gordon Fraser, and Christian Holler
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2021-2025 CISPA Helmholtz Center for Information Security (www.cispa.de); ¬© Copyright 2018-2020 Saarland University, authors, and contributors. All Rights Reserved.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>