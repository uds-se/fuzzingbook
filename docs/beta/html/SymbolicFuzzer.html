
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Symbolic Fuzzing &#8212; The Fuzzing Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=42e1b1a5" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'SymbolicFuzzer';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Mining Function Specifications" href="DynamicInvariants.html" />
    <link rel="prev" title="Concolic Fuzzing" href="ConcolicFuzzer.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of fuzzingbook.org, currently in development. See the <a href="https://fuzzingbook.org/"  style="color:white!important;">classic site</a> for resources.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/fuzzingbook.png" class="logo__image only-light" alt="The Fuzzing Book - Home"/>
    <script>document.write(`<img src="_static/fuzzingbook.png" class="logo__image only-dark" alt="The Fuzzing Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Fuzzing Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Tours through the Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Testing.html">Introduction to Software Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lexical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fuzzer.html">Fuzzing: Breaking Things with Random Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationFuzzer.html">Mutation-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GreyboxFuzzer.html">Greybox Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SearchBasedFuzzer.html">Search-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationAnalysis.html">Mutation Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Syntactical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Grammars.html">Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarFuzzer.html">Efficient Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarCoverageFuzzer.html">Grammar Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">Parsing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProbabilisticGrammarFuzzer.html">Probabilistic Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GeneratorGrammarFuzzer.html">Fuzzing with Generators</a></li>

<li class="toctree-l1"><a class="reference internal" href="GreyboxGrammarFuzzer.html">Greybox Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reducer.html">Reducing Failure-Inducing Inputs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semantical Fuzzing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingWithConstraints.html">Fuzzing with Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarMiner.html">Mining Input Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="InformationFlow.html">Tracking Information Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConcolicFuzzer.html">Concolic Fuzzing</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Symbolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Domain-Specific Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ConfigurationFuzzer.html">Testing Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIFuzzer.html">Fuzzing APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Carver.html">Carving Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="PythonFuzzer.html">Testing Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebFuzzer.html">Testing Web Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="GUIFuzzer.html">Testing Graphical User Interfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Managing Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingInTheLarge.html">Fuzzing in the Large</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhenToStopFuzzing.html">When To Stop Fuzzing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AcademicPrototyping.html">Academic Prototyping</a></li>
<li class="toctree-l1"><a class="reference internal" href="PrototypingWithPython.html">Prototyping with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="RailroadDiagrams.html">Railroad Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="ControlFlow.html">Control Flow Graph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Fuzzingbook Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Using Fuzzingbook Code in your own Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/master?urlpath=tree/docs/notebooks/SymbolicFuzzer.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook/issues/new?title=Issue%20on%20page%20%2FSymbolicFuzzer.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/SymbolicFuzzer.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Symbolic Fuzzing</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#obtaining-path-conditions-for-coverage">Obtaining Path Conditions for Coverage</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-control-flow-graph">The Control Flow Graph</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-cfg-with-path-taken">The CFG with Path Taken</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-coverage">Visualizing the Coverage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#function-summaries">Function Summaries</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#get-names-and-types-of-variables-used">Get Names and Types of Variables Used</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simple-symbolic-fuzzing">Simple Symbolic Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-all-possible-paths">Generating All Possible Paths</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-all-constraints">Extracting All Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-simple-symbolic-fuzzer">Fuzzing with Simple Symbolic Fuzzer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problems-with-the-simple-fuzzer">Problems with the Simple Fuzzer</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-symbolic-fuzzing">Advanced Symbolic Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-reassignments">Dealing with Reassignments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-assignments">Tracking Assignments</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#stepwise-exploration-of-paths">Stepwise Exploration of Paths</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#renaming-used-variables">Renaming Used Variables</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-before-you-loop">Check Before You Loop</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-path-constraints">Solving Path Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-all-paths">Generating All Paths</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-advanced-symbolic-fuzzer">Fuzzing with Advanced Symbolic Fuzzer</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-roots-of-a-quadratic-equation">Example: Roots of a Quadratic Equation</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#roots-check-before-divide">Roots - Check Before Divide</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#roots-eliminating-the-zero-division-error">Roots - Eliminating the Zero Division Error</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations">Limitations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-extending-symbolic-fuzzer-to-use-function-summaries">Exercise 1: Extending Symbolic Fuzzer to use function summaries</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-statically-checking-if-a-loop-should-be-unrolled-further">Exercise 2: Statically checking if a loop should be unrolled further</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-implementing-a-concolic-fuzzer">Exercise 3: Implementing a Concolic Fuzzer</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-the-execution-concolically">Tracing the Execution Concolically</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-nearby-paths">Exploring Nearby Paths</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compatibility">Compatibility</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="symbolic-fuzzing">
<h1>Symbolic Fuzzing<a class="headerlink" href="#symbolic-fuzzing" title="Link to this heading">#</a></h1>
<p>One of the problems with traditional methods of fuzzing is that they fail to exercise all the possible behaviors that a system can have, especially when the input space is large. Quite often the execution of a specific branch of execution may happen only with very specific inputs, which could represent a minimal fraction of the input space. The traditional fuzzing methods relies on chance to produce inputs they need. However, relying on randomness to generate values that we want is a bad idea when the space to be explored is huge. For example, a function that accepts a string, even if one only considers the first <span class="math notranslate nohighlight">\(10\)</span> characters, already has <span class="math notranslate nohighlight">\(2^{80}\)</span> possible inputs. If one is looking for a specific string, random generation of values will take a few thousand years even in one of the super computers.</p>
<p>In the <a class="reference internal" href="ConcolicFuzzer.html"><span class="std std-doc">chapter on concolic testing</span></a>, we have seen how <em>concolic tracing</em> can offer a way out. We saw how concolic tracing can be implemented using direct information flows using the Python interpreter. However, there are two problems with this approach.</p>
<ul class="simple">
<li><p>The first is that concolic tracing relies on the existence of sample inputs. What if one has no sample inputs?</p></li>
<li><p>Second, direct information flows could be unreliable if the program has indirect information flows such as those based on control flow.</p></li>
</ul>
<p>In both cases, <em>static code analysis</em> can bridge the gap. However, that raises the question: Can we determine the complete behavior of the program by examining it statically, and check if it behaves unexpectedly under some (unknown) input or result in an unexpected output?</p>
<p><em>Symbolic execution</em> is one of the ways that we can reason about the behavior of a program without executing it. A program is a computation that can be treated as a system of equations that obtains the output values from the given inputs. Executing the program symbolically – that is, solving these mathematically – along with any specified objective such as covering a particular branch or obtaining a particular output will get us inputs that can accomplish this task.</p>
<p>In this chapter, we investigate how symbolic execution can be implemented, and how it can be used to obtain interesting values for fuzzing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bookutils</span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;AJfRBF8NEWU&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/AJfRBF8NEWU"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>You should understand how to use <a class="reference external" href="https://docs.python.org/3/library/typing.html">type annotations</a> in Python.</p></li>
<li><p>A working knowledge of <a class="reference external" href="https://en.wikipedia.org/wiki/Satisfiability_modulo_theories">SMT solvers</a>, especially <a class="reference external" href="https://github.com/Z3Prover/z3">Z3</a> is useful.</p></li>
<li><p>You should have read the <a class="reference internal" href="Coverage.html"><span class="std std-doc">chapter on coverage</span></a>.</p></li>
<li><p>A familiarity with <a class="reference internal" href="ConcolicFuzzer.html"><span class="std std-doc">chapter on concolic fuzzing</span></a> would be helpful.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="kn">import</span> <span class="nn">sys</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This code requires Python 3.11 or earlier&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<!-- Automatically generated. Do not edit. -->
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fuzzingbook.SymbolicFuzzer</span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p>This chapter provides an implementation of a symbolic fuzzing engine <code class="docutils literal notranslate"><span class="pre">SymbolicFuzzer</span></code>. The fuzzer uses symbolic execution to exhaustively explore paths in the program to a limited depth, and generate inputs that will reach these paths.</p>
<p>As an example, consider the function <code class="docutils literal notranslate"><span class="pre">gcd()</span></code>, computing the greatest common divisor of <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">a</span>  <span class="c1"># type: ignore</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>

    <span class="k">while</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">a</span>  <span class="c1"># type: ignore</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">b</span>

    <span class="k">return</span> <span class="n">a</span>
</pre></div>
</div>
<p>To explore <code class="docutils literal notranslate"><span class="pre">gcd()</span></code>, the fuzzer can be used as follows, producing values for arguments that cover different paths in <code class="docutils literal notranslate"><span class="pre">gcd()</span></code> (including multiple times of loop iterations):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gcd_fuzzer</span> <span class="o">=</span> <span class="n">SymbolicFuzzer</span><span class="p">(</span><span class="n">gcd</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">args</span> <span class="o">=</span> <span class="n">gcd_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<span class="go">{&#39;a&#39;: 8, &#39;b&#39;: 3}</span>
<span class="go">{&#39;a&#39;: 1, &#39;b&#39;: 2}</span>
<span class="go">{&#39;a&#39;: 2, &#39;b&#39;: 5}</span>
<span class="go">{&#39;a&#39;: 7, &#39;b&#39;: 6}</span>
<span class="go">{&#39;a&#39;: 9, &#39;b&#39;: 10}</span>
<span class="go">{&#39;a&#39;: 4, &#39;b&#39;: 4}</span>
<span class="go">{&#39;a&#39;: 10, &#39;b&#39;: 9}</span>
<span class="go">{&#39;a&#39;: 2, &#39;b&#39;: 10}</span>
<span class="go">{&#39;a&#39;: 14, &#39;b&#39;: 7}</span>
<span class="go">{&#39;a&#39;: 3, &#39;b&#39;: 2}</span>

</pre></div>
</div>
<p>Note that the variable values returned by <code class="docutils literal notranslate"><span class="pre">fuzz()</span></code> are Z3 <em>symbolic</em> values; to convert them to Python numbers, use their method <code class="docutils literal notranslate"><span class="pre">as_long()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">args</span> <span class="o">=</span> <span class="n">gcd_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">a</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">b</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">d</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gcd(</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">gcd(0, 8) = 8</span>
<span class="go">gcd(-1, 10) = -1</span>
<span class="go">gcd(13, 2) = 1</span>
<span class="go">gcd(0, 10) = 10</span>
<span class="go">gcd(6, 7) = 1</span>
<span class="go">gcd(14, 2) = 2</span>
<span class="go">gcd(-1, 11) = -1</span>
<span class="go">gcd(15, 0) = 15</span>
<span class="go">gcd(0, -1) = -1</span>
<span class="go">gcd(-3, -2) = -1</span>

</pre></div>
</div>
<p>The symbolic fuzzer is subject to a number of constraints. First, it requires that the function to be fuzzed has correct type annotations, including all local variables. Second, it solves loops by unrolling them, but only for a fixed amount.</p>
<p>For programs without loops and variable reassignments, the <code class="docutils literal notranslate"><span class="pre">SimpleSymbolicFuzzer</span></code> is a faster, but more limited alternative.</p>
<p><img alt="" src="_images/SymbolicFuzzer-synopsis-1.svg" /></p>
</section>
<section id="obtaining-path-conditions-for-coverage">
<h2>Obtaining Path Conditions for Coverage<a class="headerlink" href="#obtaining-path-conditions-for-coverage" title="Link to this heading">#</a></h2>
<p>In the chapter on <a class="reference internal" href="SearchBasedFuzzer.html"><span class="std std-doc">parsing and recombining inputs</span></a>, we saw how difficult it was to generate inputs for <code class="docutils literal notranslate"><span class="pre">process_vehicle()</span></code> – a simple function that accepts a string. The solution given there was to rely on preexisting sample inputs. However, this solution is inadequate as it assumes the existence of sample inputs. What if there are no sample inputs at hand?</p>
<p>For a simpler example, let us consider the following triangle function (which we already have seen in the <a class="reference internal" href="ConcolicFuzzer.html"><span class="std std-doc">chapter on concolic fuzzing</span></a>). Can we generate inputs to cover all the paths?</p>
<p><em>Note.</em> We use type annotations to denote the argument types of programs. The <a class="reference internal" href="DynamicInvariants.html"><span class="std std-doc">chapter on discovering dynamic invariants</span></a> will discuss how these types can be inferred automatically.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">check_triangle</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Equilateral&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Isosceles&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Isosceles&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Isosceles&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Scalene&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Isosceles&quot;</span>
</pre></div>
</div>
</div>
</div>
<section id="the-control-flow-graph">
<h3>The Control Flow Graph<a class="headerlink" href="#the-control-flow-graph" title="Link to this heading">#</a></h3>
<p>The control flow graph of this function can be represented as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ControlFlow</span> <span class="kn">import</span> <span class="n">PyCFG</span><span class="p">,</span> <span class="n">to_graph</span><span class="p">,</span> <span class="n">gen_cfg</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">show_cfg</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">to_graph</span><span class="p">(</span><span class="n">gen_cfg</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">fn</span><span class="p">)),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_cfg</span><span class="p">(</span><span class="n">check_triangle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/706ffc25addafbde6efb0647c287721ac6ed3b261e4b3dda6ea309275ed68706.svg" src="_images/706ffc25addafbde6efb0647c287721ac6ed3b261e4b3dda6ea309275ed68706.svg" />
</div>
</div>
<p>The possible execution paths traced by the program can be represented as follows, with the numbers indicating the specific line numbers executed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">paths</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;&lt;path 1&gt;&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="s1">&#39;Equilateral&#39;</span><span class="p">),</span>
    <span class="s1">&#39;&lt;path 2&gt;&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="s1">&#39;Isosceles&#39;</span><span class="p">),</span>
    <span class="s1">&#39;&lt;path 3&gt;&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="s1">&#39;Isosceles&#39;</span><span class="p">),</span>
    <span class="s1">&#39;&lt;path 4&gt;&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">],</span> <span class="s1">&#39;Isosceles&#39;</span><span class="p">),</span>
    <span class="s1">&#39;&lt;path 5&gt;&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="s1">&#39;Scalene&#39;</span><span class="p">),</span>
    <span class="s1">&#39;&lt;path 6&gt;&#39;</span><span class="p">:</span> <span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">17</span><span class="p">],</span> <span class="s1">&#39;Isosceles&#39;</span><span class="p">),</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Consider the <code class="docutils literal notranslate"><span class="pre">&lt;path</span> <span class="pre">1&gt;</span></code>. To trace this path, we need to execute the following statements in order.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">:</span> <span class="n">check_triangle</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="mi">2</span><span class="p">:</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">True</span>
<span class="mi">3</span><span class="p">:</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">True</span>
<span class="mi">4</span><span class="p">:</span> <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">True</span>
<span class="mi">5</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;Equilateral&#39;</span>
</pre></div>
</div>
<p>That is, any execution that traces this path has to start with values for <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, and <code class="docutils literal notranslate"><span class="pre">c</span></code> that obeys the constraints in line numbers <code class="docutils literal notranslate"><span class="pre">2:</span> <span class="pre">(a</span> <span class="pre">==</span> <span class="pre">b)</span></code> evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code>, <code class="docutils literal notranslate"><span class="pre">3:</span> <span class="pre">(a</span> <span class="pre">==</span> <span class="pre">c)</span></code> evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code>, and <code class="docutils literal notranslate"><span class="pre">4:</span> <span class="pre">(b</span> <span class="pre">==</span> <span class="pre">c)</span></code> evaluates to <code class="docutils literal notranslate"><span class="pre">True</span></code>. Can we generate inputs such that these constraints are satisfied?</p>
<p>We have seen from the <a class="reference internal" href="ConcolicFuzzer.html"><span class="std std-doc">chapter on concolic fuzzing</span></a> how one can use an SMT solver such as Z3 to obtain a solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">z3</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z3_ver</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">get_version</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">z3_ver</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(4, 11, 2, 0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">z3_ver</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Please check z3 version&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>What kind of symbolic variables do we need? We can obtain that information from the type annotations of the function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_annotations</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">params</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">get_annotations</span><span class="p">(</span><span class="n">check_triangle</span><span class="p">)</span>
<span class="n">params</span><span class="p">,</span> <span class="n">ret</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>([(&#39;a&#39;, int), (&#39;b&#39;, int), (&#39;c&#39;, int)], str)
</pre></div>
</div>
</div>
</div>
<p>We create symbolic variables to represent each of the parameters</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SYM_VARS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nb">int</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">z3</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">IntVal</span><span class="p">),</span> <span class="nb">float</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">z3</span><span class="o">.</span><span class="n">Real</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">RealVal</span><span class="p">),</span> <span class="nb">str</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">z3</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">StringVal</span><span class="p">)}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_symbolicparams</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">get_annotations</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">SYM_VARS</span><span class="p">[</span><span class="n">typ</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">params</span><span class="p">],</span> <span class="n">SYM_VARS</span><span class="p">[</span><span class="n">ret</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="s1">&#39;__return__&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">r</span> <span class="o">=</span> <span class="n">get_symbolicparams</span><span class="p">(</span><span class="n">check_triangle</span><span class="p">)</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(a, b, c, __return__)
</pre></div>
</div>
</div>
</div>
<p>We can now ask <em>z3</em> to solve the set of equations for us as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z3</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">b</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[a = 0, b = 0, c = 0]
</pre></div>
</div>
</div>
</div>
<p>Here we find the first problem in our program. Our program seems to not check whether the sides are greater than zero. (Real-world triangles all have sides with a positive length.) Assume for now that we do not have that restriction. Does our program correctly follow the path described?</p>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">ArcCoverage</span></code> from the <a class="reference internal" href="ConcolicFuzzer.html"><span class="std std-doc">chapter on concolic fuzzing</span></a> as a tracer to visualize that information as below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ConcolicFuzzer</span> <span class="kn">import</span> <span class="n">ArcCoverage</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<p>First, we recover the trace.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ArcCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">check_triangle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Equilateral&#39;</span>
<span class="n">cov</span><span class="o">.</span><span class="n">_trace</span><span class="p">,</span> <span class="n">cov</span><span class="o">.</span><span class="n">arcs</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>([(&#39;check_triangle&#39;, 1),
  (&#39;check_triangle&#39;, 2),
  (&#39;check_triangle&#39;, 3),
  (&#39;check_triangle&#39;, 4),
  (&#39;check_triangle&#39;, 5),
  (&#39;__exit__&#39;, 102),
  (&#39;__exit__&#39;, 105)],
 [(1, 2), (2, 3), (3, 4), (4, 5), (5, 102), (102, 105)])
</pre></div>
</div>
</div>
</div>
<p>We can now determine the path taken.</p>
</section>
<section id="the-cfg-with-path-taken">
<h3>The CFG with Path Taken<a class="headerlink" href="#the-cfg-with-path-taken" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_cfg</span><span class="p">(</span><span class="n">check_triangle</span><span class="p">,</span> <span class="n">arcs</span><span class="o">=</span><span class="n">cov</span><span class="o">.</span><span class="n">arcs</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/78e6a6fac9aebaf7faaf495434e4c4195022a9c5a3f490861dfaefd1b9966538.svg" src="_images/78e6a6fac9aebaf7faaf495434e4c4195022a9c5a3f490861dfaefd1b9966538.svg" />
</div>
</div>
<p>As you can see, the path taken is <code class="docutils literal notranslate"><span class="pre">&lt;path</span> <span class="pre">1&gt;</span></code>.</p>
<p>Similarly, for solving <code class="docutils literal notranslate"><span class="pre">&lt;path</span> <span class="pre">2&gt;</span></code> we need to simply invert the condition at &lt;line 2&gt;:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z3</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>no solution
</pre></div>
</div>
</div>
</div>
<p>The symbolic execution suggests that there is no solution. A moment’s reflection will convince us that it is indeed true. Let us proceed with the other paths. The <code class="docutils literal notranslate"><span class="pre">&lt;path</span> <span class="pre">3&gt;</span></code> can be obtained by inverting the condition at <code class="docutils literal notranslate"><span class="pre">&lt;line</span> <span class="pre">4&gt;</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z3</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[b = 1, c = 0, a = 1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ArcCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">check_triangle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Isosceles&#39;</span>
<span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cov</span><span class="o">.</span><span class="n">_trace</span> <span class="k">if</span> <span class="n">fn</span> <span class="o">==</span> <span class="s1">&#39;check_triangle&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3, 9]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;&lt;path 3&gt;&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>([1, 2, 3, 9], &#39;Isosceles&#39;)
</pre></div>
</div>
</div>
</div>
<p>How about path &lt;4&gt;?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z3</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">),</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[b = 0, c = 1, a = 1]
</pre></div>
</div>
</div>
</div>
<p>As we mentioned earlier, our program does not account for sides with zero or negative length. We can modify our program to check for zero and negative input. However, do we always have to make sure that every function has to account for all possible inputs? It is possible that the <code class="docutils literal notranslate"><span class="pre">check_triangle</span></code> is not directly exposed to the user, and it is called from another function that already guarantees that the inputs would be positive. In the <a class="reference internal" href="DynamicInvariants.html"><span class="std std-doc">chapter on dynamic invariants</span></a>, we will show how to discover such preconditions and post conditions.</p>
<p>We can easily add such a precondition here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pre_condition</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z3</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">pre_condition</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">),</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[c = 2, b = 1, a = 2]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ArcCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">check_triangle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Isosceles&#39;</span>
<span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cov</span><span class="o">.</span><span class="n">_trace</span> <span class="k">if</span> <span class="n">fn</span> <span class="o">==</span> <span class="s1">&#39;check_triangle&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 11, 12, 13]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;&lt;path 4&gt;&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>([1, 2, 11, 12, 13], &#39;Isosceles&#39;)
</pre></div>
</div>
</div>
</div>
<p>Continuing to path &lt;5&gt;:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z3</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">pre_condition</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">),</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">c</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[a = 1, c = 3, b = 2]
</pre></div>
</div>
</div>
</div>
<p>And indeed it is a <em>Scalene</em> triangle.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ArcCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">check_triangle</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Scalene&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;&lt;path 5&gt;&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>([1, 2, 11, 12, 15], &#39;Scalene&#39;)
</pre></div>
</div>
</div>
</div>
<p>Finally, for <code class="docutils literal notranslate"><span class="pre">&lt;path</span> <span class="pre">6&gt;</span></code> the procedure is similar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z3</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">pre_condition</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">),</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[c = 2, a = 1, b = 2]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ArcCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">check_triangle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Isosceles&#39;</span>
<span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cov</span><span class="o">.</span><span class="n">_trace</span> <span class="k">if</span> <span class="n">fn</span> <span class="o">==</span> <span class="s1">&#39;check_triangle&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 11, 17]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">paths</span><span class="p">[</span><span class="s1">&#39;&lt;path 6&gt;&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>([1, 2, 11, 17], &#39;Isosceles&#39;)
</pre></div>
</div>
</div>
</div>
<p>What if we wanted another solution? We can simply ask the solver to solve again, and not give us the same values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seen</span> <span class="o">=</span> <span class="p">[</span><span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z3</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">pre_condition</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">seen</span><span class="p">)),</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">),</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[c = 2, a = 1, b = 2]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z3</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">pre_condition</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">seen</span><span class="p">)),</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">),</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">c</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[c = 1, a = 3, b = 1]
</pre></div>
</div>
</div>
</div>
<p>That is, using simple symbolic computation, we were able to easily see that (1) some paths are not reachable, and (2) some conditions were insufficient – we needed preconditions. What about the total coverage obtained?</p>
</section>
<section id="visualizing-the-coverage">
<h3>Visualizing the Coverage<a class="headerlink" href="#visualizing-the-coverage" title="Link to this heading">#</a></h3>
<p>Visualizing the statement coverage can be accomplished as below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VisualizedArcCoverage</span><span class="p">(</span><span class="n">ArcCoverage</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">show_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">fn</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">covered</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">lineno</span> <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">lineno</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%2d</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">covered</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We run all the inputs obtained under the coverage tracer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">VisualizedArcCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">check_triangle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Equilateral&#39;</span>
    <span class="k">assert</span> <span class="n">check_triangle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Isosceles&#39;</span>
    <span class="k">assert</span> <span class="n">check_triangle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Isosceles&#39;</span>
    <span class="k">assert</span> <span class="n">check_triangle</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Scalene&#39;</span>
    <span class="k">assert</span> <span class="n">check_triangle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Isosceles&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov</span><span class="o">.</span><span class="n">show_coverage</span><span class="p">(</span><span class="n">check_triangle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>#  1: def check_triangle(a: int, b: int, c: int) -&gt; str:
#  2:     if a == b:
#  3:         if a == c:
#  4:             if b == c:
#  5:                 return &quot;Equilateral&quot;
   6:             else:
   7:                 return &quot;Isosceles&quot;
   8:         else:
#  9:             return &quot;Isosceles&quot;
  10:     else:
# 11:         if b != c:
# 12:             if a == c:
# 13:                 return &quot;Isosceles&quot;
  14:             else:
# 15:                 return &quot;Scalene&quot;
  16:         else:
# 17:             return &quot;Isosceles&quot;
  18: 
</pre></div>
</div>
</div>
</div>
<p>The coverage is as expected. The generated values do seem to cover all code that can be covered.</p>
<p>We have seen how to reason about each path through the program. Can we combine them together to produce a single expression that represents the program behavior? This is what we will discuss next.</p>
</section>
<section id="function-summaries">
<h3>Function Summaries<a class="headerlink" href="#function-summaries" title="Link to this heading">#</a></h3>
<p>Consider this equation for determining absolute value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">abs_value</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>  <span class="c1"># type: ignore</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">x</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">v</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_cfg</span><span class="p">(</span><span class="n">abs_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a068195018df547e48a892ef91bc3d54fd1767dde392a22c655981c51eec5071.svg" src="_images/a068195018df547e48a892ef91bc3d54fd1767dde392a22c655981c51eec5071.svg" />
</div>
</div>
<p>What can we say about the value of <code class="docutils literal notranslate"><span class="pre">v</span></code> at <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">5</span></code>? Let us trace and see. First, we have variable <code class="docutils literal notranslate"><span class="pre">x</span></code> at <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">1</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">x</span><span class="p">,),</span> <span class="n">r</span> <span class="o">=</span> <span class="n">get_symbolicparams</span><span class="p">(</span><span class="n">abs_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>At <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">2</span></code>, we face a bifurcation in the possible paths. Hence, we produce two paths with corresponding constraints.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l2_T</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span>
<span class="n">l2_F</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">3</span></code>, we only need to consider the <code class="docutils literal notranslate"><span class="pre">If</span></code> path. However, we have an assignment. So we use a new variable here. The type <em>float</em> is indicated in the source, and its equivalent <em>z3</em> type is <em>Real</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v_0</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Real</span><span class="p">(</span><span class="s1">&#39;v_0&#39;</span><span class="p">)</span>
<span class="n">l3</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">l2_T</span><span class="p">,</span> <span class="n">v_0</span> <span class="o">==</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Similarly, for <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">5</span></code>, we have an assignment. (Can we reuse the variable <code class="docutils literal notranslate"><span class="pre">v_0</span></code> from before?)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v_1</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Real</span><span class="p">(</span><span class="s1">&#39;v_1&#39;</span><span class="p">)</span>
<span class="n">l5</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">l2_F</span><span class="p">,</span> <span class="n">v_1</span> <span class="o">==</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When we come to <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">6</span></code>, we see that we have <em>two</em> input streams. We have a choice. We can either keep each path separate as we did previously.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Real</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">l3</span><span class="p">,</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_0</span><span class="p">),</span> <span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">l5</span><span class="p">,</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_1</span><span class="p">)]:</span>
    <span class="n">z3</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[x = -1/2, v_0 = 1/2, v = 1/2]
[v_1 = 1, x = 1, v = 1]
</pre></div>
</div>
</div>
</div>
<p>Or, we can combine them together and produce a single predicate at <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">6</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Real</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
<span class="n">l6</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">l3</span><span class="p">,</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_0</span><span class="p">),</span> <span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">l5</span><span class="p">,</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v_1</span><span class="p">))</span>
<span class="n">z3</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">l6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[v_1 = 1/2, x = -1/4, v_0 = 1/4, v = 1/4]
</pre></div>
</div>
</div>
</div>
<p><strong>Note.</strong> Merging two incoming streams of execution can be non-trivial, especially when the execution paths are traversed multiple times (E.g. loops and recursion). For those interested, lookup <a class="reference external" href="https://www.st.cs.uni-saarland.de/publications/details/galeotti-hvc-2014/">inferring loop invariants</a>.</p>
<p>We can get this to produce any number of solutions for <code class="docutils literal notranslate"><span class="pre">abs()</span></code> as below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Solver</span><span class="p">()</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l6</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">==</span> <span class="n">z3</span><span class="o">.</span><span class="n">sat</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
        <span class="n">x_val</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no solution&#39;</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">x_val</span><span class="p">))</span>
<span class="n">s</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[v_1 = 1/2, x = 1/2, v_0 = 0, v = 1/2]
[v_1 = 0, x = 0, v = 0]
[v_1 = 1/4, x = 1/4, v = 1/4]
[v_1 = 1/8, x = 1/8, v = 1/8]
[v_1 = 1/16, x = 1/16, v = 1/16]
</pre></div>
</div>
<div class="output text_html">[x &lt; 0 &and; v_0 = -x &and; v = v_0 &or; &not;(x &lt; 0) &and; v_1 = x &and; v = v_1,
 &not;(1/2 = x),
 &not;(0 = x),
 &not;(1/4 = x),
 &not;(1/8 = x),
 &not;(1/16 = x)]</div></div>
</div>
<p>The solver is not particularly random. So we need to help it a bit to produce values on the negative range.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">==</span> <span class="n">z3</span><span class="o">.</span><span class="n">sat</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
        <span class="n">x_val</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no solution&#39;</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">x_val</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[x = -1/32, v_0 = 1/32, v = 1/32]
[x = -33/32, v_0 = 33/32, v = 33/32]
[x = -65/32, v_0 = 65/32, v = 65/32]
[x = -97/32, v_0 = 97/32, v = 97/32]
[x = -129/32, v_0 = 129/32, v = 129/32]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">[x &lt; 0 &and; v_0 = -x &and; v = v_0 &or; &not;(x &lt; 0) &and; v_1 = x &and; v = v_1,
 &not;(1/2 = x),
 &not;(0 = x),
 &not;(1/4 = x),
 &not;(1/8 = x),
 &not;(1/16 = x),
 x &lt; 0,
 &not;(-1/32 = x),
 &not;(-33/32 = x),
 &not;(-65/32 = x),
 &not;(-97/32 = x),
 &not;(-129/32 = x)]</div></div>
</div>
<p>Note that the single expression produced at <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">6</span></code> is essentially a summary for <code class="docutils literal notranslate"><span class="pre">abs_value()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">abs_value_summary</span> <span class="o">=</span> <span class="n">l6</span>
<span class="n">abs_value_summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">x &lt; 0 &and; v_0 = -x &and; v = v_0 &or; &not;(x &lt; 0) &and; v_1 = x &and; v = v_1</div></div>
</div>
<p>The <em>z3</em> solver can be used to simplify the predicates where possible.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z3</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">l6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">&not;(0 &le; x) &and; v_0 = -1&middot;x &and; v = v_0 &or; 0 &le; x &and; v_1 = x &and; v = v_1</div></div>
</div>
<p>One can use this summary rather than trace into <code class="docutils literal notranslate"><span class="pre">abs_value()</span></code> when <code class="docutils literal notranslate"><span class="pre">abs_value()</span></code> is used elsewhere. However, that presents us with a problem. It is possible that the same function may be called multiple times. In this case, using the same variables will lead to collision. One way to avoid that is to <em>prefix</em> some call specific value to the variables.</p>
<p><strong>Note:</strong> The SMT 2.0 standard allows one to define functions (<em>macros</em> in SMT parlance) directly. For example, the <code class="docutils literal notranslate"><span class="pre">abs-value</span></code> will be defined as follows:</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">define-fun</span><span class="w"> </span><span class="nv">abs-value</span><span class="w"> </span><span class="p">((</span><span class="nv">x</span><span class="w"> </span><span class="nv">Int</span><span class="p">))</span><span class="w"> </span><span class="nv">Int</span>
<span class="w">       </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">           </span><span class="nv">x</span>
<span class="w">           </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span>
</pre></div>
</div>
<p>Or equivalently, (especially if <code class="docutils literal notranslate"><span class="pre">abs-value</span></code> is recursively defined)</p>
<div class="highlight-lisp notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">declare-fun</span><span class="w"> </span><span class="nv">abs-value</span><span class="w"> </span><span class="p">(</span><span class="nv">Int</span><span class="p">)</span><span class="w"> </span><span class="nv">Int</span><span class="p">)</span>
<span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="p">(</span><span class="nv">forall</span><span class="w"> </span><span class="p">((</span><span class="nv">x</span><span class="w"> </span><span class="nv">Int</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nv">abs-value</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                       </span><span class="nv">x</span>
<span class="w">                       </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="nv">x</span><span class="p">)))))</span>
</pre></div>
</div>
<p>One can then say</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">&gt;</span> <span class="p">(</span><span class="nb">abs</span><span class="o">-</span><span class="n">value</span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">abs</span><span class="o">-</span><span class="n">value</span> <span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
<p>Unfortunately, the z3py project does not expose this facility in Python. Hence, we have to use the <code class="docutils literal notranslate"><span class="pre">prefix_vars()</span></code> hack.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ast</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">prefix_vars()</span></code> modifies the variables in an expression such that the variables are prefixed with a given value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">prefix_vars</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">op</span><span class="p">,</span>
                          <span class="p">[</span><span class="n">prefix_vars</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> <span class="p">[])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">(</span>
            <span class="n">prefix_vars</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span> <span class="n">astnode</span><span class="o">.</span><span class="n">op</span><span class="p">,</span>
            <span class="n">prefix_vars</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">prefix_vars</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">operand</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">prefix_vars</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span>
                        <span class="p">[</span><span class="n">prefix_vars</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">args</span><span class="p">],</span>
                        <span class="n">astnode</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span>
            <span class="n">prefix_vars</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">prefix</span><span class="p">),</span> <span class="n">astnode</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span>
            <span class="p">[</span><span class="n">prefix_vars</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">comparators</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">astnode</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;And&#39;</span><span class="p">,</span> <span class="s1">&#39;Or&#39;</span><span class="p">,</span> <span class="s1">&#39;Not&#39;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;z3.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">astnode</span><span class="o">.</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">astnode</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">astnode</span><span class="o">.</span><span class="n">ctx</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="n">prefix_vars</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">astnode</span>
</pre></div>
</div>
</div>
</div>
<p>For applying <code class="docutils literal notranslate"><span class="pre">prefix_vars()</span></code> one needs the <em>abstract syntax tree</em> (AST) of the Python expression involved. We obtain this by invoking <code class="docutils literal notranslate"><span class="pre">ast.parse()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xy_ast</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;x+y&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can visualize the resulting tree as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bookutils</span> <span class="kn">import</span> <span class="n">rich_output</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">rich_output</span><span class="p">():</span>
    <span class="c1"># Normally, this will do</span>
    <span class="kn">from</span> <span class="nn">showast</span> <span class="kn">import</span> <span class="n">show_ast</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">show_ast</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
        <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_ast</span><span class="p">(</span><span class="n">xy_ast</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/85988f14d711f2d92bdc535263f97871e8fc8207075f87ee2c49cd27b29f5b4f.svg" src="_images/85988f14d711f2d92bdc535263f97871e8fc8207075f87ee2c49cd27b29f5b4f.svg" />
</div>
</div>
<p>What the visualization does <em>not</em> show, though, is that when parsing Python source code, the resulting AST comes wrapped in a <code class="docutils literal notranslate"><span class="pre">Module</span></code> by default:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xy_ast</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ast.Module at 0x116dfa6e0&gt;
</pre></div>
</div>
</div>
</div>
<p>And to access the expression (<code class="docutils literal notranslate"><span class="pre">Expr</span></code>), we need to access the first child of that “module”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xy_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ast.Expr at 0x116dfa4a0&gt;
</pre></div>
</div>
</div>
</div>
<p>The actual expression is within that <code class="docutils literal notranslate"><span class="pre">Expr</span></code> object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xy_ast</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ast.BinOp at 0x116dfa2c0&gt;
</pre></div>
</div>
</div>
</div>
<p>Hence, for easier manipulation of an expression AST, we define a function <code class="docutils literal notranslate"><span class="pre">get_expression()</span></code> which unwraps it and returns the AST representation of the expression inside.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_expression</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
</pre></div>
</div>
</div>
</div>
<p>It is used as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">e</span> <span class="o">=</span> <span class="n">get_expression</span><span class="p">(</span><span class="s1">&#39;x+y&#39;</span><span class="p">)</span>
<span class="n">e</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ast.BinOp at 0x116df8a00&gt;
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">to_src()</span></code> allows us to <em>unparse</em> an expression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">to_src</span><span class="p">(</span><span class="n">astnode</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">astnode</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>It is used as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">to_src</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;x + y&#39;
</pre></div>
</div>
</div>
</div>
<p>We can combine both pieces to produce a prefixed expression. Let us prefix all variables with <code class="docutils literal notranslate"><span class="pre">x1_</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">abs_value_summary_ast</span> <span class="o">=</span> <span class="n">get_expression</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">abs_value_summary</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">to_src</span><span class="p">(</span><span class="n">prefix_vars</span><span class="p">(</span><span class="n">abs_value_summary_ast</span><span class="p">,</span> <span class="s1">&#39;x1_&#39;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>z3.Or(z3.And(z3.And(x1_x &lt; 0, x1_v_0 == -x1_x), x1_v == x1_v_0), z3.And(z3.And(z3.Not(x1_x &lt; 0), x1_v_1 == x1_x), x1_v == x1_v_1))
</pre></div>
</div>
</div>
</div>
<section id="get-names-and-types-of-variables-used">
<h4>Get Names and Types of Variables Used<a class="headerlink" href="#get-names-and-types-of-variables-used" title="Link to this heading">#</a></h4>
<p>What about the declarations used? Given that we have all equations in <em>Z3</em>, we can retrieve this information directly. We define <code class="docutils literal notranslate"><span class="pre">z3_names_and_types()</span></code> that takes in a <em>Z3</em> expression, and extracts the variable definitions required.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">z3_names_and_types</span><span class="p">(</span><span class="n">z3_ast</span><span class="p">):</span>
    <span class="n">hm</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">z3_ast</span><span class="o">.</span><span class="n">children</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">children</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">hm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">z3_names_and_types</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># HACK.. How else to distinguish literals and vars?</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">z3_ast</span><span class="o">.</span><span class="n">decl</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">z3_ast</span><span class="o">.</span><span class="n">sort</span><span class="p">())):</span>
            <span class="n">hm</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">z3_ast</span><span class="o">.</span><span class="n">decl</span><span class="p">())]</span> <span class="o">=</span> <span class="s1">&#39;z3.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">z3_ast</span><span class="o">.</span><span class="n">sort</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">hm</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">abs_value_declarations</span> <span class="o">=</span> <span class="n">z3_names_and_types</span><span class="p">(</span><span class="n">abs_value_summary</span><span class="p">)</span>
<span class="n">abs_value_declarations</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;x&#39;: &#39;z3.Real&#39;, &#39;v_0&#39;: &#39;z3.Real&#39;, &#39;v&#39;: &#39;z3.Real&#39;, &#39;v_1&#39;: &#39;z3.Real&#39;}
</pre></div>
</div>
</div>
</div>
<p>However, <code class="docutils literal notranslate"><span class="pre">z3_names_and_types()</span></code> is limited in that it requires the <em>Z3</em> AST to operate. Hence, we also define <code class="docutils literal notranslate"><span class="pre">used_identifiers()</span></code> that can extract identifiers directly from the string representation of any Python expression, (including <em>Z3</em> constraints). One trade-off here is that we lose track of the type information. But we will see how to recover that later.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">used_identifiers</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">names</span><span class="p">(</span><span class="n">astnode</span><span class="p">):</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">):</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">left</span><span class="p">))</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">right</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">):</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">operand</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">):</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">left</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">comparators</span><span class="p">:</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">):</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Num</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Str</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">NameConstant</span><span class="p">)):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">astnode</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lst</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">names</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">used_identifiers</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">abs_value_summary</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;v_0&#39;, &#39;x&#39;, &#39;v&#39;, &#39;v_1&#39;]
</pre></div>
</div>
</div>
</div>
<p>We can now register the function summary <code class="docutils literal notranslate"><span class="pre">abs_value</span></code> for later use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">function_summaries</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">function_summaries</span><span class="p">[</span><span class="s1">&#39;abs_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;predicate&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">abs_value_summary</span><span class="p">),</span>
    <span class="s1">&#39;vars&#39;</span><span class="p">:</span> <span class="n">abs_value_declarations</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>As we mentioned previously, we do not want to rely on <em>Z3</em> to extract the type information. A better alternative is to let the user specify the type information as annotations, and extract this information from the program. We will see next how this can be achieved.</p>
<p>First, we convert the <em>Python type to Z3 type</em> map to its string equivalent.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SYM_VARS_STR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">k</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;z3.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v1</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;z3.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v2</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">SYM_VARS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>
<span class="n">SYM_VARS_STR</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;int&#39;: (&#39;z3.Int&#39;, &#39;z3.IntVal&#39;),
 &#39;float&#39;: (&#39;z3.Real&#39;, &#39;z3.RealVal&#39;),
 &#39;str&#39;: (&#39;z3.String&#39;, &#39;z3.StringVal&#39;)}
</pre></div>
</div>
</div>
</div>
<p>We also define a convenience method <code class="docutils literal notranslate"><span class="pre">translate_to_z3_name()</span></code> for accessing the <em>Z3</em> type for symbolic variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">translate_to_z3_name</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">SYM_VARS_STR</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We now define the method <code class="docutils literal notranslate"><span class="pre">declarations()</span></code> that extracts variables used in Python <em>statements</em>. The idea is to look for augmented assignments that contain annotated type information. These are collected and returned.</p>
<p>If there are <code class="docutils literal notranslate"><span class="pre">call</span></code> nodes, they represent function calls. The used variables in these function calls are recovered from the corresponding function summaries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">declarations</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">hm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">hm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hm</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="n">declarations</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">hm</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
        <span class="c1"># hm[astnode.name + &#39;__return__&#39;] = \</span>
        <span class="c1"># translate_to_z3_name(astnode.returns.id)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">hm</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">translate_to_z3_name</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="n">declarations</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">hm</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
        <span class="c1"># get declarations from the function summary.</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">astnode</span><span class="o">.</span><span class="n">function</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>  <span class="c1"># for now.</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">id</span>
        <span class="n">hm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">function_summaries</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;vars&#39;</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
        <span class="n">hm</span><span class="p">[</span><span class="n">astnode</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">translate_to_z3_name</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">):</span>
        <span class="c1"># verify it is already defined</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">hm</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AugAssign</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">astnode</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">hm</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">If</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">For</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">While</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="n">declarations</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">hm</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">orelse</span><span class="p">:</span>
            <span class="n">declarations</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">hm</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">astnode</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hm</span>
</pre></div>
</div>
</div>
</div>
<p>With this, we can now extract the variables used in an expression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">declarations</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;s: int = 3</span><span class="se">\n</span><span class="s1">p: float = 4.0</span><span class="se">\n</span><span class="s1">s += 1&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;s&#39;: &#39;z3.Int&#39;, &#39;p&#39;: &#39;z3.Real&#39;}
</pre></div>
</div>
</div>
</div>
<p>We wrap <code class="docutils literal notranslate"><span class="pre">declarations()</span></code> in the method <code class="docutils literal notranslate"><span class="pre">used_vars()</span></code> that operates directly on function objects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">used_vars</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">declarations</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">fn</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Here is how it can be used:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">used_vars</span><span class="p">(</span><span class="n">check_triangle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: &#39;z3.Int&#39;, &#39;b&#39;: &#39;z3.Int&#39;, &#39;c&#39;: &#39;z3.Int&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">used_vars</span><span class="p">(</span><span class="n">abs_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;x&#39;: &#39;z3.Real&#39;, &#39;v&#39;: &#39;z3.Real&#39;}
</pre></div>
</div>
</div>
</div>
<p>Given the extracted variables and their <em>Z3</em> types, we need a way to re-instantiate them when needed. We define <code class="docutils literal notranslate"><span class="pre">define_symbolic_vars()</span></code> that translates these descriptions to a form that can be directly <code class="docutils literal notranslate"><span class="pre">exec()</span></code>ed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">define_symbolic_vars</span><span class="p">(</span><span class="n">fn_vars</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
    <span class="n">sym_var_dec</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">fn_vars</span><span class="p">])</span>
    <span class="n">sym_var_def</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(&#39;</span><span class="si">%s%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">fn_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sym_var_dec</span><span class="p">,</span> <span class="n">sym_var_def</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here is how it can be used:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">define_symbolic_vars</span><span class="p">(</span><span class="n">abs_value_declarations</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;x, v_0, v, v_1 = z3.Real(&#39;x&#39;), z3.Real(&#39;v_0&#39;), z3.Real(&#39;v&#39;), z3.Real(&#39;v_1&#39;)&quot;
</pre></div>
</div>
</div>
</div>
<p>We next define <code class="docutils literal notranslate"><span class="pre">gen_fn_summary()</span></code> that returns a function summary in instantiable form using <em>Z3</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gen_fn_summary</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">function_summaries</span><span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">][</span><span class="s1">&#39;predicate&#39;</span><span class="p">]</span>
    <span class="n">fn_vars</span> <span class="o">=</span> <span class="n">function_summaries</span><span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">][</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span>
    <span class="n">decl</span> <span class="o">=</span> <span class="n">define_symbolic_vars</span><span class="p">(</span><span class="n">fn_vars</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
    <span class="n">summary_ast</span> <span class="o">=</span> <span class="n">get_expression</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decl</span><span class="p">,</span> <span class="n">to_src</span><span class="p">(</span><span class="n">prefix_vars</span><span class="p">(</span><span class="n">summary_ast</span><span class="p">,</span> <span class="n">prefix</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Here is how it can be used:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gen_fn_summary</span><span class="p">(</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="n">abs_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&quot;a_x, a_v_0, a_v, a_v_1 = z3.Real(&#39;a_x&#39;), z3.Real(&#39;a_v_0&#39;), z3.Real(&#39;a_v&#39;), z3.Real(&#39;a_v_1&#39;)&quot;,
 &#39;z3.Or(z3.And(z3.And(a_x &lt; 0, a_v_0 == -a_x), a_v == a_v_0), z3.And(z3.And(z3.Not(a_x &lt; 0), a_v_1 == a_x), a_v == a_v_1))&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gen_fn_summary</span><span class="p">(</span><span class="s1">&#39;b_&#39;</span><span class="p">,</span> <span class="n">abs_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&quot;b_x, b_v_0, b_v, b_v_1 = z3.Real(&#39;b_x&#39;), z3.Real(&#39;b_v_0&#39;), z3.Real(&#39;b_v&#39;), z3.Real(&#39;b_v_1&#39;)&quot;,
 &#39;z3.Or(z3.And(z3.And(b_x &lt; 0, b_v_0 == -b_x), b_v == b_v_0), z3.And(z3.And(z3.Not(b_x &lt; 0), b_v_1 == b_x), b_v == b_v_1))&#39;)
</pre></div>
</div>
</div>
</div>
<p>How do we use our function summaries? Here is a function <code class="docutils literal notranslate"><span class="pre">abs_max()</span></code> that uses <code class="docutils literal notranslate"><span class="pre">abs_value()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">abs_max</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="n">a1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">abs_value</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">abs_value</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a1</span> <span class="o">&gt;</span> <span class="n">b1</span><span class="p">:</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">a1</span>  <span class="c1"># type: ignore</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">b1</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">c</span>
</pre></div>
</div>
</div>
</div>
<p>To trace this function symbolically, we first define the two variables <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Real</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Real</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">2</span></code> contains definition for <code class="docutils literal notranslate"><span class="pre">a1</span></code>, which we define as a symbolic variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Real</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We also need to call <code class="docutils literal notranslate"><span class="pre">abs_value()</span></code>, which is accomplished as follows. Since this is the first call to <code class="docutils literal notranslate"><span class="pre">abs_value()</span></code>, we use <code class="docutils literal notranslate"><span class="pre">abs1</span></code> as the prefix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">gen_fn_summary</span><span class="p">(</span><span class="s1">&#39;abs1_&#39;</span><span class="p">,</span> <span class="n">abs_value</span><span class="p">)</span>
<span class="n">d</span><span class="p">,</span> <span class="n">v</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&quot;abs1_x, abs1_v_0, abs1_v, abs1_v_1 = z3.Real(&#39;abs1_x&#39;), z3.Real(&#39;abs1_v_0&#39;), z3.Real(&#39;abs1_v&#39;), z3.Real(&#39;abs1_v_1&#39;)&quot;,
 &#39;z3.Or(z3.And(z3.And(abs1_x &lt; 0, abs1_v_0 == -abs1_x), abs1_v == abs1_v_0), z3.And(z3.And(z3.Not(abs1_x &lt; 0), abs1_v_1 == abs1_x), abs1_v == abs1_v_1))&#39;)
</pre></div>
</div>
</div>
</div>
<p>We also need to equate the resulting value (<code class="docutils literal notranslate"><span class="pre">&lt;prefix&gt;_v</span></code>) to the symbolic variable <code class="docutils literal notranslate"><span class="pre">a1</span></code> we defined earlier.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l2_src</span> <span class="o">=</span> <span class="s2">&quot;l2 = z3.And(a == abs1_x, a1 == abs1_v, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">v</span>
<span class="n">l2_src</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;l2 = z3.And(a == abs1_x, a1 == abs1_v, z3.Or(z3.And(z3.And(abs1_x &lt; 0, abs1_v_0 == -abs1_x), abs1_v == abs1_v_0), z3.And(z3.And(z3.Not(abs1_x &lt; 0), abs1_v_1 == abs1_x), abs1_v == abs1_v_1)))&#39;
</pre></div>
</div>
</div>
</div>
<p>Applying both declaration and the assignment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exec</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">exec</span><span class="p">(</span><span class="n">l2_src</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l2</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">a = abs1_x &and;
a1 = abs1_v &and;
(abs1_x &lt; 0 &and; abs1_v_0 = -abs1_x &and; abs1_v = abs1_v_0 &or;
 &not;(abs1_x &lt; 0) &and; abs1_v_1 = abs1_x &and; abs1_v = abs1_v_1)</div></div>
</div>
<p>We need to do the same for <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">3</span></code>, but with <code class="docutils literal notranslate"><span class="pre">abs2</span></code> as the prefix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b1</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Real</span><span class="p">(</span><span class="s1">&#39;b1&#39;</span><span class="p">)</span>
<span class="n">d</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">gen_fn_summary</span><span class="p">(</span><span class="s1">&#39;abs2_&#39;</span><span class="p">,</span> <span class="n">abs_value</span><span class="p">)</span>
<span class="n">l3_src</span> <span class="o">=</span> <span class="s2">&quot;l3_ = z3.And(b == abs2_x, b1 == abs2_v, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">v</span>
<span class="n">exec</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">exec</span><span class="p">(</span><span class="n">l3_src</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l3_</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">b = abs2_x &and;
b1 = abs2_v &and;
(abs2_x &lt; 0 &and; abs2_v_0 = -abs2_x &and; abs2_v = abs2_v_0 &or;
 &not;(abs2_x &lt; 0) &and; abs2_v_1 = abs2_x &and; abs2_v = abs2_v_1)</div></div>
</div>
<p>To get the true set of predicates at <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">3</span></code>, we need to add the predicates from <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">2</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l3</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">l2</span><span class="p">,</span> <span class="n">l3_</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">a = abs1_x &and;
a1 = abs1_v &and;
(abs1_x &lt; 0 &and; abs1_v_0 = -abs1_x &and; abs1_v = abs1_v_0 &or;
 &not;(abs1_x &lt; 0) &and; abs1_v_1 = abs1_x &and; abs1_v = abs1_v_1) &and;
b = abs2_x &and;
b1 = abs2_v &and;
(abs2_x &lt; 0 &and; abs2_v_0 = -abs2_x &and; abs2_v = abs2_v_0 &or;
 &not;(abs2_x &lt; 0) &and; abs2_v_1 = abs2_x &and; abs2_v = abs2_v_1)</div></div>
</div>
<p>This equation can be simplified a bit using z3.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z3</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">l3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">a = abs1_x &and;
a1 = abs1_v &and;
(&not;(0 &le; abs1_x) &and; abs1_v_0 = -1&middot;abs1_x &and; abs1_v = abs1_v_0 &or;
 0 &le; abs1_x &and; abs1_v_1 = abs1_x &and; abs1_v = abs1_v_1) &and;
b = abs2_x &and;
b1 = abs2_v &and;
(&not;(0 &le; abs2_x) &and; abs2_v_0 = -1&middot;abs2_x &and; abs2_v = abs2_v_0 &or;
 0 &le; abs2_x &and; abs2_v_1 = abs2_x &and; abs2_v = abs2_v_1)</div></div>
</div>
<p>Coming to <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">4</span></code>, we have a condition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l4_cond</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">&gt;</span> <span class="n">b1</span>
<span class="n">l4</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">l3</span><span class="p">,</span> <span class="n">l4_cond</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">5</span></code>, we define the symbolic variable <code class="docutils literal notranslate"><span class="pre">c_0</span></code> assuming we took the <em>IF</em> branch.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c_0</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Real</span><span class="p">(</span><span class="s1">&#39;c_0&#39;</span><span class="p">)</span>
<span class="n">l5</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">l4</span><span class="p">,</span> <span class="n">c_0</span> <span class="o">==</span> <span class="n">a1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">6</span></code>, the <em>ELSE</em> branch was taken. So we invert that condition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l6</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">l3</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">Not</span><span class="p">(</span><span class="n">l4_cond</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">line:</span> <span class="pre">7</span></code>, we define <code class="docutils literal notranslate"><span class="pre">c_1</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c_1</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Real</span><span class="p">(</span><span class="s1">&#39;c_1&#39;</span><span class="p">)</span>
<span class="n">l7</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">l6</span><span class="p">,</span> <span class="n">c_1</span> <span class="o">==</span> <span class="n">b1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s1</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Solver</span><span class="p">()</span>
<span class="n">s1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l5</span><span class="p">)</span>
<span class="n">s1</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><b>sat</b></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m1</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
<span class="nb">sorted</span><span class="p">([(</span><span class="n">d</span><span class="p">,</span> <span class="n">m1</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">m1</span><span class="o">.</span><span class="n">decls</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">(</span>
<span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;abs&#39;</span><span class="p">)],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(a, 1/2), (a1, 1/2), (b, -1/4), (b1, 1/4), (c_0, 1/2)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s2</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Solver</span><span class="p">()</span>
<span class="n">s2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l7</span><span class="p">)</span>
<span class="n">s2</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><b>sat</b></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m2</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
<span class="nb">sorted</span><span class="p">([(</span><span class="n">d</span><span class="p">,</span> <span class="n">m2</span><span class="p">[</span><span class="n">d</span><span class="p">])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">m2</span><span class="o">.</span><span class="n">decls</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">(</span>
<span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;abs&#39;</span><span class="p">)],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(a, -1/2), (a1, 1/2), (b, 1/2), (b1, 1/2), (c_1, 1/2)]
</pre></div>
</div>
</div>
</div>
<p>What we really want to do is to automate this process, because doing this by hand is tedious and error-prone. Essentially, we want the ability to extract <em>all paths</em> in the program, and symbolically execute each path, which will generate the inputs required to cover all reachable portions of the program.</p>
</section>
</section>
</section>
<section id="simple-symbolic-fuzzing">
<h2>Simple Symbolic Fuzzing<a class="headerlink" href="#simple-symbolic-fuzzing" title="Link to this heading">#</a></h2>
<p>We define a simple <em>symbolic fuzzer</em> that can generate input values <em>symbolically</em> with the following assumptions:</p>
<ul class="simple">
<li><p>There are no loops in the program</p></li>
<li><p>The function is self-contained.</p></li>
<li><p>No recursion.</p></li>
<li><p>No reassignments for variables.</p></li>
</ul>
<p>The key idea is as follows: We traverse through the control flow graph from the entry point, and generate all possible paths to a given depth. Then we collect constraints that we encountered along the path, and generate inputs that will traverse the program up to that point.</p>
<p>We build our fuzzer based on the class <code class="docutils literal notranslate"><span class="pre">Fuzzer</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Fuzzer</span> <span class="kn">import</span> <span class="n">Fuzzer</span>
</pre></div>
</div>
</div>
</div>
<p>We start by extracting the control flow graph of the function passed. We also provide a hook for child classes to do their processing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">Fuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple symbolic fuzzer&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `fn` is the function to be fuzzed.</span>
<span class="sd">        Possible keyword parameters:</span>
<span class="sd">        * `max_depth` - the depth to which one should attempt</span>
<span class="sd">          to trace the execution (default 100) </span>
<span class="sd">        * `max_tries` - the maximum number of attempts</span>
<span class="sd">          we will try to produce a value before giving up (default 100)</span>
<span class="sd">        * `max_iter` - the number of iterations we will attempt (default 100).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn_name</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">py_cfg</span> <span class="o">=</span> <span class="n">PyCFG</span><span class="p">()</span>
        <span class="n">py_cfg</span><span class="o">.</span><span class="n">gen_cfg</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnenter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnexit</span> <span class="o">=</span> <span class="n">py_cfg</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fn_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">used_variables</span> <span class="o">=</span> <span class="n">used_vars</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z3</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Solver</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>  <span class="c1"># to be defined later</span>
</pre></div>
</div>
</div>
</div>
<p>We need a few variables to control how much we are willing to traverse.</p>
<p><code class="docutils literal notranslate"><span class="pre">MAX_DEPTH</span></code> is the depth to which one should attempt to trace the execution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MAX_DEPTH</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">MAX_TRIES</span></code> is the maximum number of attempts we will try to produce a value before giving up.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MAX_TRIES</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">MAX_ITER</span></code> is the number of iterations we will attempt.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MAX_ITER</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">options()</span></code> method sets these parameters in the fuzzing class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">SimpleSymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_depth&#39;</span><span class="p">,</span> <span class="n">MAX_DEPTH</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_tries&#39;</span><span class="p">,</span> <span class="n">MAX_TRIES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_iter&#39;</span><span class="p">,</span> <span class="n">MAX_ITER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_options</span> <span class="o">=</span> <span class="n">kwargs</span>
</pre></div>
</div>
</div>
</div>
<p>The initialization generates a control flow graph and hooks it to <code class="docutils literal notranslate"><span class="pre">fnenter</span></code> and <code class="docutils literal notranslate"><span class="pre">fnexit</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">symfz_ct</span> <span class="o">=</span> <span class="n">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">check_triangle</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">symfz_ct</span><span class="o">.</span><span class="n">fnenter</span><span class="p">,</span> <span class="n">symfz_ct</span><span class="o">.</span><span class="n">fnexit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(id:9 line[1] parents: [] : enter: check_triangle(a, b, c),
 id:10 line[1] parents: [14, 15, 16, 19, 20, 21] : exit: check_triangle(a, b, c))
</pre></div>
</div>
</div>
</div>
<section id="generating-all-possible-paths">
<h3>Generating All Possible Paths<a class="headerlink" href="#generating-all-possible-paths" title="Link to this heading">#</a></h3>
<p>We can use the procedure <code class="docutils literal notranslate"><span class="pre">get_all_paths()</span></code> starting from <code class="docutils literal notranslate"><span class="pre">fnenter</span></code> to recursively retrieve all paths in the function.</p>
<p>The idea is as follows: Start with the function entry point <code class="docutils literal notranslate"><span class="pre">fnenter</span></code>, and recursively follow the children using the CFG. At any node there is a branching, there would be multiple children. On other nodes there would be only one child. Let us say a node had <span class="math notranslate nohighlight">\(n\)</span> children. Such a node would result in <span class="math notranslate nohighlight">\(n\)</span> paths. We attach the current node to the head of each path, and return all paths thus generated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">SimpleSymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_all_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fenter</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Maximum depth exceeded&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fenter</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[[(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fenter</span><span class="p">)]]</span>

        <span class="n">fnpaths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fenter</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
            <span class="n">child_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_paths</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">child_paths</span><span class="p">:</span>
                <span class="c1"># In a conditional branch, idx is 0 for IF, and 1 for Else</span>
                <span class="n">fnpaths</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">idx</span><span class="p">,</span> <span class="n">fenter</span><span class="p">)]</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fnpaths</span>
</pre></div>
</div>
</div>
</div>
<p>This can be used as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">symfz_ct</span> <span class="o">=</span> <span class="n">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">check_triangle</span><span class="p">)</span>
<span class="n">all_paths</span> <span class="o">=</span> <span class="n">symfz_ct</span><span class="o">.</span><span class="n">get_all_paths</span><span class="p">(</span><span class="n">symfz_ct</span><span class="o">.</span><span class="n">fnenter</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">all_paths</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(0, id:24 line[1] parents: [] : enter: check_triangle(a, b, c)),
 (0, id:26 line[2] parents: [24] : _if: a == b),
 (0, id:27 line[3] parents: [26] : _if: a == c),
 (1, id:28 line[4] parents: [27] : _if: b == c),
 (0, id:30 line[7] parents: [28] : return &#39;Isosceles&#39;),
 (0,
  id:25 line[1] parents: [29, 30, 31, 34, 35, 36] : exit: check_triangle(a, b, c))]
</pre></div>
</div>
</div>
</div>
<p>We hook <code class="docutils literal notranslate"><span class="pre">get_all_paths()</span></code> to initialization as below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">SimpleSymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fnenter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_path</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="extracting-all-constraints">
<h3>Extracting All Constraints<a class="headerlink" href="#extracting-all-constraints" title="Link to this heading">#</a></h3>
<p>For any given path, we define a function <code class="docutils literal notranslate"><span class="pre">extract_constraints()</span></code> to extract the constraints such that they are executable directly with <em>Z3</em>. The <code class="docutils literal notranslate"><span class="pre">idx</span></code> represents the particular branch that was taken. Hence, if the <code class="docutils literal notranslate"><span class="pre">False</span></code> branch was taken in a conditional, we attach a negation of the conditional.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">SimpleSymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">extract_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">predicates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">elt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="o">.</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">elt</span><span class="o">.</span><span class="n">ast_node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;_if&#39;</span><span class="p">,</span> <span class="s1">&#39;_while&#39;</span><span class="p">}:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">to_src</span><span class="p">(</span><span class="n">elt</span><span class="o">.</span><span class="n">ast_node</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
                    <span class="n">predicates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;z3.Not(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="o">.</span><span class="n">ast_node</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">elt</span><span class="o">.</span><span class="n">ast_node</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn_name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">elt</span><span class="o">.</span><span class="n">ast_node</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Eq</span><span class="p">()],</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                    <span class="n">predicates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_src</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elt</span><span class="o">.</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">elt</span><span class="o">.</span><span class="n">ast_node</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Eq</span><span class="p">()],</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
                <span class="n">predicates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_src</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">predicates</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">symfz_ct</span> <span class="o">=</span> <span class="n">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">check_triangle</span><span class="p">)</span>
<span class="n">all_paths</span> <span class="o">=</span> <span class="n">symfz_ct</span><span class="o">.</span><span class="n">get_all_paths</span><span class="p">(</span><span class="n">symfz_ct</span><span class="o">.</span><span class="n">fnenter</span><span class="p">)</span>
<span class="n">symfz_ct</span><span class="o">.</span><span class="n">extract_constraints</span><span class="p">(</span><span class="n">all_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;a == b&#39;, &#39;a == c&#39;, &#39;b == c&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">constraints</span> <span class="o">=</span> <span class="n">symfz_ct</span><span class="o">.</span><span class="n">extract_constraints</span><span class="p">(</span><span class="n">all_paths</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">constraints</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;a == b&#39;, &#39;a == c&#39;, &#39;z3.Not(b == c)&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="fuzzing-with-simple-symbolic-fuzzer">
<h3>Fuzzing with Simple Symbolic Fuzzer<a class="headerlink" href="#fuzzing-with-simple-symbolic-fuzzer" title="Link to this heading">#</a></h3>
<p>To actually generate solutions, we define <code class="docutils literal notranslate"><span class="pre">fuzz()</span></code>. For that, we need to first extract all paths. Then choose a particular path, and extract the constraints in that path, which is then solved using <em>z3</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
</pre></div>
</div>
</div>
</div>
<p>First we create a checkpoint for our current solver so that we can check a predicate, and rollback if necessary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">checkpoint</span><span class="p">(</span><span class="n">z3solver</span><span class="p">):</span>
    <span class="n">z3solver</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">z3solver</span>
    <span class="n">z3solver</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">use_path()</span></code> function extracts constraints for a single function, applies it to our current solver (under a checkpoint), and returns the results if some solutions can be found.
If solutions were found, we also make sure that we never reuse those solutions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">SimpleSymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">solve_path_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="c1"># re-initializing does not seem problematic.</span>
        <span class="c1"># a = z3.Int(&#39;a&#39;).get_id() remains the same.</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_constraints</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">decl</span> <span class="o">=</span> <span class="n">define_symbolic_vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">used_variables</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">decl</span><span class="p">)</span>

        <span class="n">solutions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="n">checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z3</span><span class="p">):</span>
            <span class="n">st</span> <span class="o">=</span> <span class="s1">&#39;self.z3.add(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
            <span class="nb">eval</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">z3</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">!=</span> <span class="n">z3</span><span class="o">.</span><span class="n">sat</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z3</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
            <span class="n">solutions</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">():</span> <span class="n">m</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">decls</span><span class="p">()}</span>
            <span class="n">my_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">solutions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn_args</span><span class="p">}</span>
        <span class="n">predicate</span> <span class="o">=</span> <span class="s1">&#39;z3.And(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> == </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">my_args</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.z3.add(z3.Not(</span><span class="si">%s</span><span class="s1">))&#39;</span> <span class="o">%</span> <span class="n">predicate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">my_args</span>
</pre></div>
</div>
</div>
</div>
<p>We define <code class="docutils literal notranslate"><span class="pre">get_path()</span></code> that retrieves the current path and updates the path used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">SimpleSymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_next_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_path</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_path</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_path</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_path</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">fuzz()</span></code> method simply solves each path in order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">SimpleSymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">fuzz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce one solution for each path.</span>
<span class="sd">        Returns a mapping of variable names to (symbolic) Z3 values.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_path_constraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_next_path</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">res</span>

        <span class="k">return</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
</div>
<p>The fuzzer can be used as follows. Note that we need to convert the symbolic variables returned to Python numbers, using <code class="docutils literal notranslate"><span class="pre">as_long()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<span class="n">symfz_ct</span> <span class="o">=</span> <span class="n">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">check_triangle</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">symfz_ct</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">check_triangle</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_long</span><span class="p">(),</span>
                         <span class="n">args</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_long</span><span class="p">(),</span>
                         <span class="n">args</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_long</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: 2, &#39;b&#39;: 3, &#39;c&#39;: 3} result: Isosceles
{&#39;a&#39;: 6, &#39;b&#39;: 4, &#39;c&#39;: 5} result: Scalene
{&#39;a&#39;: 8, &#39;b&#39;: 7, &#39;c&#39;: 8} result: Isosceles
{&#39;a&#39;: 9, &#39;b&#39;: 9, &#39;c&#39;: 10} result: Isosceles
{&#39;a&#39;: 11, &#39;b&#39;: 11, &#39;c&#39;: 11} result: Equilateral
{&#39;a&#39;: 13, &#39;b&#39;: 12, &#39;c&#39;: 12} result: Isosceles
{&#39;a&#39;: 16, &#39;b&#39;: 14, &#39;c&#39;: 15} result: Scalene
{&#39;a&#39;: 18, &#39;b&#39;: 17, &#39;c&#39;: 18} result: Isosceles
{&#39;a&#39;: 19, &#39;b&#39;: 19, &#39;c&#39;: 20} result: Isosceles
</pre></div>
</div>
</div>
</div>
<p>For symbolic fractions, we access their numerators and denominators:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">symfz_av</span> <span class="o">=</span> <span class="n">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">abs_value</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">symfz_av</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="n">abs_res</span> <span class="o">=</span> <span class="n">abs_value</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">numerator_as_long</span><span class="p">()</span> <span class="o">/</span>
                        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">denominator_as_long</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="n">abs_res</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;x&#39;: 0} result: 0.0
{&#39;x&#39;: -1/2} result: 0.5
{&#39;x&#39;: 1/2} result: 0.5
{&#39;x&#39;: -1/4} result: 0.25
{&#39;x&#39;: 1/4} result: 0.25
{&#39;x&#39;: -3/8} result: 0.375
{&#39;x&#39;: 1/8} result: 0.125
{&#39;x&#39;: -3/2} result: 1.5
{&#39;x&#39;: 1/16} result: 0.0625
</pre></div>
</div>
</div>
</div>
<p>The <em>SimpleSymbolicFuzzer</em> seems to work well for the <em>simple</em> programs we checked above.</p>
</section>
<section id="problems-with-the-simple-fuzzer">
<h3>Problems with the Simple Fuzzer<a class="headerlink" href="#problems-with-the-simple-fuzzer" title="Link to this heading">#</a></h3>
<p>As we mentioned earlier, the <code class="docutils literal notranslate"><span class="pre">SimpleSymbolicFuzzer</span></code> cannot yet deal with variable reassignments. Further, it also fails to account for any loops. For example, consider the following program.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">a</span>  <span class="c1"># type: ignore</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>

    <span class="k">while</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">a</span>  <span class="c1"># type: ignore</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">b</span>

    <span class="k">return</span> <span class="n">a</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_cfg</span><span class="p">(</span><span class="n">gcd</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3e9e9a23e905ac9f726d13ee1f2b22aa1cff4f4027d660efc93a063332b43cdf.svg" src="_images/3e9e9a23e905ac9f726d13ee1f2b22aa1cff4f4027d660efc93a063332b43cdf.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ExpectError</span> <span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">symfz_gcd</span> <span class="o">=</span> <span class="n">SimpleSymbolicFuzzer</span><span class="p">(</span><span class="n">gcd</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">symfz_gcd</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_long</span><span class="p">(),</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_long</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_16239/3731434224.py&quot;, line 2, in &lt;module&gt;
    symfz_gcd = SimpleSymbolicFuzzer(gcd, max_depth=1000, max_iter=10)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_16239/2089833100.py&quot;, line 26, in __init__
    self.process()
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_16239/4234366425.py&quot;, line 3, in process
    self.paths = self.get_all_paths(self.fnenter)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_16239/228300930.py&quot;, line 10, in get_all_paths
    child_paths = self.get_all_paths(child, depth + 1)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_16239/228300930.py&quot;, line 10, in get_all_paths
    child_paths = self.get_all_paths(child, depth + 1)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_16239/228300930.py&quot;, line 10, in get_all_paths
    child_paths = self.get_all_paths(child, depth + 1)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  [Previous line repeated 998 more times]
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_16239/228300930.py&quot;, line 4, in get_all_paths
    raise Exception(&#39;Maximum depth exceeded&#39;)
Exception: Maximum depth exceeded (expected)
</pre></div>
</div>
</div>
</div>
<p>The problem here is that our <em>SimpleSymbolicFuzzer</em> has no concept of loops and variable reassignments. We will see how to fix this shortcoming next.</p>
</section>
</section>
<section id="advanced-symbolic-fuzzing">
<h2>Advanced Symbolic Fuzzing<a class="headerlink" href="#advanced-symbolic-fuzzing" title="Link to this heading">#</a></h2>
<p>We next define <code class="docutils literal notranslate"><span class="pre">SymbolicFuzzer</span></code> that can deal with reassignments and <em>unrolling of loops</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SymbolicFuzzer</span><span class="p">(</span><span class="n">SimpleSymbolicFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Symbolic fuzzing with reassignments and loop unrolling&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once we allow reassignments and loop unrolling, we have to deal with what to call the new variables generated. This is what we will tackle next.</p>
<section id="dealing-with-reassignments">
<h3>Dealing with Reassignments<a class="headerlink" href="#dealing-with-reassignments" title="Link to this heading">#</a></h3>
<p>We want to rename all variables present in an expression such that the variables are annotated with their usage count. This makes it possible to determine variable reassignments.  To do that, we define the <code class="docutils literal notranslate"><span class="pre">rename_variables()</span></code> function that, when given an <code class="docutils literal notranslate"><span class="pre">env</span></code> that contains the current usage index of different variables, renames the variables in the passed AST node with the annotations, and returns a copy with the modifications. Note that we can’t use <a class="reference external" href="https://docs.python.org/3/library/ast.html#ast.NodeTransformer">NodeTransformer</a> here as it would modify the AST.</p>
<p>That is, if the expression is <code class="docutils literal notranslate"><span class="pre">env[v]</span> <span class="pre">==</span> <span class="pre">1</span></code>, <code class="docutils literal notranslate"><span class="pre">v</span></code> is renamed to <code class="docutils literal notranslate"><span class="pre">_v_1</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rename_variables</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BoolOp</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;z3.And&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">And</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;z3.Or&#39;</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">[</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> <span class="p">[])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">(</span>
            <span class="n">rename_variables</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">env</span><span class="p">),</span> <span class="n">astnode</span><span class="o">.</span><span class="n">op</span><span class="p">,</span>
            <span class="n">rename_variables</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Not</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;z3.Not&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">[</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">operand</span><span class="p">,</span> <span class="n">env</span><span class="p">)],</span> <span class="p">[])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnaryOp</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">op</span><span class="p">,</span>
                               <span class="n">rename_variables</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">operand</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">func</span><span class="p">,</span>
                        <span class="p">[</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">args</span><span class="p">],</span>
                        <span class="n">astnode</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span>
            <span class="n">rename_variables</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">env</span><span class="p">),</span> <span class="n">astnode</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span>
            <span class="p">[</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">astnode</span><span class="o">.</span><span class="n">comparators</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">astnode</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="n">astnode</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="n">astnode</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">num</span><span class="p">),</span> <span class="n">astnode</span><span class="o">.</span><span class="n">ctx</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">astnode</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">astnode</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">astnode</span>
</pre></div>
</div>
</div>
</div>
<p>To verify that it works as intended, we start with an environment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ba</span> <span class="o">=</span> <span class="n">get_expression</span><span class="p">(</span><span class="s1">&#39;x == 1 and y == 2&#39;</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">ba</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ast.BoolOp
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">to_src</span><span class="p">(</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;z3.And(_x_1 == 1, _y_0 == 2)&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bo</span> <span class="o">=</span> <span class="n">get_expression</span><span class="p">(</span><span class="s1">&#39;x == 1 or y == 2&#39;</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">bo</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ast.Or
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">to_src</span><span class="p">(</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;z3.Or(_x_1 == 1, _y_0 == 2)&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">get_expression</span><span class="p">(</span><span class="s1">&#39;x + y&#39;</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ast.BinOp
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">to_src</span><span class="p">(</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;_x_1 + _y_0&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">get_expression</span><span class="p">(</span><span class="s1">&#39;-y&#39;</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ast.UnaryOp
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">to_src</span><span class="p">(</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;-_y_0&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">un</span> <span class="o">=</span> <span class="n">get_expression</span><span class="p">(</span><span class="s1">&#39;not y&#39;</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">un</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ast.Not
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">to_src</span><span class="p">(</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">un</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;z3.Not(_y_0)&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">get_expression</span><span class="p">(</span><span class="s1">&#39;x == y&#39;</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ast.Compare
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">to_src</span><span class="p">(</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;_x_1 == _y_0&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">get_expression</span><span class="p">(</span><span class="s1">&#39;fn(x,y)&#39;</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ast.Call
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">to_src</span><span class="p">(</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">env</span><span class="p">))</span> <span class="o">==</span> <span class="s1">&#39;fn(_x_1, _y_0)&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;x&#39;: 1, &#39;y&#39;: 0}
</pre></div>
</div>
</div>
</div>
<p>Next, we want to process the CFG, and correctly transform the paths.</p>
</section>
<section id="tracking-assignments">
<h3>Tracking Assignments<a class="headerlink" href="#tracking-assignments" title="Link to this heading">#</a></h3>
<p>For keeping track of assignments in the CFG, We define a data structure <code class="docutils literal notranslate"><span class="pre">PNode</span></code> that stores the current CFG node.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PNode</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cfgnode</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">seen</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">seen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">MAX_ITER</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfgnode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cfgnode</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">order</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;PNode:</span><span class="si">%d</span><span class="s2">[</span><span class="si">%s</span><span class="s2"> order:</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfgnode</span><span class="p">),</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Defining a new <code class="docutils literal notranslate"><span class="pre">PNode</span></code> is done as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span> <span class="o">=</span> <span class="n">PyCFG</span><span class="p">()</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">gen_cfg</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">gcd</span><span class="p">))</span>
<span class="n">gcd_fnenter</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="s1">&#39;gcd&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gcd_fnenter</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PNode:0[id:27 line[1] parents: [] : enter: gcd(a, b) order:0]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">copy()</span></code> method generates a copy for the child’s keep, indicating which path was taken (with <code class="docutils literal notranslate"><span class="pre">order</span></code> of the child).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PNode</span><span class="p">(</span><span class="n">PNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">PNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfgnode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="n">order</span>
        <span class="k">return</span> <span class="n">p</span>
</pre></div>
</div>
</div>
</div>
<p>Using the copy operation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gcd_fnenter</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PNode:0[id:27 line[1] parents: [] : enter: gcd(a, b) order:1]
</pre></div>
</div>
</div>
</div>
<section id="stepwise-exploration-of-paths">
<h4>Stepwise Exploration of Paths<a class="headerlink" href="#stepwise-exploration-of-paths" title="Link to this heading">#</a></h4>
<p>A problem we had with our <code class="docutils literal notranslate"><span class="pre">SimpleSymbolicFuzzer</span></code> is that it explored a path to completion before attempting another. However, this is non-optimal. One may want to explore the graph in a more step-wise manner, expanding every possible execution one step at a time.</p>
<p>Hence, we define <code class="docutils literal notranslate"><span class="pre">explore()</span></code> which explores the children of a node if any, one step at a time. If done exhaustively, this will generate all paths from a starting node until no more children are left. We made <code class="docutils literal notranslate"><span class="pre">PNode</span></code> to a container class so that this iteration can be driven from outside, and stopped if say a maximum iteration is complete, or certain paths need to be prioritized.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PNode</span><span class="p">(</span><span class="n">PNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">explore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfgnode</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">]</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">ccount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ccount</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># drop this child</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ccount</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">pn</span> <span class="o">=</span> <span class="n">PNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">seen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seen</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
</pre></div>
</div>
</div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">explore()</span></code> as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gcd_fnenter</span><span class="p">)</span><span class="o">.</span><span class="n">explore</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[PNode:1[id:29 line[2] parents: [27] : _if: a &lt; b order:0]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gcd_fnenter</span><span class="p">)</span><span class="o">.</span><span class="n">explore</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">explore</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[PNode:2[id:30 line[3] parents: [29] : c: int = a order:0],
 PNode:2[id:33 line[7] parents: [32, 29, 36] : _while: b != 0 order:0]]
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">get_path_to_root()</span></code> recursively goes up through child-&gt;parent chain retrieving the complete chain to the topmost parent.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PNode</span><span class="p">(</span><span class="n">PNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_path_to_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">while</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">PNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gcd_fnenter</span><span class="p">)</span>
<span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">get_path_to_root</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">explore</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">explore</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">explore</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">explore</span><span class="p">()]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[PNode:0[id:27 line[1] parents: [] : enter: gcd(a, b) order:0],
  PNode:1[id:29 line[2] parents: [27] : _if: a &lt; b order:0],
  PNode:2[id:30 line[3] parents: [29] : c: int = a order:0],
  PNode:3[id:31 line[4] parents: [30] : a = b order:0],
  PNode:4[id:32 line[5] parents: [31] : b = c order:0]]]
</pre></div>
</div>
</div>
</div>
<p>The string representation of the node is in <code class="docutils literal notranslate"><span class="pre">z3</span></code> solvable form.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PNode</span><span class="p">(</span><span class="n">PNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_path_to_root</span><span class="p">()</span>
        <span class="n">ssa_path</span> <span class="o">=</span> <span class="n">to_single_assignment_predicates</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">to_src</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ssa_path</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>However, before using it, we need to take care of variable renaming so that reassignments can work.</p>
</section>
<section id="renaming-used-variables">
<h4>Renaming Used Variables<a class="headerlink" href="#renaming-used-variables" title="Link to this heading">#</a></h4>
<p>We need to rename used variables. Any variable <code class="docutils literal notranslate"><span class="pre">v</span> <span class="pre">=</span> <span class="pre">xxx</span></code> should be renamed to <code class="docutils literal notranslate"><span class="pre">_v_0</span></code> and any later assignment such as <code class="docutils literal notranslate"><span class="pre">v</span> <span class="pre">=</span> <span class="pre">v</span> <span class="pre">+</span> <span class="pre">1</span></code> should be transformed to <code class="docutils literal notranslate"><span class="pre">_v_1</span> <span class="pre">=</span> <span class="pre">_v_0</span> <span class="pre">+</span> <span class="pre">1</span></code> and later conditionals such as <code class="docutils literal notranslate"><span class="pre">v</span> <span class="pre">==</span> <span class="pre">x</span></code> should be transformed to <code class="docutils literal notranslate"><span class="pre">(_v_1</span> <span class="pre">==</span> <span class="pre">_x_0)</span></code>. The method <code class="docutils literal notranslate"><span class="pre">to_single_assignment_predicates()</span></code> does this for a given path.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">to_single_assignment_predicates</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">new_path</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">ast_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">cfgnode</span><span class="o">.</span><span class="n">ast_node</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="p">{</span>
                <span class="s1">&#39;exit&#39;</span><span class="p">}:</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;enter&#39;</span><span class="p">}:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> == _</span><span class="si">%s</span><span class="s2">_0&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;z3.And&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">args</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;_if&#39;</span><span class="p">,</span> <span class="s1">&#39;_while&#39;</span><span class="p">}:</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="n">rename_variables</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">order</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="n">new_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;z3.Not&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">[</span><span class="n">new_node</span><span class="p">],</span> <span class="p">[])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AnnAssign</span><span class="p">):</span>
            <span class="n">assigned</span> <span class="o">=</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span>
            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">env</span><span class="p">)]</span>
            <span class="n">env</span><span class="p">[</span><span class="n">assigned</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">assigned</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span> <span class="k">else</span> <span class="n">env</span><span class="p">[</span><span class="n">assigned</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="n">assigned</span><span class="p">]),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Eq</span><span class="p">()],</span> <span class="n">val</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">):</span>
            <span class="n">assigned</span> <span class="o">=</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">rename_variables</span><span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">env</span><span class="p">)]</span>
            <span class="n">env</span><span class="p">[</span><span class="n">assigned</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">assigned</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span> <span class="k">else</span> <span class="n">env</span><span class="p">[</span><span class="n">assigned</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">ast_node</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="n">assigned</span><span class="p">]),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">Eq</span><span class="p">()],</span> <span class="n">val</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ast_node</span><span class="p">,</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Pass</span><span class="p">)):</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;NI </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ast_node</span><span class="p">),</span> <span class="n">ast_node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">new_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_path</span>
</pre></div>
</div>
</div>
</div>
<p>Here is how it can be used:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">PNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gcd_fnenter</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">explore</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">explore</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">explore</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_path_to_root</span><span class="p">()</span>
<span class="n">spath</span> <span class="o">=</span> <span class="n">to_single_assignment_predicates</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">to_src</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spath</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;z3.And(a == _a_0, b == _b_0)&#39;, &#39;_a_0 &lt; _b_0&#39;, &#39;_c_0 == _a_0&#39;, &#39;_a_1 == _b_0&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="check-before-you-loop">
<h4>Check Before You Loop<a class="headerlink" href="#check-before-you-loop" title="Link to this heading">#</a></h4>
<p>One of the ways in which the <em>concolic</em> execution simplifies <em>symbolic</em> execution is in the treatment of loops. Rather than trying to determine an invariant for a loop, we simply <em>unroll</em> the loops a number of times until we hit the <code class="docutils literal notranslate"><span class="pre">MAX_DEPTH</span></code> limit.
However, not all loops will need to be unrolled until <code class="docutils literal notranslate"><span class="pre">MAX_DEPTH</span></code> is reached. Some of them may exit before. Hence, it is necessary to check whether the given set of constraints can be satisfied before continuing to explore further.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">identifiers_with_types</span><span class="p">(</span><span class="n">identifiers</span><span class="p">,</span> <span class="n">defined</span><span class="p">):</span>
    <span class="n">with_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">defined</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
            <span class="n">nxt</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nxt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">defined</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">defined</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">with_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">typ</span>
    <span class="k">return</span> <span class="n">with_types</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">extract_constraints()</span></code> generates the <code class="docutils literal notranslate"><span class="pre">z3</span></code> constraints from a path. The main work is done by <code class="docutils literal notranslate"><span class="pre">to_single_assignment_predicates()</span></code>. The <code class="docutils literal notranslate"><span class="pre">extract_constraints()</span></code> then converts the AST to source.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SymbolicFuzzer</span><span class="p">(</span><span class="n">SymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">extract_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">to_src</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">to_single_assignment_predicates</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="solving-path-constraints">
<h3>Solving Path Constraints<a class="headerlink" href="#solving-path-constraints" title="Link to this heading">#</a></h3>
<p>We now update our <code class="docutils literal notranslate"><span class="pre">solve_path_constraint()</span></code> method to take into account the new identifiers created during reassignments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SymbolicFuzzer</span><span class="p">(</span><span class="n">SymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">solve_path_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="c1"># re-initializing does not seem problematic.</span>
        <span class="c1"># a = z3.Int(&#39;a&#39;).get_id() remains the same.</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_constraints</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">c</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">constraints</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">used_identifiers</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>  <span class="c1"># &lt;- changes</span>
        <span class="n">with_types</span> <span class="o">=</span> <span class="n">identifiers_with_types</span><span class="p">(</span>
            <span class="n">identifiers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_variables</span><span class="p">)</span>  <span class="c1"># &lt;- changes</span>
        <span class="n">decl</span> <span class="o">=</span> <span class="n">define_symbolic_vars</span><span class="p">(</span><span class="n">with_types</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">decl</span><span class="p">)</span>

        <span class="n">solutions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="n">checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z3</span><span class="p">):</span>
            <span class="n">st</span> <span class="o">=</span> <span class="s1">&#39;self.z3.add(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
            <span class="nb">eval</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">z3</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">!=</span> <span class="n">z3</span><span class="o">.</span><span class="n">sat</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z3</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
            <span class="n">solutions</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">():</span> <span class="n">m</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">decls</span><span class="p">()}</span>
            <span class="n">my_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">solutions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn_args</span><span class="p">}</span>

        <span class="n">predicate</span> <span class="o">=</span> <span class="s1">&#39;z3.And(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> == </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">my_args</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;self.z3.add(z3.Not(</span><span class="si">%s</span><span class="s1">))&#39;</span> <span class="o">%</span> <span class="n">predicate</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">my_args</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="generating-all-paths">
<h3>Generating All Paths<a class="headerlink" href="#generating-all-paths" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">get_all_paths()</span></code> is now similarly updated so that we unroll loops only to a specified height. It is also converted to an iterative exploration style so that we explore the CFG in a breadth first manner.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SymbolicFuzzer</span><span class="p">(</span><span class="n">SymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_all_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fenter</span><span class="p">):</span>
        <span class="n">path_lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">PNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fenter</span><span class="p">)]</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">):</span>
            <span class="n">new_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">PNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fenter</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_lst</span><span class="p">:</span>
                <span class="c1"># explore each path once</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">cfgnode</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">np</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">explore</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">np</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">new_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">completed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">path_lst</span> <span class="o">=</span> <span class="n">new_paths</span>
        <span class="k">return</span> <span class="n">completed</span> <span class="o">+</span> <span class="n">path_lst</span>
</pre></div>
</div>
</div>
</div>
<p>We can now obtain all paths using our advanced symbolic fuzzer as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">asymfz_gcd</span> <span class="o">=</span> <span class="n">SymbolicFuzzer</span><span class="p">(</span>
    <span class="n">gcd</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">all_paths</span> <span class="o">=</span> <span class="n">asymfz_gcd</span><span class="o">.</span><span class="n">get_all_paths</span><span class="p">(</span><span class="n">asymfz_gcd</span><span class="o">.</span><span class="n">fnenter</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">all_paths</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>38
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_paths</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span><span class="o">.</span><span class="n">get_path_to_root</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[PNode:0[id:40 line[1] parents: [] : enter: gcd(a, b) order:0],
 PNode:1[id:42 line[2] parents: [40] : _if: a &lt; b order:1],
 PNode:2[id:46 line[7] parents: [45, 42, 49] : _while: b != 0 order:0],
 PNode:3[id:47 line[8] parents: [46] : c: int = a order:0],
 PNode:4[id:48 line[9] parents: [47] : a = b order:0],
 PNode:5[id:49 line[10] parents: [48] : b = c % b order:0],
 PNode:6[id:46 line[7] parents: [45, 42, 49] : _while: b != 0 order:0],
 PNode:7[id:47 line[8] parents: [46] : c: int = a order:0],
 PNode:8[id:48 line[9] parents: [47] : a = b order:0],
 PNode:9[id:49 line[10] parents: [48] : b = c % b order:0],
 PNode:10[id:46 line[7] parents: [45, 42, 49] : _while: b != 0 order:0]]
</pre></div>
</div>
</div>
</div>
<p>We can also list the predicates in each path.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">to_single_assignment_predicates</span><span class="p">(</span><span class="n">all_paths</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span><span class="o">.</span><span class="n">get_path_to_root</span><span class="p">()):</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">to_src</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>z3.And(a == _a_0, b == _b_0)
z3.Not(_a_0 &lt; _b_0)
_b_0 != 0
_c_0 == _a_0
_a_1 == _b_0
_b_1 == _c_0 % _b_0
_b_1 != 0
_c_1 == _a_1
_a_2 == _b_1
_b_2 == _c_1 % _b_1
_b_2 != 0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">constraints</span> <span class="o">=</span> <span class="n">asymfz_gcd</span><span class="o">.</span><span class="n">extract_constraints</span><span class="p">(</span><span class="n">all_paths</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span><span class="o">.</span><span class="n">get_path_to_root</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">constraints</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;z3.And(a == _a_0, b == _b_0)&#39;,
 &#39;z3.Not(_a_0 &lt; _b_0)&#39;,
 &#39;_b_0 != 0&#39;,
 &#39;_c_0 == _a_0&#39;,
 &#39;_a_1 == _b_0&#39;,
 &#39;_b_1 == _c_0 % _b_0&#39;,
 &#39;_b_1 != 0&#39;,
 &#39;_c_1 == _a_1&#39;,
 &#39;_a_2 == _b_1&#39;,
 &#39;_b_2 == _c_1 % _b_1&#39;,
 &#39;_b_2 != 0&#39;]
</pre></div>
</div>
</div>
</div>
<p>The constraints printed out demonstrates that our approach for renaming variables was successful. We need only one more piece to complete the puzzle. Our path is still a <code class="docutils literal notranslate"><span class="pre">PNode</span></code>. We need to modify <code class="docutils literal notranslate"><span class="pre">get_next_path()</span></code> so that we return the corresponding predicate chain.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SymbolicFuzzer</span><span class="p">(</span><span class="n">SymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_next_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_path</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_path</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_path</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_path</span><span class="p">]</span><span class="o">.</span><span class="n">get_path_to_root</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We will see next how to use our fuzzer for fuzzing.</p>
</section>
<section id="fuzzing-with-advanced-symbolic-fuzzer">
<h3>Fuzzing with Advanced Symbolic Fuzzer<a class="headerlink" href="#fuzzing-with-advanced-symbolic-fuzzer" title="Link to this heading">#</a></h3>
<p>We use our advanced symbolic fuzzer on <em>gcd</em> to generate plausible inputs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">asymfz_gcd</span> <span class="o">=</span> <span class="n">SymbolicFuzzer</span><span class="p">(</span>
    <span class="n">gcd</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">asymfz_gcd</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_long</span><span class="p">(),</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()))</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: 8, &#39;b&#39;: 3} result: 1
{&#39;a&#39;: 1, &#39;b&#39;: 2} result: 1
{&#39;a&#39;: 2, &#39;b&#39;: 5} result: 1
{&#39;a&#39;: 5, &#39;b&#39;: 2} result: 1
{&#39;a&#39;: 3, &#39;b&#39;: 4} result: 1
{&#39;a&#39;: 9, &#39;b&#39;: 9} result: 9
{&#39;a&#39;: 7, &#39;b&#39;: 6} result: 1
{&#39;a&#39;: 5, &#39;b&#39;: 10} result: 5
{&#39;a&#39;: 3, &#39;b&#39;: 1} result: 1
{&#39;a&#39;: 10, &#39;b&#39;: 7} result: 1
</pre></div>
</div>
</div>
</div>
<p>The outputs look reasonable. However, what is the coverage obtained?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">VisualizedArcCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov</span><span class="o">.</span><span class="n">show_coverage</span><span class="p">(</span><span class="n">gcd</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>#  1: def gcd(a: int, b: int) -&gt; int:
#  2:     if a &lt; b:
#  3:         c: int = a  # type: ignore
#  4:         a = b
#  5:         b = c
   6: 
#  7:     while b != 0:
#  8:         c: int = a  # type: ignore
#  9:         a = b
# 10:         b = c % b
  11: 
# 12:     return a
  13: 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">show_cfg</span><span class="p">(</span><span class="n">gcd</span><span class="p">,</span> <span class="n">arcs</span><span class="o">=</span><span class="n">cov</span><span class="o">.</span><span class="n">arcs</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b7b0916a60ec16da5e2f94ef40be344fd218cd67ead8a274c9bc3915905a88d8.svg" src="_images/b7b0916a60ec16da5e2f94ef40be344fd218cd67ead8a274c9bc3915905a88d8.svg" />
</div>
</div>
<p>Indeed, both branch and statement coverage visualization seems to indicate that we achieved complete coverage.
How do we make use of our fuzzer in practice? We explore a small case study of a program to solve the roots of a quadratic equation.</p>
<section id="example-roots-of-a-quadratic-equation">
<h4>Example: Roots of a Quadratic Equation<a class="headerlink" href="#example-roots-of-a-quadratic-equation" title="Link to this heading">#</a></h4>
<p>Here is the famous equation for finding the roots of a quadratic equation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">roots</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="n">d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span>
    <span class="n">ax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">d</span>
    <span class="n">bx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">ax</span> <span class="o">-</span> <span class="n">bx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
        <span class="n">bx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">ax</span> <span class="o">+</span> <span class="n">d</span> <span class="o">/</span> <span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">bx</span>

    <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">bx</span>
    <span class="n">a2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a</span>
    <span class="n">ba2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a2</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">ba2</span> <span class="o">+</span> <span class="n">s</span> <span class="o">/</span> <span class="n">a2</span><span class="p">,</span> <span class="o">-</span><span class="n">ba2</span> <span class="o">-</span> <span class="n">s</span> <span class="o">/</span> <span class="n">a2</span>
</pre></div>
</div>
</div>
</div>
<p>Does the program look correct? Let us investigate if the program is reasonable. But before that, we need a helper
function <code class="docutils literal notranslate"><span class="pre">sym_to_float()</span></code> to convert symbolic values to floating point.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sym_to_float</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">z3</span><span class="o">.</span><span class="n">IntNumRef</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">as_long</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">numerator_as_long</span><span class="p">()</span> <span class="o">/</span> <span class="n">v</span><span class="o">.</span><span class="n">denominator_as_long</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now we are ready to fuzz.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">asymfz_roots</span> <span class="o">=</span> <span class="n">SymbolicFuzzer</span><span class="p">(</span>
    <span class="n">roots</span><span class="p">,</span>
    <span class="n">max_tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">asymfz_roots</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">sym_to_float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">roots</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: 11/10, &#39;b&#39;: 0, &#39;c&#39;: -1/2}
[1.1, 0.0, -0.5] (0.7045454545454545, -0.7045454545454545)
{&#39;a&#39;: 0, &#39;b&#39;: 58617/131072, &#39;c&#39;: -1/2}
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_16239/94617992.py&quot;, line 6, in &lt;module&gt;
    v = roots(*d)
        ^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_16239/2299859991.py&quot;, line 11, in roots
    ba2: float = b / a2
                 ~~^~~~
ZeroDivisionError: float division by zero (expected)
</pre></div>
</div>
</div>
</div>
<p>We have a <code class="docutils literal notranslate"><span class="pre">ZeroDivisionError</span></code>. Can we eliminate it?</p>
<section id="roots-check-before-divide">
<h5>Roots - Check Before Divide<a class="headerlink" href="#roots-check-before-divide" title="Link to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">roots2</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="n">d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span>

    <span class="n">xa</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">d</span>
    <span class="n">xb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">xa</span> <span class="o">-</span> <span class="n">xb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
        <span class="n">xb</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">xa</span> <span class="o">+</span> <span class="n">d</span> <span class="o">/</span> <span class="n">xa</span><span class="p">)</span>
        <span class="n">xa</span> <span class="o">=</span> <span class="n">xb</span>

    <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">xb</span>

    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span> <span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span> <span class="n">b</span>  <span class="c1"># only one solution</span>

    <span class="n">a2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a</span>
    <span class="n">ba2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a2</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ba2</span> <span class="o">+</span> <span class="n">s</span> <span class="o">/</span> <span class="n">a2</span><span class="p">,</span> <span class="o">-</span><span class="n">ba2</span> <span class="o">-</span> <span class="n">s</span> <span class="o">/</span> <span class="n">a2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">asymfz_roots</span> <span class="o">=</span> <span class="n">SymbolicFuzzer</span><span class="p">(</span>
    <span class="n">roots2</span><span class="p">,</span>
    <span class="n">max_tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">asymfz_roots</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">sym_to_float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">roots2</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">)</span>
        <span class="c1">#print(d, v)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_16239/567876003.py&quot;, line 5, in &lt;module&gt;
    v = roots2(*d)
        ^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_16239/714795544.py&quot;, line 13, in roots2
    return -c / b, -c / b  # only one solution
           ~~~^~~
ZeroDivisionError: float division by zero (expected)
</pre></div>
</div>
</div>
</div>
<p>Apparently, our fix was incomplete. Let us try again.</p>
</section>
<section id="roots-eliminating-the-zero-division-error">
<h5>Roots - Eliminating the Zero Division Error<a class="headerlink" href="#roots-eliminating-the-zero-division-error" title="Link to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">roots3</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="n">d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span>

    <span class="n">xa</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">d</span>
    <span class="n">xb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">xa</span> <span class="o">-</span> <span class="n">xb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
        <span class="n">xb</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">xa</span> <span class="o">+</span> <span class="n">d</span> <span class="o">/</span> <span class="n">xa</span><span class="p">)</span>
        <span class="n">xa</span> <span class="o">=</span> <span class="n">xb</span>
    <span class="n">s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">xb</span>

    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span> <span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span> <span class="n">b</span>  <span class="c1"># only one solution</span>

    <span class="n">a2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a</span>
    <span class="n">ba2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">b</span> <span class="o">/</span> <span class="n">a2</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ba2</span> <span class="o">+</span> <span class="n">s</span> <span class="o">/</span> <span class="n">a2</span><span class="p">,</span> <span class="o">-</span><span class="n">ba2</span> <span class="o">-</span> <span class="n">s</span> <span class="o">/</span> <span class="n">a2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">asymfz_roots</span> <span class="o">=</span> <span class="n">SymbolicFuzzer</span><span class="p">(</span>
    <span class="n">roots3</span><span class="p">,</span>
    <span class="n">max_tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">asymfz_roots</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">sym_to_float</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">roots3</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: -1, &#39;b&#39;: 0, &#39;c&#39;: 0}
[-1.0, 0.0, 0.0] (0.0, 0.0)
{&#39;a&#39;: -11/20, &#39;b&#39;: 0, &#39;c&#39;: 1}
[-0.55, 0.0, 1.0] (-1.409090909090909, 1.409090909090909)
{&#39;a&#39;: -1/40, &#39;b&#39;: 0, &#39;c&#39;: 2}
[-0.025, 0.0, 2.0] (0.0, 0.0)
{&#39;a&#39;: 0, &#39;b&#39;: -1/4, &#39;c&#39;: 3}
[0.0, -0.25, 3.0] (12.0, 12.0)
{&#39;a&#39;: 0, &#39;b&#39;: 0, &#39;c&#39;: 4}
[0.0, 0.0, 4.0] (inf, inf)
{&#39;a&#39;: 0, &#39;b&#39;: -777645/524288, &#39;c&#39;: 5}
[0.0, -1.4832401275634766, 5.0] (3.370998334715712, 3.370998334715712)
{&#39;a&#39;: -2/91, &#39;b&#39;: 0, &#39;c&#39;: 91/40}
[-0.02197802197802198, 0.0, 2.275] (0.0, 0.0)
{&#39;a&#39;: 0, &#39;b&#39;: 4/9, &#39;c&#39;: 6}
[0.0, 0.4444444444444444, 6.0] (-13.5, -13.5)
{&#39;a&#39;: 0, &#39;b&#39;: 0, &#39;c&#39;: 7}
[0.0, 0.0, 7.0] (inf, inf)
{&#39;a&#39;: -7/6, &#39;b&#39;: -1, &#39;c&#39;: 3/2}
[-1.1666666666666667, -1.0, 1.5] (-1.7142857142857142, 0.857142857142857)
</pre></div>
</div>
</div>
</div>
<p>With this, we have demonstrated that we can use our <em>SymbolicFuzzer</em> to fuzz programs, and it can aid in identifying problems in code.</p>
</section>
</section>
</section>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Link to this heading">#</a></h2>
<p>There is an evident error in the <code class="docutils literal notranslate"><span class="pre">roots3()</span></code> function. We are not checking for negative roots. However, the symbolic execution does not seem to have detected it. Why are we not able to detect the problem of negative roots? Because we stop execution at a predetermined depth without throwing an error. That is, our symbolic execution is wide but shallow. One of the ways this limitation can be overcome is by relying on <a class="reference internal" href="ConcolicFuzzer.html"><span class="std std-doc">concolic execution</span></a>, that allows one to go deeper than pure symbolic execution.</p>
<p>A second problem is that symbolic execution is necessarily computation intensive. This means that specification based fuzzers are often able to generate a much larger set of inputs, and consecutively more coverage on programs that do not check for magic bytes, such that they provide a reasonable gradient of exploration.</p>
</section>
<section id="id1">
<h2>Synopsis<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>This chapter provides an implementation of a symbolic fuzzing engine <code class="docutils literal notranslate"><span class="pre">SymbolicFuzzer</span></code>. The fuzzer uses symbolic execution to exhaustively explore paths in the program to a limited depth, and generate inputs that will reach these paths.</p>
<p>As an example, consider the function <code class="docutils literal notranslate"><span class="pre">gcd()</span></code>, computing the greatest common divisor of <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="kn">from</span> <span class="nn">bookutils</span> <span class="kn">import</span> <span class="n">print_content</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">print_content</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">gcd</span><span class="p">),</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span> <span class=" -Color -Color-Green">gcd</span>(a: <span class=" -Color -Color-Cyan">int</span>, b: <span class=" -Color -Color-Cyan">int</span>) -&gt; <span class=" -Color -Color-Cyan">int</span>:
    <span class=" -Color -Color-Blue">if</span> a &lt; b:
        c: <span class=" -Color -Color-Cyan">int</span> = a  <span class=" -Color -Color-White"># type: ignore</span>
        a = b
        b = c

    <span class=" -Color -Color-Blue">while</span> b != <span class=" -Color -Color-Blue">0</span>:
        c: <span class=" -Color -Color-Cyan">int</span> = a  <span class=" -Color -Color-White"># type: ignore</span>
        a = b
        b = c % b

    <span class=" -Color -Color-Blue">return</span> a
</pre></div>
</div>
</div>
</div>
<p>To explore <code class="docutils literal notranslate"><span class="pre">gcd()</span></code>, the fuzzer can be used as follows, producing values for arguments that cover different paths in <code class="docutils literal notranslate"><span class="pre">gcd()</span></code> (including multiple times of loop iterations):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gcd_fuzzer</span> <span class="o">=</span> <span class="n">SymbolicFuzzer</span><span class="p">(</span><span class="n">gcd</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">gcd_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: 8, &#39;b&#39;: 3}
{&#39;a&#39;: 1, &#39;b&#39;: 2}
{&#39;a&#39;: 2, &#39;b&#39;: 5}
{&#39;a&#39;: 7, &#39;b&#39;: 6}
{&#39;a&#39;: 9, &#39;b&#39;: 10}
{&#39;a&#39;: 4, &#39;b&#39;: 4}
{&#39;a&#39;: 10, &#39;b&#39;: 9}
{&#39;a&#39;: 2, &#39;b&#39;: 10}
{&#39;a&#39;: 14, &#39;b&#39;: 7}
{&#39;a&#39;: 3, &#39;b&#39;: 2}
</pre></div>
</div>
</div>
</div>
<p>Note that the variable values returned by <code class="docutils literal notranslate"><span class="pre">fuzz()</span></code> are Z3 <em>symbolic</em> values; to convert them to Python numbers, use their method <code class="docutils literal notranslate"><span class="pre">as_long()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">gcd_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_long</span><span class="p">()</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gcd(</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>gcd(0, 8) = 8
gcd(-1, 10) = -1
gcd(13, 2) = 1
gcd(0, 10) = 10
gcd(6, 7) = 1
gcd(14, 2) = 2
gcd(-1, 11) = -1
gcd(15, 0) = 15
gcd(0, -1) = -1
gcd(-3, -2) = -1
</pre></div>
</div>
</div>
</div>
<p>The symbolic fuzzer is subject to a number of constraints. First, it requires that the function to be fuzzed has correct type annotations, including all local variables. Second, it solves loops by unrolling them, but only for a fixed amount.</p>
<p>For programs without loops and variable reassignments, the <code class="docutils literal notranslate"><span class="pre">SimpleSymbolicFuzzer</span></code> is a faster, but more limited alternative.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="kn">from</span> <span class="nn">ClassDiagram</span> <span class="kn">import</span> <span class="n">display_class_hierarchy</span>
<span class="n">display_class_hierarchy</span><span class="p">(</span><span class="n">SymbolicFuzzer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="300pt" height="402pt"
 viewBox="0.00 0.00 300.00 401.75" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 397.75)">
<g id="a_graph0"><a xlink:title="SymbolicFuzzer class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-397.75 296,-397.75 296,4 -4,4"/>
</a>
</g>
<!-- SymbolicFuzzer -->
<g id="node1" class="node">
<title>SymbolicFuzzer</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class SymbolicFuzzer:&#10;Symbolic fuzzing with reassignments and loop unrolling">
<polygon fill="none" stroke="black" points="0.38,-0.5 0.38,-98.25 154.38,-98.25 154.38,-0.5 0.38,-0.5"/>
<text text-anchor="start" x="28.62" y="-81.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">SymbolicFuzzer</text>
<polyline fill="none" stroke="black" points="0.38,-72.25 154.38,-72.25"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="SymbolicFuzzer">
<g id="a_node1_1"><a xlink:href="#" xlink:title="extract_constraints(self, path)">
<text text-anchor="start" x="8.38" y="-59.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">extract_constraints()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="get_all_paths(self, fenter)">
<text text-anchor="start" x="8.38" y="-47" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">get_all_paths()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="get_next_path(self)">
<text text-anchor="start" x="8.38" y="-34.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">get_next_path()</text>
</a>
</g>
<g id="a_node1_4"><a xlink:href="#" xlink:title="options(self, kwargs)">
<text text-anchor="start" x="8.38" y="-21.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">options()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="solve_path_constraint(self, path)">
<text text-anchor="start" x="8.38" y="-8.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">solve_path_constraint()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- SimpleSymbolicFuzzer -->
<g id="node2" class="node">
<title>SimpleSymbolicFuzzer</title>
<g id="a_node2"><a xlink:href="#" xlink:title="class SimpleSymbolicFuzzer:&#10;Simple symbolic fuzzer">
<polygon fill="none" stroke="black" points="0,-135.25 0,-271.25 154.75,-271.25 154.75,-135.25 0,-135.25"/>
<text text-anchor="start" x="8" y="-254.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">SimpleSymbolicFuzzer</text>
<polyline fill="none" stroke="black" points="0,-245.25 154.75,-245.25"/>
<g id="a_node2_6"><a xlink:href="#" xlink:title="SimpleSymbolicFuzzer">
<g id="a_node2_7"><a xlink:href="#" xlink:title="__init__(self, fn, **kwargs):&#10;Constructor.&#10;`fn` is the function to be fuzzed.&#10;Possible keyword parameters:&#10;* `max_depth` &#45; the depth to which one should attempt&#10;to trace the execution (default 100)&#10;* `max_tries` &#45; the maximum number of attempts&#10;we will try to produce a value before giving up (default 100)&#10;* `max_iter` &#45; the number of iterations we will attempt (default 100).">
<text text-anchor="start" x="8.38" y="-232.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node2_8"><a xlink:href="#" xlink:title="fuzz(self):&#10;Produce one solution for each path.&#10;Returns a mapping of variable names to (symbolic) Z3 values.">
<text text-anchor="start" x="8.38" y="-220" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node2_9"><a xlink:href="#" xlink:title="extract_constraints(self, path)">
<text text-anchor="start" x="8.38" y="-207.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">extract_constraints()</text>
</a>
</g>
<g id="a_node2_10"><a xlink:href="#" xlink:title="get_all_paths(self, fenter, depth=0)">
<text text-anchor="start" x="8.38" y="-194.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">get_all_paths()</text>
</a>
</g>
<g id="a_node2_11"><a xlink:href="#" xlink:title="get_next_path(self)">
<text text-anchor="start" x="8.38" y="-181.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">get_next_path()</text>
</a>
</g>
<g id="a_node2_12"><a xlink:href="#" xlink:title="options(self, kwargs)">
<text text-anchor="start" x="8.38" y="-169" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">options()</text>
</a>
</g>
<g id="a_node2_13"><a xlink:href="#" xlink:title="process(self)">
<text text-anchor="start" x="8.38" y="-155.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">process()</text>
</a>
</g>
<g id="a_node2_14"><a xlink:href="#" xlink:title="solve_path_constraint(self, path)">
<text text-anchor="start" x="8.38" y="-143.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">solve_path_constraint()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- SymbolicFuzzer&#45;&gt;SimpleSymbolicFuzzer -->
<g id="edge1" class="edge">
<title>SymbolicFuzzer&#45;&gt;SimpleSymbolicFuzzer</title>
<path fill="none" stroke="black" d="M77.38,-98.43C77.38,-106.47 77.38,-114.99 77.38,-123.55"/>
<polygon fill="none" stroke="black" points="73.88,-123.29 77.38,-133.29 80.88,-123.29 73.88,-123.29"/>
</g>
<!-- Fuzzer -->
<g id="node3" class="node">
<title>Fuzzer</title>
<g id="a_node3"><a xlink:href="Fuzzer.ipynb" xlink:title="class Fuzzer:&#10;Base class for fuzzers.">
<polygon fill="none" stroke="black" points="39.38,-308.25 39.38,-393.25 115.38,-393.25 115.38,-308.25 39.38,-308.25"/>
<text text-anchor="start" x="56.75" y="-376.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Fuzzer</text>
<polyline fill="none" stroke="black" points="39.38,-367.25 115.38,-367.25"/>
<g id="a_node3_15"><a xlink:href="#" xlink:title="Fuzzer">
<g id="a_node3_16"><a xlink:href="Fuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="47.38" y="-354.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node3_17"><a xlink:href="Fuzzer.ipynb" xlink:title="fuzz(self) &#45;&gt; str:&#10;Return fuzz input">
<text text-anchor="start" x="47.38" y="-342" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node3_18"><a xlink:href="Fuzzer.ipynb" xlink:title="run(self, runner: Fuzzer.Runner = &lt;Fuzzer.Runner object at 0x11249e490&gt;) &#45;&gt; Tuple[subprocess.CompletedProcess, str]:&#10;Run `runner` with fuzz input">
<text text-anchor="start" x="47.38" y="-329.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">run()</text>
</a>
</g>
<g id="a_node3_19"><a xlink:href="Fuzzer.ipynb" xlink:title="runs(self, runner: Fuzzer.Runner = &lt;Fuzzer.PrintRunner object at 0x1124c6610&gt;, trials: int = 10) &#45;&gt; List[Tuple[subprocess.CompletedProcess, str]]:&#10;Run `runner` with fuzz input, `trials` times">
<text text-anchor="start" x="47.38" y="-316.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">runs()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- SimpleSymbolicFuzzer&#45;&gt;Fuzzer -->
<g id="edge2" class="edge">
<title>SimpleSymbolicFuzzer&#45;&gt;Fuzzer</title>
<path fill="none" stroke="black" d="M77.38,-271.46C77.38,-279.97 77.38,-288.57 77.38,-296.81"/>
<polygon fill="none" stroke="black" points="73.88,-296.65 77.38,-306.65 80.88,-296.65 73.88,-296.65"/>
</g>
<!-- Legend -->
<g id="node4" class="node">
<title>Legend</title>
<text text-anchor="start" x="172.75" y="-65.38" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text text-anchor="start" x="172.75" y="-55.38" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="178.75" y="-55.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="172.75" y="-45.38" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="178.75" y="-45.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="172.75" y="-35.38" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="178.75" y="-35.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="172.75" y="-26.32" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>One can use symbolic execution to augment the inputs that explore all characteristics of a program.</p></li>
<li><p>Symbolic execution can be broad but shallow.</p></li>
<li><p>Symbolic execution is well suited for programs that rely on specific values to be present in the input, however, its utility decreases when such values are not present, and the input space represents a gradient in terms of coverage.</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="SearchBasedFuzzer.html"><span class="std std-doc">Search based fuzzing</span></a> can often be an acceptable middle ground when random fuzzing does not provide sufficient results, but symbolic fuzzing is too heavyweight.</p></li>
</ul>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>Symbolic execution of programs was originally described by King \cite{king1976symbolic} in 1976. It is used extensively in vulnerability analysis of software, especially binary programs. Some well known symbolic execution tools include <em>KLEE</em> \cite{KLEE}, <em>angr</em> \cite{wang2017angr}, <em>Driller</em> \cite{stephens2016driller}, and <em>SAGE</em> \cite{godefroid2012sage}. The best known symbolic execution environment for Python is CHEF \cite{bucur2014prototyping} which does symbolic execution by modifying the interpreter.</p>
<p>The Z3 solver we use in this chapter was developed at Microsoft Research under the lead of Leonardo de Moura and Nikolaj Bjørner \cite{z3}. It is one of the most popular solvers.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-extending-symbolic-fuzzer-to-use-function-summaries">
<h3>Exercise 1: Extending Symbolic Fuzzer to use function summaries<a class="headerlink" href="#exercise-1-extending-symbolic-fuzzer-to-use-function-summaries" title="Link to this heading">#</a></h3>
<p>We showed in the first section how function summaries may be produced. Can you extend the <code class="docutils literal notranslate"><span class="pre">SymbolicFuzzer</span></code> to use function summaries when needed?</p>
<p><strong>Solution.</strong> <em>None yet available.</em></p>
</section>
<section id="exercise-2-statically-checking-if-a-loop-should-be-unrolled-further">
<h3>Exercise 2: Statically checking if a loop should be unrolled further<a class="headerlink" href="#exercise-2-statically-checking-if-a-loop-should-be-unrolled-further" title="Link to this heading">#</a></h3>
<p>We examined how loops would be unrolled during exploration to a fixed depth. However, not all loops need to be unrolled completely. Some loops may contain only a constant number of iterations. For example, consider the loop below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>This loop needs to be unrolled exactly <span class="math notranslate nohighlight">\(10\)</span> times. For such cases, can you implement a method <code class="docutils literal notranslate"><span class="pre">can_be_satisfied()</span></code> which is invoked as below, to only unroll further if the path condition can be satisfied.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SymbolicFuzzer</span><span class="p">(</span><span class="n">SymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_all_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fenter</span><span class="p">):</span>
        <span class="n">path_lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">PNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fenter</span><span class="p">)]</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">):</span>
            <span class="n">new_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">PNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fenter</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_lst</span><span class="p">:</span>
                <span class="c1"># explore each path once</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">cfgnode</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">np</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">explore</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">np</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_be_satisfied</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                            <span class="n">new_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">completed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">path_lst</span> <span class="o">=</span> <span class="n">new_paths</span>
        <span class="k">return</span> <span class="n">completed</span> <span class="o">+</span> <span class="n">path_lst</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Solution.</strong> Here is a solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SymbolicFuzzer</span><span class="p">(</span><span class="n">SymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">can_be_satisfied</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_constraints</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">get_path_to_root</span><span class="p">())</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Solver</span><span class="p">()</span>
        <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s2</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">used_identifiers</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="n">with_types</span> <span class="o">=</span> <span class="n">identifiers_with_types</span><span class="p">(</span><span class="n">identifiers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">used_variables</span><span class="p">)</span>
        <span class="n">decl</span> <span class="o">=</span> <span class="n">define_symbolic_vars</span><span class="p">(</span><span class="n">with_types</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">decl</span><span class="p">)</span>
        <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;s.add(z3.And(</span><span class="si">%s</span><span class="s2">))&quot;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s2</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">==</span> <span class="n">z3</span><span class="o">.</span><span class="n">sat</span>
</pre></div>
</div>
</div>
</div>
<p>With this implementation, new conditions are appended to paths if and only if the paths are still satisfiable after incorporating the condition.</p>
</section>
<section id="exercise-3-implementing-a-concolic-fuzzer">
<h3>Exercise 3: Implementing a Concolic Fuzzer<a class="headerlink" href="#exercise-3-implementing-a-concolic-fuzzer" title="Link to this heading">#</a></h3>
<p>We have seen in the chapter on <a class="reference internal" href="ConcolicFuzzer.html"><span class="std std-doc">concolic fuzzing</span></a> how to trace a function concolically using information flow. However, this is somewhat suboptimal as the constraints can get dropped when the information flow is indirect (as in control flow based information flow). Can you implement concolic tracing using the infrastructure we built for symbolic execution?</p>
<p><strong>Solution.</strong> Here is a possible solution.</p>
<p>In <em>concolic execution</em>, we rely on a seed input to guide our symbolic execution. We collect the line numbers that our seed input traces, and feed it to the symbolic execution such that in the <code class="docutils literal notranslate"><span class="pre">explore</span></code> step, only the child node that correspond to the seed input execution path is chosen. This allows us to collect the complete set of constraints along a <em>representative path</em>. Once we have it, we can choose any particular predicate and invert it to explore the program execution paths near the representative path.</p>
<p>We modify our original <code class="docutils literal notranslate"><span class="pre">ArcCoverage</span></code> to provide <em>all</em> line numbers that the program traversed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TrackingArcCoverage</span><span class="p">(</span><span class="n">ArcCoverage</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">offsets_from_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="n">zero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">l</span> <span class="o">-</span> <span class="n">zero</span> <span class="k">for</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span> <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">fn</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">TrackingArcCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="n">roots3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov</span><span class="o">.</span><span class="n">offsets_from_entry</span><span class="p">(</span><span class="s1">&#39;roots3&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 4, 5, 6, 9, 11, 16, 17, 18]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ConcolicTracer</span></code> first extracts the program trace on a seed input.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ConcolicTracer</span><span class="p">(</span><span class="n">SymbolicFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">fnargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">TrackingArcCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
            <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">fnargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">offsets_from_entry</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">get_all_paths()</span></code> now tries to follow the seed execution path.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ConcolicTracer</span><span class="p">(</span><span class="n">ConcolicTracer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_all_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fenter</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">fenter</span><span class="o">.</span><span class="n">ast_node</span><span class="o">.</span><span class="n">lineno</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">last_node</span> <span class="o">=</span> <span class="n">PNode</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fenter</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">last_node</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">last_node</span><span class="o">.</span><span class="n">cfgnode</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">np</span> <span class="o">=</span> <span class="n">last_node</span><span class="o">.</span><span class="n">explore</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">np</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">]</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">cfgnode</span><span class="o">.</span><span class="n">ast_node</span><span class="o">.</span><span class="n">lineno</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">last_node</span> <span class="o">=</span> <span class="n">p</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_node</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">last_node</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We are now ready to concolically trace our execution.</p>
<section id="tracing-the-execution-concolically">
<h4>Tracing the Execution Concolically<a class="headerlink" href="#tracing-the-execution-concolically" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acfz_roots</span> <span class="o">=</span> <span class="n">ConcolicTracer</span><span class="p">(</span>
    <span class="n">roots3</span><span class="p">,</span>
    <span class="n">fnargs</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">max_tries</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acfz_roots</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_path_to_root</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[PNode:0[id:75 line[1] parents: [] : enter: roots3(a, b, c) order:0],
 PNode:1[id:77 line[2] parents: [75] : d: float = b * b - 4 * a * c order:0],
 PNode:2[id:78 line[4] parents: [77] : xa: float = 0.5 * d order:0],
 PNode:3[id:79 line[5] parents: [78] : xb: float = 0 order:0],
 PNode:4[id:80 line[6] parents: [79, 82] : _while: xa - xb &gt; 0.1 order:1],
 PNode:5[id:83 line[9] parents: [80] : s: float = xb order:0],
 PNode:6[id:84 line[11] parents: [83] : _if: a == 0 order:1],
 PNode:7[id:88 line[16] parents: [84] : a2: float = 2 * a order:0],
 PNode:8[id:89 line[17] parents: [88] : ba2: float = b / a2 order:0],
 PNode:9[id:90 line[18] parents: [89] : return (-ba2 + s / a2, -ba2 - s / a2) order:0]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">offsets_from_entry</span><span class="p">(</span><span class="s1">&#39;roots3&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">cfgnode</span><span class="o">.</span><span class="n">ast_node</span><span class="o">.</span><span class="n">lineno</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">acfz_roots</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_path_to_root</span><span class="p">()])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">acfz_roots</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 4, 5, 6, 9, 11, 16, 17, 18]
[1, 2, 4, 5, 6, 9, 11, 16, 17, 18]
[1, 2, 4, 5, 6, 9, 11, 16, 17, 18]
</pre></div>
</div>
</div>
</div>
<p>As can be seen above, we recovered the trace information correctly.
Next, we extract the constraints as usual.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">constraints</span> <span class="o">=</span> <span class="n">acfz_roots</span><span class="o">.</span><span class="n">extract_constraints</span><span class="p">(</span>
    <span class="n">acfz_roots</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_path_to_root</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">constraints</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;z3.And(a == _a_0, b == _b_0, c == _c_0)&#39;,
 &#39;_d_0 == _b_0 * _b_0 - 4 * _a_0 * _c_0&#39;,
 &#39;_xa_0 == 0.5 * _d_0&#39;,
 &#39;_xb_0 == 0&#39;,
 &#39;z3.Not(_xa_0 - _xb_0 &gt; 0.1)&#39;,
 &#39;_s_0 == _xb_0&#39;,
 &#39;z3.Not(_a_0 == 0)&#39;,
 &#39;_a2_0 == 2 * _a_0&#39;,
 &#39;_ba2_0 == _b_0 / _a2_0&#39;]
</pre></div>
</div>
</div>
</div>
<p>Next, we change our constraints to symbolic variables and solve them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">constraints</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">used_identifiers</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
<span class="n">with_types</span> <span class="o">=</span> <span class="n">identifiers_with_types</span><span class="p">(</span><span class="n">identifiers</span><span class="p">,</span> <span class="n">acfz_roots</span><span class="o">.</span><span class="n">used_variables</span><span class="p">)</span>
<span class="n">decl</span> <span class="o">=</span> <span class="n">define_symbolic_vars</span><span class="p">(</span><span class="n">with_types</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">exec</span><span class="p">(</span><span class="n">decl</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We are ready to solve our constraints. However, before that, here is a question for you.
<em>Should it result in exactly the same arguments?</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;z3.solve(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">constraints</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[a = 1,
 _a_0 = 1,
 _b_0 = 1/8,
 _c_0 = 1,
 _ba2_0 = 1/16,
 _a2_0 = 2,
 _s_0 = 0,
 _xb_0 = 0,
 _xa_0 = -255/128,
 _d_0 = -255/64,
 c = 1,
 b = 1/8,
 /0 = [(1/8, 2) -&gt; 1/16, else -&gt; 0]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">acfz_roots</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;a&#39;: -1, &#39;b&#39;: 0, &#39;c&#39;: 0}
</pre></div>
</div>
</div>
</div>
<p>Did they take the same path?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ArcCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="n">roots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">show_cfg</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">arcs</span><span class="o">=</span><span class="n">cov</span><span class="o">.</span><span class="n">arcs</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e2207ea21ccf92101bfce7f3fea6fdf21f7001372720f793e9b947be5c059758.svg" src="_images/e2207ea21ccf92101bfce7f3fea6fdf21f7001372720f793e9b947be5c059758.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ArcCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="n">roots</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">show_cfg</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">arcs</span><span class="o">=</span><span class="n">cov</span><span class="o">.</span><span class="n">arcs</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e2207ea21ccf92101bfce7f3fea6fdf21f7001372720f793e9b947be5c059758.svg" src="_images/e2207ea21ccf92101bfce7f3fea6fdf21f7001372720f793e9b947be5c059758.svg" />
</div>
</div>
<p>Indeed, even though the arguments were different, the path traced is exactly the same.</p>
<p>As we saw in the chapter on <a class="reference internal" href="ConcolicFuzzer.html"><span class="std std-doc">concolic fuzzing</span></a>, concolic tracing has another use, namely that we can use it to explore nearby paths. We will see how to do that next.</p>
</section>
<section id="exploring-nearby-paths">
<h4>Exploring Nearby Paths<a class="headerlink" href="#exploring-nearby-paths" title="Link to this heading">#</a></h4>
<p>We collected the following constraints.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">constraints</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;z3.And(a == _a_0, b == _b_0, c == _c_0)&#39;,
 &#39;_d_0 == _b_0 * _b_0 - 4 * _a_0 * _c_0&#39;,
 &#39;_xa_0 == 0.5 * _d_0&#39;,
 &#39;_xb_0 == 0&#39;,
 &#39;z3.Not(_xa_0 - _xb_0 &gt; 0.1)&#39;,
 &#39;_s_0 == _xb_0&#39;,
 &#39;z3.Not(_a_0 == 0)&#39;,
 &#39;_a2_0 == 2 * _a_0&#39;,
 &#39;_ba2_0 == _b_0 / _a2_0&#39;]
</pre></div>
</div>
</div>
</div>
<p>We can explore nearby paths by negating the conditionals starting from the very last. (A question for the student: Why do we want to start negating from the very last?)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_constraints</span> <span class="o">=</span> <span class="n">constraints</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;z3.Not(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">constraints</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_constraints</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;z3.And(a == _a_0, b == _b_0, c == _c_0)&#39;,
 &#39;_d_0 == _b_0 * _b_0 - 4 * _a_0 * _c_0&#39;,
 &#39;_xa_0 == 0.5 * _d_0&#39;,
 &#39;_xb_0 == 0&#39;,
 &#39;z3.Not(z3.Not(_xa_0 - _xb_0 &gt; 0.1))&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;z3.solve(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_constraints</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[_a_0 = -11/20,
 _b_0 = 0,
 _c_0 = 1,
 _xb_0 = 0,
 _xa_0 = 11/10,
 _d_0 = 11/5,
 c = 1,
 b = 0,
 a = -11/20]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ArcCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="n">roots3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">11</span> <span class="o">/</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">show_cfg</span><span class="p">(</span><span class="n">roots3</span><span class="p">,</span> <span class="n">arcs</span><span class="o">=</span><span class="n">cov</span><span class="o">.</span><span class="n">arcs</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e9a101fff60e67afae0ecd394c0c1834c9ca7e3cf3e899c39f0e66ca5a57e3f5.svg" src="_images/e9a101fff60e67afae0ecd394c0c1834c9ca7e3cf3e899c39f0e66ca5a57e3f5.svg" />
</div>
</div>
<p>Indeed, the path traced is now different. One can continue this procedure to the necessary number of times to explore all nearby paths to the execution.</p>
<p>Can you incorporate this exploration into the concolic fuzzer?</p>
<p><strong>Solution.</strong> <em>None yet available.</em></p>
</section>
</section>
</section>
<section id="compatibility">
<h2>Compatibility<a class="headerlink" href="#compatibility" title="Link to this heading">#</a></h2>
<p>Earlier versions of this chapter used the name <code class="docutils literal notranslate"><span class="pre">AdvancedSymbolicFuzzer</span></code> for <code class="docutils literal notranslate"><span class="pre">SymbolicFuzzer</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">AdvancedSymbolicFuzzer</span> <span class="o">=</span> <span class="n">SymbolicFuzzer</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="ConcolicFuzzer.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Concolic Fuzzing</p>
      </div>
    </a>
    <a class="right-next"
       href="DynamicInvariants.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Mining Function Specifications</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#obtaining-path-conditions-for-coverage">Obtaining Path Conditions for Coverage</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-control-flow-graph">The Control Flow Graph</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-cfg-with-path-taken">The CFG with Path Taken</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-coverage">Visualizing the Coverage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#function-summaries">Function Summaries</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#get-names-and-types-of-variables-used">Get Names and Types of Variables Used</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simple-symbolic-fuzzing">Simple Symbolic Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-all-possible-paths">Generating All Possible Paths</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-all-constraints">Extracting All Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-simple-symbolic-fuzzer">Fuzzing with Simple Symbolic Fuzzer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problems-with-the-simple-fuzzer">Problems with the Simple Fuzzer</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-symbolic-fuzzing">Advanced Symbolic Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-reassignments">Dealing with Reassignments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-assignments">Tracking Assignments</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#stepwise-exploration-of-paths">Stepwise Exploration of Paths</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#renaming-used-variables">Renaming Used Variables</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#check-before-you-loop">Check Before You Loop</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-path-constraints">Solving Path Constraints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-all-paths">Generating All Paths</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-advanced-symbolic-fuzzer">Fuzzing with Advanced Symbolic Fuzzer</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-roots-of-a-quadratic-equation">Example: Roots of a Quadratic Equation</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#roots-check-before-divide">Roots - Check Before Divide</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#roots-eliminating-the-zero-division-error">Roots - Eliminating the Zero Division Error</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#limitations">Limitations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-extending-symbolic-fuzzer-to-use-function-summaries">Exercise 1: Extending Symbolic Fuzzer to use function summaries</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-statically-checking-if-a-loop-should-be-unrolled-further">Exercise 2: Statically checking if a loop should be unrolled further</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-implementing-a-concolic-fuzzer">Exercise 3: Implementing a Concolic Fuzzer</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-the-execution-concolically">Tracing the Execution Concolically</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-nearby-paths">Exploring Nearby Paths</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compatibility">Compatibility</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021-2025 CISPA Helmholtz Center for Information Security (www.cispa.de); © Copyright 2018-2020 Saarland University, authors, and contributors. All Rights Reserved.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>